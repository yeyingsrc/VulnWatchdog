## CVE-2024-0670-Checkmk-权限提升

**漏洞编号:** CVE-2024-0670

**漏洞类型:** 权限提升

**影响应用:** Checkmk

**危害等级:** 高危，本地用户可提升权限

**影响版本:** < 2.2.0p23, < 2.1.0p40, <= 2.0.0p39

**利用条件:** 需要本地用户权限

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-0670 是 Checkmk Windows Agent 插件中的一个权限提升漏洞。漏洞原因是由于对搜索路径的控制不当（CWE-427），允许本地用户提升权限。

**有效性：**

提供的 POC 代码看起来是有效的。它利用 msiexec 修复功能，通过将包含反向 shell 的批处理文件写入到 SYSTEM 权限可以访问的临时目录，并将其标记为只读，从而触发权限提升。`RunasCs.exe` 用于以指定用户身份执行命令。脚本的主要步骤如下：

1.  在注册表中查找 Check MK 相关的 MSI 文件。
2.  在 `C:\Windows\Temp` 目录下生成大量以 `cmk_all_<PID>_<counter>.cmd` 命名的批处理文件，批处理文件的内容为启动 nc.exe 建立反向shell。 这些批处理文件会被设置为只读。
3.  使用 `msiexec.exe` 触发 MSI 修复操作，使用日志文件记录修复过程。
4. `zh.ps1` 脚本使用 `nc64.exe` 作为反向 shell 工具，这表明目标系统是 64 位的 Windows 系统。

**投毒风险：**

存在一定的投毒风险，虽然主要功能是利用漏洞，但需要注意以下几点：

*   **下载可执行文件：** 脚本从远程服务器下载 `nc64.exe` 和 `RunasCs.exe`。这引入了潜在的投毒风险，因为攻击者可以替换这些文件为恶意文件。尽管 `nc64.exe` 常用于网络连接，但下载和执行未经信任的二进制文件始终存在风险。
*   **批处理文件：** 脚本创建大量批处理文件，虽然主要目的是为了利用漏洞，但也增加了文件系统中残留恶意代码的可能性。
*   **参数传递：** `RunasCs.exe` 接收用户名和密码作为参数，虽然示例中是测试凭据，但实际攻击中可能会尝试其他凭据，或者在一定条件下泄露。代码中硬编码密码有安全风险。
*  **风险评估：** 综合考虑，该漏洞利用代码的投毒风险在10%左右。主要风险在于下载的可执行文件可能被替换为恶意文件。

**利用方式：**

1.  **环境准备：** 在攻击者控制的服务器上托管 `zh.ps1`、`nc64.exe` 和 `RunasCs.exe` 文件。
2.  **执行 RunasCs.exe：** 在受害者机器上，使用 `RunasCs.exe` 以某个用户身份执行 PowerShell 脚本 `zh.ps1`。
3.  **查找 MSI 文件：** `zh.ps1` 脚本会查找 Check MK 相关的 MSI 安装文件。
4.  **生成批处理文件：** 脚本生成大量的批处理文件到 `C:\Windows\Temp` 目录，这些文件包含启动 `nc64.exe` 反向 shell 的命令。
5.  **触发 MSI 修复：** 脚本使用 `msiexec.exe` 触发 MSI 修复，这会执行之前生成的批处理文件，从而以 SYSTEM 权限运行反向 shell。
6.  **获得 Shell：** 攻击者在其监听端口上接收反向 shell，从而获得 SYSTEM 权限。

**项目地址:** [zhulin837/checkmk_cve-2024-0670](https://github.com/zhulin837/checkmk_cve-2024-0670)

**漏洞详情:** [CVE-2024-0670](https://nvd.nist.gov/vuln/detail/CVE-2024-0670)