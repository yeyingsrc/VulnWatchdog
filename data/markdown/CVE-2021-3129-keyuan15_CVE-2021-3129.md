## CVE-2021-3129-Laravel Ignition-远程代码执行

**漏洞编号:** CVE-2021-3129

**漏洞类型:** 远程代码执行

**影响应用:** Laravel Ignition

**危害等级:** 高危，可导致服务器被完全控制

**影响版本:** Ignition < 2.5.2, Laravel < 8.4.2 (debug mode enabled)

**利用条件:** Laravel 应用程序开启了 debug 模式，并且使用了存在漏洞的 Ignition 版本。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-3129 是一个存在于 Laravel Ignition 组件中的远程代码执行漏洞。该漏洞源于不安全地使用 `file_get_contents()` 和 `file_put_contents()` 函数。攻击者可以通过发送特制的 HTTP 请求，利用 Ignition 的 debug 页面来执行任意 PHP 代码，从而完全控制服务器。

**漏洞利用方式：**

1.  **触发 Ignition 错误页面：** 攻击者首先需要构造一个能够触发 Laravel Ignition 错误页面的请求。由于此漏洞要求开启debug模式，所以任何未捕获的异常都可以触发该页面。
2.  **利用 `/execute-solution` 接口：** 攻击者利用 `_ignition/execute-solution` 接口，选择 `Facade\Ignition\Solutions\MakeViewVariableOptionalSolution` 这个 solution。该solution允许用户指定任意的变量名和视图文件名。
3.  **利用 phpggc 生成 Payload：** 漏洞利用脚本使用 `phpggc` 工具生成用于执行命令的 PHP 对象链。 `phpggc` 是一个专门用于生成 PHP 反序列化 payload 的工具，支持多种框架和库，例如 Laravel 和 Monolog。
4.  **写入 Payload 到 Laravel Log 文件：** 攻击者利用 `php://filter` 流，使用 `convert.iconv.*` 等过滤器链，将构造的 PHP 对象链写入到 `storage/logs/laravel.log` 文件中。Payload首先经过base64编码，然后使用quoted-printable进行编码，之后解码，最终写入log文件。这个过程是为了绕过一些字符限制。
5.  **触发反序列化：** 当 Laravel 尝试读取并处理 log 文件时，其中的 PHP 对象链会被反序列化，从而执行攻击者指定的命令。由于开启了 debug 模式，所以laravel在处理log文件时可能触发反序列化。

**关于投毒风险：**

该脚本存在一定的投毒风险。主要体现在以下几个方面：

*   **依赖外部工具 phpggc:** 该脚本依赖于 `phpggc` 工具生成 payload。如果 `phpggc` 工具本身被篡改，生成的 payload 可能会包含恶意代码。
*   **Payload的多样性：**脚本尝试多个`phpggc`的链子(payload)，增加了成功利用的机会，但也意味着如果其中一个链子被投毒，那么风险也会被放大。
*   **命令执行:**脚本本身会执行系统命令 (os.popen)，虽然是调用phpggc，但如果phpggc本身被植入恶意代码，那么执行os.popen时就会执行恶意代码

**风险评估：**

该漏洞的 CVSS 评分为 9.8（严重），表明其具有极高的风险。成功利用此漏洞的攻击者可以完全控制服务器，导致数据泄露、恶意软件感染和其他严重后果。由于该漏洞已经被 CISA 列入已知被利用漏洞目录，因此需要及时修复。

**缓解措施：**

*   升级 Laravel 和 Ignition 到最新版本。
*   在生产环境中禁用 debug 模式。
*   限制对 `/execute-solution` 接口的访问。
*   使用 Web 应用防火墙 (WAF) 过滤恶意请求。

**项目地址:** [keyuan15/CVE-2021-3129](https://github.com/keyuan15/CVE-2021-3129)

**漏洞详情:** [CVE-2021-3129](https://nvd.nist.gov/vuln/detail/CVE-2021-3129)