## CVE-2021-3129 - Laravel Ignition Remote Code Execution

**漏洞编号:** CVE-2021-3129

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Laravel Ignition

**危害等级:** 高危，允许未授权远程攻击者执行任意代码。

**影响版本:** Ignition < 2.5.2, Laravel < 8.4.2 (debug mode enabled)

**利用条件:** Laravel 应用程序必须启用 debug 模式并且使用受影响的 Ignition 版本。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2021-3129 是一个存在于 Laravel Ignition (2.5.2 之前版本) 中的远程代码执行漏洞。该漏洞允许未经过身份验证的远程攻击者通过不安全地使用 `file_get_contents()` 和 `file_put_contents()` 函数来执行任意代码。攻击利用了 Laravel debug 模式下的一个缺陷，攻击者可以构造特制的请求，向 `../storage/logs/laravel.log` 写入恶意 PHP 代码，然后通过phar流包装器触发执行。 

**利用方式:**

1.  **前提条件:** 目标 Laravel 应用必须启用 debug 模式，并且使用的 Ignition 版本低于 2.5.2，Laravel 版本低于 8.4.2。
2.  **漏洞触发:** 攻击者发送 POST 请求到应用程序的错误处理端点（通常是 `/`），在请求中包含恶意的 `solution` 和 `parameters` 数据。`solution` 设置为 `Facade\Ignition\Solutions\MakeViewVariableOptionalSolution`， `parameters` 包含 `variableName` 和 `viewFile` 参数。
3.  **日志污染:** 通过 `php://filter` 流包装器，将恶意的 PHP 代码写入 Laravel 的日志文件 ( `../storage/logs/laravel.log` )。
4.  **Phar 反序列化:** 再次通过 `php://filter` 包装器读取日志文件，将其转换为 Phar 档案，触发反序列化漏洞，最终执行写入日志文件中的任意 PHP 代码。
5.  **命令执行:**  `exploit.py` 脚本通过 `phpggc` 生成恶意的 payload，该 payload 利用了常见的 PHP 反序列化 gadget chain 来实现远程代码执行。脚本首先清除日志文件，然后发送包含命令的payload，之后转换日志文件为phar档案，最后读取phar档案的内容，并提取命令执行的结果。

**投毒风险分析:**

代码中存在一定的投毒风险，但概率较低（5%）。主要风险点在于 `exploit.py` 中使用的 `phpggc` (PHP Generic Gadget Chains) 工具。如果攻击者替换了 `phpggc` 工具或其中的 gadget chain 定义，就可能在目标系统上执行预期的命令之外的操作。 此外，该脚本使用了 `base64` 编码和解码以及 `sed` 命令进行字符串处理，这可能会引入细微的漏洞，但可能性不大。

**总结:**

该漏洞利用代码的有效性较高，风险在于目标环境是否满足利用条件（debug模式开启，版本符合要求）。投毒风险主要集中在 `phpggc` 工具的使用上，但也需要注意其他潜在的风险点。

**项目地址:** [JacobEbben/CVE-2021-3129](https://github.com/JacobEbben/CVE-2021-3129)

**漏洞详情:** [CVE-2021-3129](https://nvd.nist.gov/vuln/detail/CVE-2021-3129)