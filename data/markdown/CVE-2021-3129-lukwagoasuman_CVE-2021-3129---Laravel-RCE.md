## CVE-2021-3129 - Laravel Ignition 远程代码执行

**漏洞编号:** CVE-2021-3129

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Laravel (with Ignition)

**危害等级:** 严重，未经身份验证的攻击者可以执行任意代码

**影响版本:** Ignition < 2.5.2, Laravel < 8.4.2 (debug mode enabled)

**利用条件:** Laravel应用程序的debug模式必须启用，并且使用了受影响的Ignition版本。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2021-3129 漏洞允许未经身份验证的远程攻击者在启用了debug模式的Laravel应用上执行任意代码。该漏洞源于 Ignition 组件中对 `file_get_contents()` 和 `file_put_contents()` 函数的不安全使用。攻击者可以通过精心构造的请求来触发 Phar 反序列化漏洞，从而执行任意PHP代码。

**有效性评估：**
提供的漏洞利用代码 `CVE-2021-3129.py` 似乎是一个完整的利用脚本，包含了多种功能，例如检测目标是否易受攻击、执行命令、写入日志以及尝试修补漏洞。它还包含User-Agent池、多种利用链(`CHAINS`)，以及缓存机制，这表明该代码的设计旨在提高利用的成功率和灵活性。

**投毒风险评估：**
分析了提供的 `CVE-2021-3129.py` 脚本。风险较低，可能存在的风险点如下：
1.  **缓存机制：** 脚本具有缓存之前使用的`private_key`和`working_chain`的机制。虽然方便了后续使用，但也存在一定的风险，如果被攻击者控制，可能会被利用。
2.  **远程命令执行：** 脚本的核心功能是执行远程命令。虽然这本身是漏洞利用的一部分，但如果脚本被恶意修改，执行的命令可能包含恶意代码。
3. **脚本中存在尝试修补漏洞的功能，存在一定的风险，可能会破坏应用程序,导致无法修复。**

综上所述，投毒风险评估为5%。

**漏洞利用方式：**
1.  **目标检测：** 脚本首先尝试检测目标是否易受攻击。它通过发送特定的HTTP请求并检查响应来判断是否满足漏洞利用的条件 (debug模式开启，使用了存在漏洞的Ignition版本)。
2.  **利用链选择：** 脚本包含多个利用链 (`CHAINS`)，攻击者可以选择一个利用链来触发漏洞。如果未指定，脚本可能会使用之前缓存的工作链或者提示用户选择。
3.  **Payload 构造：** 脚本会构造恶意的payload，该 payload通常涉及到 Phar 反序列化漏洞，并包含要执行的命令或写入的内容。
4.  **发送恶意请求：** 构造好的payload会通过 HTTP 请求发送到目标服务器。
5.  **代码执行：** 如果利用成功，服务器会执行payload中包含的 PHP 代码，从而允许攻击者执行任意命令、写入文件或执行其他恶意操作。
6.  **漏洞修补（可选）：** 脚本还提供了尝试修补漏洞的功能，虽然出发点是好的，但也可能引入新的问题。

**项目地址:** [lukwagoasuman/CVE-2021-3129---Laravel-RCE](https://github.com/lukwagoasuman/CVE-2021-3129---Laravel-RCE)

**漏洞详情:** [CVE-2021-3129](https://nvd.nist.gov/vuln/detail/CVE-2021-3129)