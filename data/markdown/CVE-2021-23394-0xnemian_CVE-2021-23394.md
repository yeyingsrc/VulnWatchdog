## CVE-2021-23394 - elFinder Remote Code Execution (RCE)

**漏洞编号:** CVE-2021-23394

**漏洞类型:** Remote Code Execution (RCE)

**影响应用:** elFinder

**危害等级:** 高危，允许攻击者在服务器上执行任意代码

**影响版本:** < 2.1.58

**利用条件:** 服务器必须解析 .phar 文件为 PHP

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

漏洞CVE-2021-23394存在于elFinder 2.1.58之前的版本中。攻击者可以上传包含恶意PHP代码的.phar文件，如果服务器将.phar文件解析为PHP，则会导致远程代码执行。漏洞利用代码中的Dockerfile分别构建了存在漏洞的elFinder 2.1.57版本和修复后的elFinder 2.1.66版本，并配置Apache或Nginx服务器处理.phar文件。具体利用方式是，攻击者上传恶意的.phar文件到elFinder文件管理系统中，然后通过访问该.phar文件，触发PHP代码执行。从提供的Dockerfile和nginx.conf配置来看，没有发现明显的投毒代码。攻击者通过上传恶意的phar文件到服务器，并访问该文件，利用php的phar扩展机制，将phar文件当做php代码执行,从而实现远程代码执行。

**有效性:**
提供的Dockerfile和nginx.conf等文件显示了漏洞的配置过程。Dockerfile构建了存在漏洞的elFinder环境，并且配置了服务器将.phar文件作为PHP解析，这满足了漏洞利用的必要条件，因此该POC代码有效。

**投毒风险:**
分析提供的文件内容，Dockerfile 主要负责构建 Docker 镜像，安装必要的依赖，并配置 Apache 或 Nginx 来运行 elFinder。nginx.conf 配置文件定义了 Nginx 如何处理 HTTP 请求，特别是如何将 PHP 和 PHAR 文件传递给 PHP-FPM 进行处理。这些文件本身不包含任何可疑的或恶意的代码。因此，投毒风险较低。

**利用方式:**
1.  构建包含漏洞版本的elFinder的Docker环境（使用提供的Dockerfile）。
2.  配置服务器（Apache或Nginx）以将.phar文件解析为PHP。（通过Dockerfile完成）
3.  创建一个包含恶意PHP代码的.phar文件。
4.  通过elFinder的文件上传功能上传该.phar文件到服务器。
5.  通过浏览器访问上传的.phar文件，触发服务器执行其中的PHP代码，实现远程代码执行。

**项目地址:** [0xnemian/CVE-2021-23394](https://github.com/0xnemian/CVE-2021-23394)

**漏洞详情:** [CVE-2021-23394](https://nvd.nist.gov/vuln/detail/CVE-2021-23394)