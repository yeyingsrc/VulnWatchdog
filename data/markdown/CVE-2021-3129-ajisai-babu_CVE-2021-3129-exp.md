## CVE-2021-3129 - Laravel Ignition Remote Code Execution

**漏洞编号:** CVE-2021-3129

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Laravel (with Ignition)

**危害等级:** 高危，允许未经身份验证的远程攻击者执行任意代码

**影响版本:** Ignition < 2.5.2, Laravel < 8.4.2 (with debug mode enabled)

**利用条件:** Laravel应用必须启用debug模式，并使用存在漏洞的Ignition版本。

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

CVE-2021-3129 漏洞存在于 Laravel Ignition 组件的早期版本中。该漏洞源于对 `file_get_contents()` 和 `file_put_contents()` 函数的不安全使用，允许未经身份验证的远程攻击者执行任意代码。该漏洞利用需要 Laravel 应用运行在 debug 模式下，并且使用的 Laravel 版本低于 8.4.2。

**利用方式：**

1.  **漏洞触发点：** 通过向 `/_ignition/execute-solution` 接口发送精心构造的 POST 请求来触发漏洞。
2.  **payload构造：** PoC 脚本通过构造特定的 JSON payload，利用 `Facade\Ignition\Solutions\MakeViewVariableOptionalSolution` 方案来写入恶意代码到 Laravel 的日志文件中(`storage/logs/laravel.log`)。具体而言，它使用`php://filter`流包装器进行编码和解码操作，最终实现任意代码写入。
3.  **phpinfo利用：** PoC 首先清除日志文件，然后通过 `phpinfo()` 函数获取网站路径、服务器地址、PHP 版本和系统版本等信息。
4.  **phar反序列化:** PoC 会尝试利用 `phar` 协议进行反序列化操作,从而执行任意代码。
5.  **webshell写入：** PoC 尝试写入一个 webshell (shell.php) 到网站根目录。
6.  **webshell访问:** 通过访问写入的 webshell 执行任意命令，密码硬编码为 whoami。

**有效性评估：**

提供的 PoC 代码似乎是有效的。它包含漏洞检测和利用的功能。根据漏洞描述，如果目标系统满足先决条件（debug 模式开启，受影响的版本），则该 PoC 应该能够成功执行远程代码。

**投毒风险评估：**

对提供的 PoC 代码进行了分析，发现其主要功能是利用 CVE-2021-3129 漏洞写入 webshell。代码中未发现明显的恶意行为，例如未经授权的数据收集、对其他系统的攻击等。但是利用成功后写入的webshell存在被恶意利用的风险,因此投毒风险评估为1%。需要注意的是，任何漏洞利用代码都可能被滥用，因此在使用前务必进行充分的风险评估，并仅在授权的环境下使用。

**项目地址:** [ajisai-babu/CVE-2021-3129-exp](https://github.com/ajisai-babu/CVE-2021-3129-exp)

**漏洞详情:** [CVE-2021-3129](https://nvd.nist.gov/vuln/detail/CVE-2021-3129)