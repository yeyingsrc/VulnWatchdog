## CVE-2021-3129 - Laravel Ignition Remote Code Execution

**漏洞编号:** CVE-2021-3129

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Laravel (使用 Ignition)

**危害等级:** 高危，允许未经身份验证的远程攻击者执行任意代码。

**影响版本:** Ignition < 2.5.2, Laravel < 8.4.2 (debug mode)

**利用条件:** Laravel 应用程序必须启用 debug 模式并且使用了存在漏洞的 Ignition 版本。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-3129 漏洞存在于 Laravel 的 Ignition 组件中，由于不安全地使用了 `file_get_contents()` 和 `file_put_contents()` 函数，导致未经身份验证的远程攻击者可以执行任意代码。此漏洞的利用需要目标应用程序开启 debug 模式，并且使用的 Laravel 版本低于 8.4.2。

**漏洞利用方式：**

1.  **信息收集：** 首先，攻击者需要确定目标网站是否使用了易受攻击的 Laravel 和 Ignition 版本，并且 debug 模式已启用。这可以通过检查 HTTP 响应头或错误页面来确定。
2.  **日志路径泄露/探测：** 漏洞利用脚本首先尝试通过故意触发错误来获取 Laravel 日志文件的路径。它发送一个包含 `DOESNOTEXIST` 的请求，期待在错误消息中找到日志文件的完整路径。
3.  **日志清除：**  使用 `php://filter` 包装器清除目标服务器上的 Laravel 日志文件。这能为后续写入payload创造空间。
4.  **Payload 注入：** 利用 `Facade\Ignition\Solutions\MakeViewVariableOptionalSolution` 组件的漏洞，将恶意 PHP 代码（payload）写入到 Laravel 的日志文件中。该脚本使用了一系列的 PHP 过滤器（`convert.quoted-printable-decode`, `convert.iconv.utf-16le.utf-8`, `convert.base64-decode`）对 payload 进行编码和转换，以绕过某些安全限制。
5.  **PHAR 转换：** 使用特殊的 PHP 过滤器将写入日志文件的内容转换为 PHAR 归档格式。PHAR 是 PHP 的归档文件格式，它可以包含 PHP 代码和元数据。
6.  **PHAR 反序列化：**  通过包含一个指向日志文件的 `phar://` URL 的请求，触发 PHAR 文件的反序列化。这会导致恶意 PHP 代码被执行，从而实现远程代码执行。
7.  **代码执行：** 恶意代码在服务器上执行，允许攻击者执行任意系统命令。该脚本通过 `phpggc` 生成 PHAR payload。

**投毒风险评估：**

虽然漏洞利用代码本身看起来旨在利用漏洞执行命令，但存在一定的投毒风险，大约为 10%。以下是可能存在的风险：

*   **依赖项风险：** 该脚本依赖于 `phpggc` 来生成 PHAR payload。如果攻击者篡改了 `phpggc`，可能会导致生成的 payload 包含恶意代码，从而在目标服务器上植入后门。
*   **日志清理绕过：**  如果日志清理环节存在绕过，可能会影响payload的写入和phar转换。
*   **Payload可观测：** 由于攻击依赖于日志文件写入，攻击者行为可能留在日志中，存在被检测的风险，但是可以通过更隐蔽的方式进行绕过。
* **其他第三方库:** 脚本中可能含有其它第三方代码或者链接,如果第三方恶意链接或者代码,可能存在风险.

**项目地址:** [Prabesh01/hoh4](https://github.com/Prabesh01/hoh4)

**漏洞详情:** [CVE-2021-3129](https://nvd.nist.gov/vuln/detail/CVE-2021-3129)