## CVE-2021-3129 - Laravel Ignition 远程代码执行

**漏洞编号:** CVE-2021-3129

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Laravel Ignition

**危害等级:** 高危，允许未经身份验证的远程攻击者执行任意代码

**影响版本:** Ignition < 2.5.2，Laravel < 8.4.2 (debug 模式开启)

**利用条件:** Laravel 应用开启 debug 模式，且使用了存在漏洞的 Ignition 版本

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2021-3129 漏洞存在于 Laravel Ignition 组件中，由于对 file_get_contents() 和 file_put_contents() 的不安全使用，导致远程代码执行。攻击者可以通过构造恶意请求，利用 Ignition 组件的日志功能，将恶意 PHAR 序列化对象写入日志文件，然后通过 Phar 反序列化触发 RCE。

**利用方式：**

1.  **环境准备：** 搭建存在漏洞的 Laravel 应用环境，确保开启 debug 模式，且 Ignition 版本低于 2.5.2，Laravel 版本低于 8.4.2。
2.  **清除日志：** 利用漏洞清除现有的 Laravel 日志文件，避免干扰。
3.  **写入 Payload：** 发送包含恶意 PHAR 序列化对象的请求，利用 `file_put_contents()` 函数将 Payload 写入日志文件。
4.  **触发反序列化：** 构造请求，利用 `phar://` 协议触发日志文件的 PHAR 反序列化，从而执行 Payload 中包含的任意代码。
5.  **代码分析：** exploit.py脚本首先尝试清除日志，然后使用 phpggc 生成 payload，该payload利用php原生类构造POP链，最终执行系统命令。然后将payload写入日志文件。最后，使用 phar 协议触发反序列化，导致命令执行。

**投毒风险分析：**

查看提供的利用代码，该代码主要分为以下几个部分：

*   **send()**: 发送 POST 请求。
*   **generate()**: 调用 phpggc 生成 PHAR 序列化 Payload，没有发现恶意代码。
*   **clear()**: 清除日志。
*   **主函数**: 拼接URL,调用以上方法.

代码逻辑相对清晰，主要依赖于 phpggc 生成 Payload 并利用 Laravel 的日志机制触发漏洞。没有发现直接的投毒代码。但是，需要注意 phpggc 本身可能包含恶意 Gadget 链，所以生成恶意 phar 文件有一定风险。

**结论：**

该漏洞利用代码有效，成功率较高，因为漏洞原理较为直接。该仓库中直接包含投毒代码的风险较低，但需要注意 phpggc 工具本身的安全性。

**项目地址:** [nth347/CVE-2021-3129_exploit](https://github.com/nth347/CVE-2021-3129_exploit)

**漏洞详情:** [CVE-2021-3129](https://nvd.nist.gov/vuln/detail/CVE-2021-3129)