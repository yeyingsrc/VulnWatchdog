## CVE-2023-42793-JetBrains TeamCity-RCE

**漏洞编号:** CVE-2023-42793

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** JetBrains TeamCity

**危害等级:** 高危，未经身份验证的远程代码执行

**影响版本:** < 2023.05.4

**利用条件:** TeamCity Server 需要对外开放网络访问

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2023-42793 是 JetBrains TeamCity 在 2023.05.4 之前的版本中存在的一个身份验证绕过漏洞，可导致未经身份验证的远程代码执行。根据漏洞库信息，攻击复杂度低，无需用户交互，影响范围广泛，危害等级为严重。

**利用方式：**

1.  **身份验证绕过：** 漏洞允许攻击者绕过身份验证机制，直接访问 TeamCity Server 的管理功能。
2.  **创建用户 Token：** 攻击者利用未授权访问权限，为用户 'id:1' 创建一个新的访问令牌 (Token)。
3.  **启用调试模式：** 利用获取的 Token，通过修改 `internal.properties` 文件，启用 REST API 的调试模式 (`rest.debug.processes.enable=true`)。
4.  **远程代码执行：** 启用调试模式后，攻击者可以通过 REST API 调用 `debug/processes` 接口执行任意命令。`exePath` 参数可以接收外部输入。

**POC 代码分析：**

提供的 Python 脚本 `exploit-rce.py` 实现了上述利用流程：

*   `delete_user(url)`: 尝试删除用户 'id:1' 的所有 token。由于此token并不是所有环境下都存在，删除失败并不影响漏洞利用。这一步是为了在利用前清理可能的旧 Token。
*   `extractToken(url)`: 发送 POST 请求到 `/app/rest/users/id:1/tokens/RPC2` 以获取一个新的 Token。
*   `process_rce(url, token)`: 使用获取的 Token，发送 POST 请求到 `/admin/dataDir.html` 以启用调试模式。
*   `rceExploit(url, token)`: 接收用户输入的命令，并将其 URL 编码后，发送 POST 请求到 `/app/rest/debug/processes` 执行命令。输出结果会被打印。

**投毒风险分析：**

该脚本的主要功能是利用已知的 TeamCity RCE 漏洞。但代码中存在以下潜在的投毒风险：

*   **硬编码用户 ID:**  脚本假定用户 ID 始终为 '1'。在某些 TeamCity 实例中，默认用户可能具有不同的 ID。如果目标环境的用户ID不是1,可能造成提权失败，但是并不会影响系统的安全性。
*   **依赖 REST API 调试模式：** 漏洞利用依赖于启用 `rest.debug.processes.enable` 设置。攻击者可以通过代码中的其他方式修改系统配置，植入后门或添加恶意用户。

考虑到上述因素，投毒风险较低，约为 5%。 主要风险点在于对特定环境的依赖性，以及利用该漏洞进行其他恶意操作的可能性。


**项目地址:** [cxdxnt/CVE-2023-42793](https://github.com/cxdxnt/CVE-2023-42793)

**漏洞详情:** [CVE-2023-42793](https://nvd.nist.gov/vuln/detail/CVE-2023-42793)