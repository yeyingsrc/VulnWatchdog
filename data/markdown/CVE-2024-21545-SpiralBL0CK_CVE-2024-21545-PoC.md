## CVE-2024-21545-Proxmox VE 任意文件读取

**漏洞编号:** CVE-2024-21545

**漏洞类型:** 任意文件读取

**影响应用:** Proxmox VE

**危害等级:** 高危，可能导致敏感信息泄露和系统完全控制

**影响版本:** pve-manager < 7.4-19, pve-manager 8.0.0 < 8.2.7, libpve-storage-perl < 7.4-4, libpve-storage-perl 8.0.0 < 8.2.5, libpve-http-server-perl 3.2-1 < 4.3.0, libpve-http-server-perl 5.0.0 < 5.1.1, pmg-api < 7.3-12, pmg-api 8.0.0 < 8.1.4, libpve-common-perl (Promox VE 8) < 8.2.3, libpve-common-perl (Promox Mail Gateway 8) < 8.2.5

**利用条件:** 需要具有 'Sys.Audit' 或 'VM.Monitor' 权限的已认证攻击者

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-21545 是 Proxmox VE 中的一个任意文件读取漏洞。攻击者可以通过构造恶意的 API 响应值，利用handle_api2_request函数对'download'或'data'->'download'对象的处理不当，读取服务器上的任意文件。

**漏洞利用方式：**

该漏洞有两种利用方式：

*   **向量 1：恶意 QEMU Guest Agent (需要 VM.Monitor 权限)**
    *   攻击者需要首先获得一个虚拟机的 root 权限，并在其中运行一个修改过的 QEMU Guest Agent。 
    *   该 Agent 会返回包含恶意 'download' 对象的 JSON 响应，其中 'path' 字段指向攻击者想要读取的文件。
    *   通过向 Proxmox API 发送包含 `NOTFOUND<filepath>` 的命令到 `/nodes/{self.node}/qemu/{vmid}/agent/exec` 触发漏洞。
*   **向量 2：ACME Meta Endpoint (需要 Sys.Audit 权限)**
    *   攻击者需要搭建一个外部服务器，该服务器返回包含恶意 'download' 对象的 JSON 响应。
    *   通过向 `/cluster/acme/meta` 发送请求，并将 `directory` 参数设置为指向恶意服务器的 URL，来触发漏洞。

**有效性：**

提供的 PoC 代码似乎有效，因为它实现了上述两种利用方式。 代码通过构造恶意 API 请求来读取任意文件。但是代码标明 `Not Testeted yet... will test them this week` 代码的有效性无法保证。

**投毒风险：**

PoC 代码中存在投毒风险的可能性较低，约为10%。风险主要来自于以下几点：

*   **依赖外部服务：** ACME Meta Endpoint 利用方式依赖于外部服务器来返回恶意 JSON 响应。如果攻击者控制了外部服务器，他们可能会篡改响应，导致 PoC 代码执行恶意操作。
*   **代码逻辑复杂：** 复杂的代码逻辑可能隐藏着难以发现的后门。

总的来说，PoC 代码的风险较低，但仍然需要仔细审查，并在隔离环境中进行测试，以确保其安全性。

**项目地址:** [SpiralBL0CK/CVE-2024-21545-PoC](https://github.com/SpiralBL0CK/CVE-2024-21545-PoC)

**漏洞详情:** [CVE-2024-21545](https://nvd.nist.gov/vuln/detail/CVE-2024-21545)