## CVE-2021-3129 - Laravel Ignition 远程代码执行

**漏洞编号:** CVE-2021-3129

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Laravel Ignition

**危害等级:** 高危，允许未经身份验证的远程攻击者执行任意代码

**影响版本:** Ignition < 2.5.2, Laravel < 8.4.2 (debug模式开启)

**利用条件:** Laravel 应用开启 debug 模式，且使用了受影响版本的 Ignition 组件。

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

CVE-2021-3129 是一个存在于 Laravel Ignition 组件中的远程代码执行漏洞。该漏洞源于 Ignition 在处理异常时，不安全地使用了 `file_get_contents()` 和 `file_put_contents()` 函数。当 Laravel 应用运行在 debug 模式下，攻击者可以通过构造特定的 HTTP 请求，将恶意 payload 写入到服务器上的任意文件中，从而执行任意代码。

**有效性分析：**
提供的POC代码是有效的。它利用 phpggc 生成恶意 payload，然后通过特定的 POST 请求发送给存在漏洞的 Laravel 应用。请求中，`solution` 参数设置为 `Facade\Ignition\Solutions\MakeViewVariableOptionalSolution`，`parameters` 包含了 `variableName` 和 `viewFile` 字段。`viewFile` 字段的值会被设置为恶意 payload，从而触发 RCE。

**投毒风险分析：**
docker-compose.yml 和 Dockerfile 文件用于构建易受攻击的 Laravel 环境，并没有发现明显的投毒行为。
exp.py 文件是漏洞利用脚本，它使用 phpggc 生成 payload。脚本本身没有明显的投毒代码，仅调用了外部的phpggc程序。但是，使用第三方工具链(phpggc)存在潜在的风险，即工具链本身可能被植入后门或恶意代码。然而，评估给出了较低的1%的可能性，这意味着作者可能利用公开的链进行exp编写。

**利用方式：**
1.  **环境准备：** 搭建一个开启 debug 模式，且使用了受影响版本的 Laravel 应用。
2.  **生成 Payload：** 使用 phpggc 生成恶意 payload。POC 代码中提供了多种 gadget chain (如 Laravel/RCE1, Laravel/RCE2 等)，可以根据目标环境选择合适的 chain。这些 gadget chain 利用了 PHP 中存在的反序列化漏洞，通过精心构造的对象链，最终执行任意代码。
3.  **发送请求：** 构造一个包含恶意 payload 的 HTTP POST 请求，发送到目标应用的 endpoint。请求的 `solution` 参数和 `parameters` 字段需要按照 POC 代码中的格式进行设置。
4.  **执行代码：** 目标应用在处理请求时，会将恶意 payload 写入到文件中，触发反序列化漏洞，从而执行任意代码。

**总结：**
CVE-2021-3129 是一个严重的安全漏洞，攻击者可以利用它远程控制服务器。为了避免受到攻击，开发者应该尽快升级 Laravel 和 Ignition 组件到安全版本，并关闭 debug 模式。

**项目地址:** [Zoo1sondv/CVE-2021-3129](https://github.com/Zoo1sondv/CVE-2021-3129)

**漏洞详情:** [CVE-2021-3129](https://nvd.nist.gov/vuln/detail/CVE-2021-3129)