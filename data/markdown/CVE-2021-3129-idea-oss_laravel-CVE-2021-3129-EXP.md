## CVE-2021-3129 Laravel Ignition RCE

**漏洞编号:** CVE-2021-3129

**漏洞类型:** 远程代码执行

**影响应用:** Laravel Ignition (在Laravel debug模式下使用)

**危害等级:** 高危，未经身份验证的远程代码执行

**影响版本:** Ignition < 2.5.2, Laravel < 8.4.2 (debug mode enabled)

**利用条件:** Laravel应用程序启用了debug模式，且使用了受影响版本的Ignition。

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2021-3129允许未经身份验证的远程攻击者执行任意代码。漏洞原因是Ignition组件在处理错误时，不安全地使用了`file_get_contents()`和`file_put_contents()`函数。攻击者可以利用这一点，通过精心构造的请求，将恶意代码写入到日志文件中，然后通过包含日志文件来执行该代码。

**利用方式：**

1.  **条件：** Laravel应用程序必须在debug模式下运行，且使用了易受攻击的Ignition版本。
2.  **攻击步骤：**
    *   利用 `Facade\Ignition\Solutions\MakeViewVariableOptionalSolution` 类。
    *   通过 `viewFile` 参数，修改 `../storage/logs/laravel.log` 文件。
    *   首先，使用 `convert.iconv.utf-8.utf-16be|convert.quoted-printable-encode|convert.iconv.utf-16be.utf-8|convert.base64-decode` 过滤器将payload进行编码。
    *   然后将base64编码后的包含恶意代码的payload写入laravel.log文件。
    *   最后，通过再次访问触发错误，从而包含恶意代码，实现RCE。

**POC有效性：**

提供的POC代码（`laravel-CVE-2021-3129-EXP.py`）通过构造特定的JSON请求，利用了 `Facade\Ignition\Solutions\MakeViewVariableOptionalSolution` 类中的漏洞。脚本首先清除日志，然后发送payload，该payload会经过编码写入日志文件，最后执行。

**投毒风险：**

分析提供的POC代码，没有发现明显的投毒行为。 代码主要用于利用已知的漏洞来执行命令，虽然利用本身具有风险，但是代码本身没有被设计成会植入恶意代码到目标系统或者传播到其他系统。 脚本中的base64编码看起来是哥斯拉shell， 用于攻击成功后方便用户进行管理.

**漏洞信息：**
漏洞库信息明确指出，此漏洞允许未经身份验证的远程攻击者执行任意代码，并且在CISA的已知被利用漏洞目录中。搜索引擎结果（如果存在）通常会提供更多关于漏洞利用的细节或最新的利用方法。

**总结：**

该漏洞是高危漏洞，利用起来较为简单，POC代码易于使用。攻击者只需满足条件(开启Debug模式)，就可以在目标系统上执行任意代码，从而完全控制系统。虽然该POC存在一定的攻击性，但没有发现明显的投毒代码。

**项目地址:** [idea-oss/laravel-CVE-2021-3129-EXP](https://github.com/idea-oss/laravel-CVE-2021-3129-EXP)

**漏洞详情:** [CVE-2021-3129](https://nvd.nist.gov/vuln/detail/CVE-2021-3129)