## CVE-2021-3129 - Laravel Ignition RCE

**漏洞编号:** CVE-2021-3129

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Laravel Ignition (before 2.5.2), Laravel (before 8.4.2)

**危害等级:** 高危，可导致服务器完全控制

**影响版本:** Ignition < 2.5.2, Laravel < 8.4.2 (with debug mode enabled)

**利用条件:** Laravel应用开启debug模式，且使用了受影响版本的Ignition组件。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2021-3129 漏洞存在于 Laravel Ignition 组件中，由于不安全地使用 `file_get_contents()` 和 `file_put_contents()` 函数，导致未经身份验证的远程攻击者可以执行任意代码。漏洞利用需要 Laravel 应用处于 debug 模式，并且使用的 Laravel 版本低于 8.4.2。  攻击者首先通过 `Facade\Ignition\Solutions\MakeViewVariableOptionalSolution` 方案写入 payload 到 `laravel.log` 日志文件中，payload 使用 phpggc 生成 phar 文件，包含要执行的恶意代码。然后，通过 `phar://` 协议触发 phar 反序列化漏洞，从而执行恶意代码。 

**有效性：** 提供的POC代码有效。它利用了 `file_get_contents()` 和 `file_put_contents()` 的不安全使用，通过构造恶意的phar文件写入日志，并触发phar反序列化来实现RCE。

**投毒风险：**  POC代码包含使用 phpggc 生成 payload 的步骤，phpggc是一个著名的生成payload工具。直接分析给定的代码片段，投毒风险较低。Payload生成依赖外部工具phpggc，使用者需要自行安装，安装phpggc时可能存在风险。此处的“投毒风险”主要指代码本身是否包含恶意逻辑，而非使用者使用外部工具链的风险。由于代码逻辑主要是利用已知漏洞，并无发现明显恶意代码（例如未经授权的信息收集、持久化后门等），因此，投毒风险评定为5%。

**利用方式：**
1.  **漏洞检测:** 通过访问 `_ignition/execute-solution` 路径检查漏洞是否存在。如果返回405错误并且页面内容包含laravel关键字，则说明可能存在漏洞。
2.  **日志清理:** 使用`Facade\Ignition\Solutions\MakeViewVariableOptionalSolution`清理laravel.log。
3.  **Payload构造:** 使用phpggc工具，根据不同的利用链构造phar文件，该文件中包含要执行的系统命令。
4.  **Payload写入:** 利用`Facade\Ignition\Solutions\MakeViewVariableOptionalSolution`方案，将构造的phar文件内容写入到`laravel.log`日志文件中。通过base64编码、`convert.quoted-printable-encode`等过滤器绕过限制。
5.  **触发漏洞:** 再次利用`Facade\Ignition\Solutions\MakeViewVariableOptionalSolution`，触发`phar://../storage/logs/laravel.log/test.txt` 的反序列化，从而执行phar文件中包含的恶意代码。



**项目地址:** [Axianke/CVE-2021-3129](https://github.com/Axianke/CVE-2021-3129)

**漏洞详情:** [CVE-2021-3129](https://nvd.nist.gov/vuln/detail/CVE-2021-3129)