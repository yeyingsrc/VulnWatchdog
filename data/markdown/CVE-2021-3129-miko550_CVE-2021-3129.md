## CVE-2021-3129 - Laravel Ignition RCE

**漏洞编号:** CVE-2021-3129

**漏洞类型:** 远程代码执行

**影响应用:** Laravel Ignition (before 2.5.2), Laravel (before 8.4.2)

**危害等级:** 高危，未经身份验证的远程攻击者可以执行任意代码

**影响版本:** Ignition < 2.5.2, Laravel < 8.4.2 (with debug mode enabled)

**利用条件:** 目标应用程序必须运行在调试模式下，并且使用了存在漏洞的Ignition版本。

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2021-3129 漏洞存在于 Laravel Ignition 中，由于不安全地使用 `file_get_contents()` 和 `file_put_contents()` 函数，允许未经身份验证的远程攻击者执行任意代码。该漏洞可利用于启用了调试模式的 Laravel 8.4.2 之前的版本。

**漏洞利用方式：**

1.  **漏洞验证：** 检查目标应用程序是否返回405状态码或包含"laravel"字样，以此确认是否使用了 Laravel 并可能存在漏洞。
2.  **生成 Payload：** 使用 `phpggc` 工具生成恶意的 PHP 对象序列化数据。该 PoC 脚本集成了 `phpggc` 的调用，利用 Monolog 链来执行系统命令。需要注意的是，`phpggc` 需要预先安装或者脚本会自动从 Github 克隆。
3.  **清除日志：** 清空 Laravel 的日志文件 `storage/logs/laravel.log`，为后续的 Payload 写入做准备。
4.  **发送 Payload：** 将生成的恶意 Payload 通过 `_ignition/execute-solution` 端点发送给目标应用程序。Payload 包含利用 Monolog 链构造的恶意序列化对象，通过 `file_get_contents()` 和 `file_put_contents()` 写入日志文件。
5.  **解码日志：** 对写入的日志文件进行解码，以便后续反序列化操作。
6.  **反序列化：** 通过 `phar://` 协议触发反序列化漏洞，执行 Payload 中包含的命令。
7.  **命令执行与回显：** 命令执行的结果会写入到响应中，通过设置特殊的分隔符来提取命令执行的结果。

**投毒风险评估：**

根据提供的 PoC 代码，未发现明显的投毒代码。该脚本主要功能是利用已知的漏洞执行命令。虽然脚本会自动下载 `phpggc`，但该工具本身是一个公开的 PHP 反序列化 Payload 生成器，风险较低。经过分析，投毒风险评估为 0%。

**项目地址:** [miko550/CVE-2021-3129](https://github.com/miko550/CVE-2021-3129)

**漏洞详情:** [CVE-2021-3129](https://nvd.nist.gov/vuln/detail/CVE-2021-3129)