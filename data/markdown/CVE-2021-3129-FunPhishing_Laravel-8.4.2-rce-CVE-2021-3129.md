## CVE-2021-3129 Laravel Ignition RCE

**漏洞编号:** CVE-2021-3129

**漏洞类型:** 远程代码执行

**影响应用:** Laravel Ignition

**危害等级:** 高危，可以完全控制服务器

**影响版本:** Ignition < 2.5.2, Laravel < 8.4.2 (debug mode enabled)

**利用条件:** 目标Laravel应用开启debug模式，并且使用了受影响的Ignition版本。需要能够通过HTTP POST请求访问应用。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

该漏洞存在于Laravel Ignition组件中，由于不安全地使用`file_get_contents()`和`file_put_contents()`函数，未经身份验证的远程攻击者可以执行任意代码。利用该漏洞需要满足两个条件：一是Laravel应用开启了debug模式，二是使用了受影响的Ignition版本。漏洞利用方式如下：

1.  攻击者首先需要找到目标Laravel应用的URL。
2.  POC代码使用phpggc生成恶意payload，该payload利用Monolog链执行系统命令。
3.  POC代码通过构造包含恶意payload的POST请求，发送到目标应用的URL。
4.  Ignition组件在处理错误时，会反序列化日志文件，从而触发payload中的恶意代码，导致远程代码执行。
5.  POC代码通过预先注入特定标识符，然后从响应中提取标识符之间的内容，来获取命令执行的结果。

**有效性分析：**

根据漏洞信息和POC代码，该漏洞利用的有效性较高。POC代码中包含了完整的利用流程，包括生成payload、发送请求和获取结果。POC代码中使用了docker-compose文件，可以快速搭建一个包含漏洞的环境，方便进行测试和验证。

**投毒风险分析：**

尽管POC提供了一个可用的利用方式，但仍然存在一定的投毒风险。以下是一些潜在的风险点：

*   **外部依赖：** POC依赖于phpggc这个外部工具来生成payload。攻击者可能会修改phpggc的代码，使其生成的payload包含恶意代码，从而感染用户的系统。风险概率: 5%
*   **命令执行：** POC允许攻击者执行任意系统命令。攻击者可能会利用该漏洞安装后门、窃取数据或进行其他恶意活动。风险概率: 5%
*   **代码混淆:** 源代码部分存在代码混淆，降低可读性，增加审计难度。虽然这本身不一定是恶意行为，但会增加理解代码真实意图的难度，从而可能隐藏潜在的恶意代码。风险概率: 0%

因此，综合考虑，我给出的投毒风险评估是10%。建议在使用POC代码时，务必仔细审查代码，确保其安全性。

**利用方式总结：**

1.  利用条件：Laravel debug模式开启，并且Ignition版本低于2.5.2（Laravel版本低于8.4.2）。
2.  攻击向量：发送包含恶意序列化数据的POST请求到Laravel应用。
3.  漏洞原理：Ignition在debug模式下会尝试反序列化日志文件，如果日志文件包含恶意序列化数据，则会导致远程代码执行。
4.  攻击步骤：
    *   生成包含恶意代码的序列化payload。
    *   构造POST请求，将payload发送到目标URL。
    *   触发Ignition的反序列化过程，导致代码执行。
5.  防御措施：
    *   关闭生产环境的debug模式。
    *   升级Ignition到最新版本。
    *   使用Web应用防火墙（WAF）来过滤恶意请求。

**项目地址:** [FunPhishing/Laravel-8.4.2-rce-CVE-2021-3129](https://github.com/FunPhishing/Laravel-8.4.2-rce-CVE-2021-3129)

**漏洞详情:** [CVE-2021-3129](https://nvd.nist.gov/vuln/detail/CVE-2021-3129)