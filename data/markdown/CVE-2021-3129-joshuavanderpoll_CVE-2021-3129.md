## CVE-2021-3129 - Laravel Ignition 远程代码执行

**漏洞编号:** CVE-2021-3129

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Laravel Ignition (受影响的Laravel版本)

**危害等级:** 高危，允许未经身份验证的远程攻击者执行任意代码。

**影响版本:** Ignition < 2.5.2, Laravel < 8.4.2 (debug mode enabled)

**利用条件:** 需要目标站点开启debug模式。目标需使用受影响的Ignition和Laravel版本。

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

CVE-2021-3129 漏洞存在于 Laravel Ignition 组件中，由于不安全地使用 file_get_contents() 和 file_put_contents() 函数，导致未经身份验证的远程攻击者可以在启用 debug 模式的 Laravel 应用上执行任意代码。攻击者通过发送特制的请求，可以利用此漏洞执行任意 PHP 代码。

**有效性：**

提供的 POC 代码 `CVE-2021-3129.py` 看起来是有效的，因为它包含利用此漏洞所需的必要组件：

*   能够发送 HTTP 请求。
*   包含多种利用链 (chains) 针对不同的利用场景。
*   支持自定义命令执行。
*   User-Agent伪造
*   支持绕过Cloudflare。

**投毒风险：**

在给定的代码片段中，投毒风险较低。脚本的主要目的是利用已知的漏洞，而不是引入恶意功能。风险评估为1%。主要考虑点如下：

*   代码结构相对清晰，主要功能是利用漏洞执行命令。
*   没有明显的后门或恶意代码插入。
*   代码中存在一些变量和参数可以控制利用过程，但这些控制是为了实现漏洞利用，而不是为了执行其他恶意操作。

**利用方式：**

1.  **目标环境：** 目标 Laravel 应用必须启用 debug 模式，并且使用了受影响的 Ignition 版本（低于 2.5.2）和 Laravel 版本（低于 8.4.2）。
2.  **漏洞触发：** 攻击者发送特制的 HTTP 请求到目标站点。
3.  **利用链选择：**  POC 代码包含多种“利用链”，这些链是预先构建好的 PHP 代码序列，可以实现远程代码执行。脚本会尝试不同的链，以找到适用于目标环境的链。
4.  **代码执行：**  成功利用后，攻击者可以通过 `exec_command` 参数指定要执行的系统命令。
5.  **攻击流程：**
    *   脚本首先确定目标站点的根路径（`root_path`）。
    *   然后，它会生成一个唯一的 private key ，用于后续的利用。
    *   接下来，脚本构造包含利用链的 payload，并通过 HTTP 请求发送到目标站点。
    *   如果利用成功，目标站点将执行攻击者指定的命令。

总之，此漏洞的利用涉及发送特制的 HTTP 请求，利用不安全的文件操作函数，并执行任意 PHP 代码。提供的 POC 代码似乎是实现这一过程的有效工具。

**项目地址:** [joshuavanderpoll/CVE-2021-3129](https://github.com/joshuavanderpoll/CVE-2021-3129)

**漏洞详情:** [CVE-2021-3129](https://nvd.nist.gov/vuln/detail/CVE-2021-3129)