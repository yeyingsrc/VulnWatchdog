## CVE-2021-3129 Laravel Ignition RCE

**漏洞编号:** CVE-2021-3129

**漏洞类型:** 远程代码执行

**影响应用:** Laravel Ignition

**危害等级:** 高危，允许未授权的远程代码执行

**影响版本:** Ignition < 2.5.2, Laravel < 8.4.2 (debug mode enabled)

**利用条件:** 开启debug模式的Laravel应用,且使用了受影响的Ignition版本

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-3129 漏洞存在于 Laravel 的 Ignition 组件中，由于对 `file_get_contents()` 和 `file_put_contents()` 的不安全使用，导致未授权的远程攻击者可以执行任意代码。漏洞利用需要目标站点开启 debug 模式并且 Laravel 版本低于 8.4.2。

**有效性：** 提供的 POC 代码有效，包含生成恶意 phar 包的步骤以及利用脚本。该脚本通过构造特定的 JSON payload，利用 `php://filter` 包装器写入恶意数据到日志文件，最终触发 phar 反序列化漏洞，实现远程代码执行。

**投毒风险：** 脚本主要功能是漏洞利用，虽然存在一定风险（比如下载来路不明的第三方库），但就代码本身来看，投毒可能性较低。风险在于使用 `phpggc` 生成 phar 包可能引入的间接风险,或者使用者在不知情的情况下使用了恶意的 `phpggc` 链。因此，投毒风险评估为10%。

**利用方式：**

1.  **检测目标是否开启 debug 模式：** 脚本首先尝试访问 `_ignition/execute-solution` 或 `flare/health-check` 路径，通过 HTTP 状态码判断 debug 模式是否开启。
2.  **获取项目路径：** 通过访问 debug 路径，从响应中提取项目根路径。
3.  **清理日志缓存：** 利用 `convert.quoted-printable-encode` 等过滤器，将日志文件内容清空，为写入恶意 payload 做准备。
4.  **发送恶意 Payload：** 构造包含 `php://filter` 包装器的 JSON payload，利用 `convert.quoted-printable-decode|convert.iconv.utf16le.utf-8|convert.base64-decode` 过滤器将 base64 编码的恶意 phar 包写入到日志文件。
5.  **触发反序列化：** 再次构造特殊的JSON数据，通过 `file_get_contents` 触发phar反序列化，从而执行 phar 包中包含的恶意代码，实现远程代码执行。

总的来说，该漏洞利用过程复杂，需要目标开启 debug 模式，并且依赖特定的 payload 构造技巧。攻击者需要首先清理缓存日志文件，然后发送包含恶意 phar 包的 payload，最后触发反序列化。


**项目地址:** [0nion1/CVE-2021-3129](https://github.com/0nion1/CVE-2021-3129)

**漏洞详情:** [CVE-2021-3129](https://nvd.nist.gov/vuln/detail/CVE-2021-3129)