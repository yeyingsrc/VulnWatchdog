## CVE-2021-3129 Laravel Ignition 远程代码执行

**漏洞编号:** CVE-2021-3129

**漏洞类型:** 远程代码执行

**影响应用:** Laravel Ignition

**危害等级:** 高危，可能导致服务器被完全控制

**影响版本:** Ignition < 2.5.2, Laravel < 8.4.2 (debug mode enabled)

**利用条件:** 目标网站使用Laravel框架，开启debug模式，并且使用了受影响的Ignition版本。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-3129 漏洞存在于 Laravel Ignition 组件中，由于不安全地使用 `file_get_contents()` 和 `file_put_contents()` 函数，导致未经身份验证的远程攻击者可以执行任意代码。漏洞利用需要满足以下条件：Laravel 框架运行在 debug 模式下，并且使用的 Ignition 版本低于 2.5.2，Laravel 版本低于 8.4.2。 

**漏洞利用方式：**

1.  **利用 phpggc 生成 payload：** 漏洞利用代码中的 `Exp.py` 脚本首先使用 `phpggc` 工具生成恶意的 PHP 对象序列化 payload。`phpggc` 是一个流行的 PHP 漏洞利用工具，它可以生成各种针对不同 PHP 框架和库的 payload，从而实现远程代码执行。
2.  **构造请求：**  脚本构造一个 POST 请求，将生成的 payload 嵌入到 `solution` 参数的 `parameters[viewFile]` 字段中。
3.  **发送请求：**  将构造好的 POST 请求发送到目标网站的错误处理端点，例如 `/`。利用该漏洞需要找到可以触发错误的地方，以便可以访问到Ignition的错误处理页面。
4.  **触发反序列化：**  Ignition 组件在处理错误时，会反序列化 `parameters[viewFile]` 字段中的数据，从而触发恶意代码的执行。
5.  **执行命令：**  payload 中的恶意代码最终会导致 `system()` 函数被调用，执行攻击者指定的命令。
6.  **获取结果：** 脚本会在命令前后添加定界符，用于在响应中定位命令执行的结果。

**投毒风险分析：**

*   **Dockerfile：**  Dockerfile 用于构建 `phpggc` 工具的运行环境，并无明显的投毒代码。
*   **Exp.py：**  `Exp.py` 脚本的主要功能是生成和发送 payload，以及处理命令执行结果。脚本中存在通过替换某些字符来转义用户输入的命令，以防止payload结构受到影响的代码，这部分代码如果存在缺陷，可能存在风险。脚本依赖 `phpggc` 工具，如果 `phpggc` 工具本身存在后门，则会引入投毒风险，根据以往的经验，这种可能性较小，因此评估为10%的投毒风险。

**项目地址:** [shadowabi/Laravel-CVE-2021-3129](https://github.com/shadowabi/Laravel-CVE-2021-3129)

**漏洞详情:** [CVE-2021-3129](https://nvd.nist.gov/vuln/detail/CVE-2021-3129)