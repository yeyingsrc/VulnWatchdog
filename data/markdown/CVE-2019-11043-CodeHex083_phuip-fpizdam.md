## CVE-2019-11043 PHP-FPM 远程代码执行

**漏洞编号:** CVE-2019-11043

**漏洞类型:** 远程代码执行

**影响应用:** PHP-FPM

**危害等级:** 高危，允许未经身份验证的攻击者执行任意代码

**影响版本:** PHP 7.1.x < 7.1.33, PHP 7.2.x < 7.2.24, PHP 7.3.x < 7.3.11

**利用条件:** Nginx + PHP-FPM配置满足特定条件（参见PHuiP-FPizdaM的README.md），包括错误的fastcgi_split_path_info配置，缺少文件存在性检查等。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2019-11043 是一个存在于 PHP-FPM 中的缓冲区溢出漏洞。当 Nginx 和 PHP-FPM 配合使用时，如果 Nginx 配置不当（特别是 `fastcgi_split_path_info` 指令），攻击者可以通过构造畸形的请求，导致 PHP-FPM 在处理请求时发生缓冲区溢出，覆盖 FCGI 协议数据，从而执行任意代码。

**漏洞利用方式：**

1.  攻击者发送一个特制的 HTTP 请求，该请求包含精心构造的 URI，利用换行符绕过 `fastcgi_split_path_info` 的正则匹配。
2.  请求被传递给 PHP-FPM。
3.  PHP-FPM 在处理 `PATH_INFO` 时，由于长度计算错误，导致缓冲区溢出。
4.  攻击者通过溢出覆盖 FCGI 协议数据，修改请求的执行参数,例如可以通过`?a=/bin/sh+-c+'which+which'&`在所有PHP脚本中执行命令，或者通过设置 `php.ini` 配置项来执行代码。
5.  最终导致远程代码执行。

**投毒风险分析：**

提供的漏洞利用代码（PHuiP-FPizdaM）主要用于检测和利用 CVE-2019-11043 漏洞。代码本身的功能是根据服务器的响应来判断是否存在漏洞，然后通过发送特定的请求来利用该漏洞，并最终执行命令。

对代码进行了简单分析，主要风险在于：

*   **依赖第三方库的风险：** `go get`命令引入的依赖可能存在恶意代码。但是常见的go lang投毒，一般针对的是流行的工具包。
*   **命令执行的风险：**  攻击成功后，可以执行任意命令。如果利用代码中存在隐蔽的命令注入点，可能被用于植入后门。但目前的检测和利用代码来看，更像是直接执行用户提供的命令。
*   **清理残留文件的风险：** 代码尝试清理/tmp/a，但如果清理失败，可能会留下痕迹。

总体来说，直接投毒的概率较低，但考虑到其能够执行任意命令的特性，以及依赖引入，仍然存在一定的安全风险，风险预估在5%左右。

**项目地址:** [CodeHex083/phuip-fpizdam](https://github.com/CodeHex083/phuip-fpizdam)

**漏洞详情:** [CVE-2019-11043](https://nvd.nist.gov/vuln/detail/CVE-2019-11043)