## CVE-2021-3129 Laravel Ignition 远程代码执行

**漏洞编号:** CVE-2021-3129

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Laravel (with Ignition)

**危害等级:** 高危，允许未授权的远程代码执行

**影响版本:** Ignition < 2.5.2, Laravel < 8.4.2 (debug mode enabled)

**利用条件:** Laravel应用开启debug模式，且使用了存在漏洞的Ignition版本。

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2021-3129 漏洞存在于 Laravel Ignition 组件中，由于不安全地使用 `file_get_contents()` 和 `file_put_contents()` 函数，未经身份验证的远程攻击者可以执行任意代码。漏洞利用需要满足以下条件：

1.  **Laravel 应用开启了 debug 模式 (`APP_DEBUG=true`)。**
2.  **使用了存在漏洞的 Ignition 版本 (低于 2.5.2)。**
3.  **Laravel版本低于8.4.2**

**漏洞利用方式：**

1.  **利用日志文件写入:** 通过精心构造的请求，将恶意 PHP 代码写入到 Laravel 的日志文件 (`storage/logs/laravel.log`)。
2.  **利用phar反序列化:** 利用phar协议，将日志文件当作phar文件进行反序列化，从而触发预先构造好的恶意代码。

**POC 代码分析：**

提供的 POC 代码 `exp.py` 实现了 CVE-2021-3129 的利用。它首先检查目标是否存在漏洞，然后通过一系列步骤执行 RCE：

*   **`__vul_check()`:**  检查目标是否存在漏洞（检查返回码和页面内容）。
*   **`__clear_log()`:** 使用 `convert.iconv` 和 `convert.quoted-printable-encode` 清空日志文件。
*   **`__generate_payload()`:** 使用 `phpggc` 生成利用链的 payload,支持多种gadget chains。
*   **`__payload_send()`:**  向目标 URL 发送 POST 请求，`solution`参数指定为`Facade\Ignition\Solutions\MakeViewVariableOptionalSolution`。
*   **`__decode_log()`:** 使用 `convert.quoted-printable-decode` 解码日志文件，为反序列化做准备。
*   **`__unserialize_log()`:** 使用 `phar://` 协议触发反序列化。

**投毒风险分析：**

仔细检查 POC 代码后，没有发现明显的投毒代码。代码逻辑清晰，主要是利用 `phpggc` 生成 payload，然后通过日志文件写入和 phar 反序列化来执行 RCE。 风险在于依赖的`phpggc`工具本身可能存在恶意利用链。

因此，可以认为此仓库中作者隐藏的投毒代码风险很低，可能性为0%。

**项目地址:** [piperpwn/CVE-2021-3129-piperpwn](https://github.com/piperpwn/CVE-2021-3129-piperpwn)

**漏洞详情:** [CVE-2021-3129](https://nvd.nist.gov/vuln/detail/CVE-2021-3129)