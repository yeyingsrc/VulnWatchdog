## CVE-2021-3129-Laravel-Ignition-RCE

**漏洞编号:** CVE-2021-3129

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Laravel Ignition

**危害等级:** 高危，可能导致完全控制服务器

**影响版本:** Ignition < 2.5.2, Laravel < 8.4.2 (debug mode)

**利用条件:** 目标站点启用了 debug 模式，并且使用了受影响的 Laravel 和 Ignition 版本。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2021-3129 是一个存在于 Laravel Ignition 中的远程代码执行漏洞。该漏洞允许未经身份验证的远程攻击者执行任意代码。漏洞的根本原因是 `file_get_contents()` 和 `file_put_contents()` 的不安全使用。攻击者可以利用此漏洞在服务器上写入任意PHP代码，从而实现远程代码执行。

**利用方式：**

1.  **环境检查:** 漏洞需要目标站点运行在 debug 模式下，并且使用了受影响的 Laravel 和 Ignition 版本。
2.  **Payload 生成:**  使用 phpggc (PHP Generic Gadget Chains) 工具生成用于利用该漏洞的 payload。 该漏洞利用代码中提供了多种Gadget Chain，比如`Laravel/RCE1` ~ `Laravel/RCE7`以及`Monolog/RCE1` ~ `Monolog/RCE4`，可以执行`system`函数等命令。
3.  **日志清除:** 首先清除laravel.log日志，防止干扰。
4.  **Payload 投递:** 将生成的 payload 作为 `viewFile` 参数，通过 POST 请求发送到目标站点的错误处理接口。
5.  **日志解码:** 对 `laravel.log` 文件进行解码，以执行 payload 中的恶意代码。

**有效性：**

根据提供的漏洞库信息、漏洞利用代码，以及搜索引擎结果（虽然未提供具体结果，但考虑到其优先级），该漏洞的POC代码应该是有效的。漏洞库信息指出该漏洞已经被公开利用，并且存在可用的POC。提供的exp.py代码实现了payload的生成、发送、日志的清理和解码等操作，逻辑完整，证明了漏洞的可利用性。

**投毒风险：**

分析提供的`exp.py`和`Dockerfile`，投毒风险较低，但不能完全排除：

*   `Dockerfile`：Dockerfile 仅仅是从 `ikerlin/php:7.1-fpm-python3-dev` 镜像构建环境，并复制 `exp.py` 脚本，设置入口点为执行 `exp.py`，没有发现明显的恶意行为。
*   `exp.py`：exp.py 脚本实现了漏洞利用的核心逻辑。其中，主要的风险在于：
    *   **Payload生成依赖phpggc:** POC依赖于外部的phpggc工具生成payload，如果phpggc被篡改，payload可能被替换成恶意的代码。但是，这不在当前分析范围内，因为这涉及到phpggc本身的安全性问题。
    *   **硬编码的命令:** 代码中`Laravel/RCE5` 链默认的反弹shell的IP地址和端口(`192.168.78.129/4444`)，在实际使用中如果忘记修改，有可能会被攻击者利用。 *   **后门代码判定:** 如果该POC仅用于测试验证，其中的反弹shell代码（位于 `Laravel/RCE5` ）不应被判定为投毒代码。 评估为投毒风险5%。这部分代码为漏洞利用所需要，而非恶意添加的与漏洞利用无关的功能。
    *   **安全建议：**为了避免潜在风险，建议用户在使用该POC时，仔细检查代码，并使用自己的 phpggc 版本生成 payload，确保payload的安全性。

综上所述，该POC代码的主要风险在于payload生成和潜在的硬编码命令。但是，考虑到该POC主要用于漏洞利用，并没有发现明显的恶意代码，因此，投毒风险较低。

**项目地址:** [cuongtop4598/CVE-2021-3129-Script](https://github.com/cuongtop4598/CVE-2021-3129-Script)

**漏洞详情:** [CVE-2021-3129](https://nvd.nist.gov/vuln/detail/CVE-2021-3129)