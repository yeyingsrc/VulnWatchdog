## CVE-2021-3129-Laravel-Ignition-RCE

**漏洞编号:** CVE-2021-3129

**漏洞类型:** 远程代码执行

**影响应用:** Laravel Ignition

**危害等级:** 高危，允许未授权的远程代码执行

**影响版本:** Ignition < 2.5.2, Laravel < 8.4.2 (debug mode enabled)

**利用条件:** Laravel应用程序运行在debug模式下，并且使用了受影响的Ignition版本。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2021-3129 存在于 Laravel Ignition 中，由于不安全地使用了 `file_get_contents()` 和 `file_put_contents()` 函数，导致未经身份验证的远程攻击者可以执行任意代码。该漏洞主要出现在启用了debug模式的 Laravel 8.4.2 之前的版本中。

**利用方式：**

1.  **漏洞验证：** 通过发送包含恶意数据的HTTP请求到Laravel应用，触发Ignition的错误处理机制。
2.  **Payload生成：** 使用`phpggc`工具生成恶意的PHP反序列化payload。该POC代码中提供了多个`Laravel/RCE*`和`Monolog/RCE*` gadget chains可供选择。
3.  **日志清除：** 利用`php://filter`伪协议清除`laravel.log`文件，避免干扰。
4.  **Payload发送：** 将生成的payload嵌入到POST请求的`viewFile`参数中，发送到Laravel应用的错误报告端点。
5.  **反序列化触发：** Ignition会处理包含恶意payload的请求，导致PHP反序列化漏洞被触发，从而执行任意代码。
6.  **命令执行：** Payload中通常包含执行系统命令的代码，例如`system('id')`，攻击者可以通过该方式获取服务器权限。

**投毒风险评估：**

该POC代码主要功能是利用已知的反序列化漏洞执行命令。投毒风险较低，主要存在以下可能：

*   依赖`phpggc`工具，如果`phpggc`工具本身被篡改，则可能引入恶意代码。但这不是此POC代码本身的投毒。
*   POC代码包含多个gadget chains。攻击者可能会根据目标环境选择合适的chain， 但选择不当可能导致利用失败，而非执行恶意操作。
*  POC代码尝试清除日志，恶意攻击者可能会利用这一点清除攻击痕迹，增加溯源难度。
*   POC代码利用了`Facade\Ignition\Solutions\MakeViewVariableOptionalSolution` 类。如果目标系统修改过此类,可能会导致利用失败。

 综合来看，该POC代码的主要风险在于利用已知的RCE漏洞，而非引入新的恶意行为。因此，投毒风险较低，估计为5%。 

**项目地址:** [zhzyker/CVE-2021-3129](https://github.com/zhzyker/CVE-2021-3129)

**漏洞详情:** [CVE-2021-3129](https://nvd.nist.gov/vuln/detail/CVE-2021-3129)