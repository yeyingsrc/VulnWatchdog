## CVE-2021-3129 - Laravel Ignition RCE

**漏洞编号:** CVE-2021-3129

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Laravel (with Ignition)

**危害等级:** 严重，未经身份验证的远程代码执行

**影响版本:** Ignition < 2.5.2, Laravel < 8.4.2 (Debug模式)

**利用条件:** Laravel 应用开启了 debug 模式，并且安装了受影响版本的 Ignition 组件。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-3129 漏洞存在于 Laravel 的 Ignition 组件中，允许未经身份验证的远程攻击者执行任意代码。该漏洞是由于不安全地使用了 `file_get_contents()` 和 `file_put_contents()` 函数造成的。利用的前提是 Laravel 应用开启了 debug 模式，并且安装了受影响版本的 Ignition 组件 (小于 2.5.2) 以及Laravel版本小于8.4.2。

**利用方式：**

1.  攻击者首先发送一个包含特定 `solution` 和 `parameters` 的 POST 请求到 `/_ignition/execute-solution` 路由。
2.  `solution` 参数指定了 `Facade\Ignition\Solutions\MakeViewVariableOptionalSolution` 类，`parameters` 包含了 `variableName` 和 `viewFile` 两个参数。
3.  `viewFile` 参数是漏洞的关键，攻击者可以通过它来控制写入文件的内容和位置，从而实现 RCE。
4.  POC 代码首先清除 `../storage/logs/laravel.log` 文件，然后尝试使用多个 PHPGGC 链来生成 payload，并将它们写入到日志文件中。
5.  最后，它使用 `phar://../storage/logs/laravel.log` 协议来触发 phar 反序列化漏洞，从而执行任意代码。
6.  POC通过检查`attack.text`是否包含`root:x:`来判断是否利用成功。

**投毒风险分析：**

查看POC代码中发现存在创建`phpggc`文件夹并从`https://github.com/ambionics/phpggc.git`下载代码的逻辑,此处存在一定的风险,作者可能在phpggc仓库中加入恶意代码，如果作者控制了 `phpggc` 仓库，则可能通过该仓库植入恶意代码，从而在目标机器上执行任意操作。虽然该仓库的作者声称是安全的，但在使用前应该仔细审查该仓库的代码。其他的风险点可能存在于对用户输入的参数没有做严格的校验。

综上，认为存在**10%** 的投毒风险，主要集中在 `phpggc` 仓库的安全性上。

**项目地址:** [wmasday/CVE-2021-3129](https://github.com/wmasday/CVE-2021-3129)

**漏洞详情:** [CVE-2021-3129](https://nvd.nist.gov/vuln/detail/CVE-2021-3129)