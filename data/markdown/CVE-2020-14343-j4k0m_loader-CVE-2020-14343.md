## CVE-2020-14343-PyYAML-任意代码执行

**漏洞编号:** CVE-2020-14343

**漏洞类型:** 任意代码执行

**影响应用:** PyYAML

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** < 5.4

**利用条件:** 需要应用程序使用`yaml.load`或`yaml.full_load`解析不受信任的YAML数据

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2020-14343是PyYAML库中存在的一个反序列化漏洞，攻击者可以通过构造恶意的YAML文件，利用`python/object/new` constructor执行任意代码。提供的漏洞利用代码包含一个Flask Web应用程序，该程序接受base64编码的YAML数据，并使用`yaml.load`函数进行解析。由于使用了不安全的`yaml.load`函数，攻击者可以发送包含恶意payload的YAML数据，从而在服务器上执行任意命令。

**有效性：** 根据漏洞描述和提供的代码，可以判断该POC代码有效。`app.py`使用了`yaml.load`函数，该函数存在漏洞，可以被利用执行任意代码。

**投毒风险：** 分析仓库中的文件，`Dockerfile`只是构建了一个易受攻击的应用程序，`requirements.txt`指定了易受攻击的PyYAML版本（5.3）。`app.py`实现了漏洞利用点。 `flag.txt`只是一个简单的flag占位符。`index.html`提供了一个输入payload的界面。该仓库的README.md链接到有关该漏洞的CTF writeup， 这也进一步验证了POC的有效性。虽然该仓库主要用于演示漏洞，但存在极小的投毒风险（大约10%），因为攻击者可能尝试通过一些隐蔽的手法在docker启动阶段加入一些恶意的操作，例如：在启动命令中执行一些额外的脚本，但是从提供的代码来看并没有发现明显的投毒行为。

**利用方式：**

1.  构造恶意的YAML payload，其中包含利用`python/object/new` constructor执行命令的代码。
2.  将payload进行base64编码。
3.  将base64编码后的payload作为`data`参数通过POST请求发送到`/api/load`端点。
4.  服务器端接收到请求后，首先对`data`进行base64解码，然后使用`yaml.load`函数解析YAML数据。
5.  由于`yaml.load`函数存在漏洞，恶意payload会被执行，从而在服务器上执行任意命令。

攻击者可以在YAML payload中嵌入任何有效的Python代码，例如读取文件、执行系统命令等。读取flag的payload示例如下 (需要base64编码):
```yaml
!!python/object/apply:os.system ['cat /flag.txt']
```

**项目地址:** [j4k0m/loader-CVE-2020-14343](https://github.com/j4k0m/loader-CVE-2020-14343)

**漏洞详情:** [CVE-2020-14343](https://nvd.nist.gov/vuln/detail/CVE-2020-14343)