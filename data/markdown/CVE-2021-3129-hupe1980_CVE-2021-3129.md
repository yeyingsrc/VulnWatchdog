## CVE-2021-3129 Laravel Ignition RCE

**漏洞编号:** CVE-2021-3129

**漏洞类型:** 远程代码执行

**影响应用:** Laravel (Ignition <= 2.5.1)

**危害等级:** 高危，允许未授权的远程代码执行

**影响版本:** Ignition <= 2.5.1, Laravel < 8.4.2 (debug mode enabled)

**利用条件:** 目标站点启用debug模式，并且使用了受影响的Laravel和Ignition版本

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2021-3129漏洞存在于Laravel的Ignition组件中。该漏洞允许未经身份验证的远程攻击者执行任意代码。漏洞的根本原因是使用了不安全的 `file_get_contents()` 和 `file_put_contents()` 函数。利用条件是网站必须启用debug模式，并且使用受影响的Laravel和Ignition版本。利用方式如下：

1.  **日志清理:** 清理 Laravel 日志文件。
2.  **Payload写入:**  将恶意的PHP代码（phar payload）写入到日志文件中，通过多次post请求，以及字符串处理，保证payload的正确性。
3.  **日志转换为Phar文件:** 使用`convert.quoted-printable-decode`、`convert.iconv.utf-16le.utf-8`和`convert.base64-decode`过滤器将日志文件转换为一个有效的phar文件。
4.  **触发Phar反序列化:**  通过phar://wrapper触发phar文件的反序列化，从而执行恶意代码。该POC利用了 `Facade\Ignition\Solutions\MakeViewVariableOptionalSolution` 类来触发日志写入。

该POC代码本身未发现明显的投毒行为。提供的LICENSE文件和README.md文件都是标准的，exploit.py 代码的功能与漏洞描述一致，即通过操纵日志文件内容，再利用phar反序列化执行任意代码。但是需要注意，利用前需要phpggc生成phar文件，phpggc工具的安全性需要自行评估。

**项目地址:** [hupe1980/CVE-2021-3129](https://github.com/hupe1980/CVE-2021-3129)

**漏洞详情:** [CVE-2021-3129](https://nvd.nist.gov/vuln/detail/CVE-2021-3129)