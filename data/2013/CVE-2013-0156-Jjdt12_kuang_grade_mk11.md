## CVE-2013-0156-Rails-XML参数处理对象注入

**漏洞编号:** CVE-2013-0156

**漏洞类型:** 对象注入/代码执行

**影响应用:** Ruby on Rails

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** Rails < 2.3.15, 3.0.x < 3.0.19, 3.1.x < 3.1.10, 3.2.x < 3.2.11

**利用条件:** 应用程序使用受影响版本的Rails，并且允许处理XML格式的参数。

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

该漏洞存在于Ruby on Rails框架的`active_support/core_ext/hash/conversions.rb`文件中，由于其在处理XML或YAML参数时未正确限制字符串值的强制转换，攻击者可以通过构造恶意的XML或YAML数据，触发对象注入漏洞，从而执行任意代码或造成拒绝服务。

**利用方式：**

提供的POC代码`mk11.sh`是一个伪shell，它通过以下步骤利用漏洞：

1.  **接收命令：** 脚本接收用户输入的命令。
2.  **Base64编码：** 将命令进行Base64编码，防止特殊字符干扰。
3.  **构造Payload：**  构建一个包含恶意Ruby代码的XML Payload。此Payload利用了Rails中YAML/XML解析时可能存在的对象反序列化漏洞。Payload的核心在于`ActionDispatch::Routing::RouteSet::NamedRouteCollection`和`OpenStruct`等类的使用，这些类在特定情况下可以被用来执行任意代码。其中关键的一段是 `eval(%[${command_string}].unpack(%[m0])[0])`，这段代码将Base64编码后的命令字符串解码并执行。
4.  **发送请求：** 将构造的XML Payload作为POST请求发送到目标服务器。
5.  **获取输出：**  在攻击服务器上部署Web服务，然后通过日志分析（如Apache的access.log）获取命令执行的结果（通过curl命令）。使用分隔符`^`来提取Base64编码的输出，并进行解码显示。

**有效性：**

根据漏洞描述和POC代码，该漏洞利用是有效的，只要目标应用程序使用了受影响版本的Rails，并且允许处理XML格式的参数，攻击者就可以通过构造恶意的XML Payload来执行任意命令。

**投毒风险：**

该POC代码的投毒风险较低，约为1%。 主要风险点在于URL `<YOUR_ATTACKING_SERVER>`需要替换为攻击者自己的服务器。如果用户不小心使用了他人提供的恶意`mk11.sh`脚本，并且未检查脚本中的URL，则可能导致信息泄露给攻击者。

需要注意的是，此POC依赖于目标服务器访问日志，因此在某些配置下可能不可用。

**项目地址:** [Jjdt12/kuang_grade_mk11](https://github.com/Jjdt12/kuang_grade_mk11)

**漏洞详情:** [CVE-2013-0156](https://nvd.nist.gov/vuln/detail/CVE-2013-0156)