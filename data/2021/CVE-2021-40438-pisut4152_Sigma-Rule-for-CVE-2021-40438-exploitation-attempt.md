## CVE-2021-40438 - Apache mod_proxy SSRF

**漏洞编号:** CVE-2021-40438

**漏洞类型:** 服务器端请求伪造 (SSRF)

**影响应用:** Apache HTTP Server

**危害等级:** 高危，允许攻击者控制代理服务器请求的目标，可能导致内部信息泄露、内网服务攻击。

**影响版本:** <= 2.4.48

**利用条件:** 需要启用mod_proxy模块且存在不安全的配置。

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

CVE-2021-40438 是 Apache HTTP Server 2.4.48 及更早版本中 mod_proxy 模块存在的一个服务器端请求伪造 (SSRF) 漏洞。一个构造好的请求 URI 路径可以导致 mod_proxy 将请求转发到由远程用户选择的源服务器。

**有效性：**
根据漏洞描述，该漏洞允许攻击者指定代理请求的目标地址，因此提供的检测规则基于 `c-uri|contains: '?unix:'` 是合理的。`?unix:` 是一种可能的利用方式，攻击者可以使用 `unix:` 协议访问本地 Unix 域套接字，从而与内部服务进行交互。该检测规则还检测了 `sc-status: 200` 状态码，表示请求已成功转发到目标服务器，并收到了响应。因此，提供的POC代码初步判断有效。

**投毒风险：**
提供的POC代码（YAML格式的Sigma规则）主要用于检测漏洞利用，本身不包含恶意代码或后门。规则定义了检测包含特定字符串（`?unix:`）的URI，用于检测SSRF攻击。虽然规则本身可能存在误报或漏报的风险，但不存在直接的投毒风险。

**利用方式：**
1.  **利用前提：** Apache服务器启用 `mod_proxy` 模块，并且配置不当允许用户控制代理目标。
2.  **构造恶意请求：** 攻击者构造包含目标服务器地址的特殊 URI 路径。例如，使用 `?unix:` 协议访问本地 Unix 域套接字，或者使用 `http://internal-server`访问内部服务器。
3.  **服务器转发请求：** 受影响的 Apache 服务器接收到恶意请求后，`mod_proxy` 模块会将该请求转发到攻击者指定的目标服务器。
4.  **攻击目标：** 攻击者可以利用此漏洞访问内部服务、获取敏感信息或执行其他恶意操作。

**利用示例：**
```
GET /?unix:/path/to/socket|HTTP|1.1
Host: vulnerable-server.com
```
上述请求将尝试通过 Unix 域套接字 `/path/to/socket` 进行连接。

**修复建议：**
*   升级到 Apache HTTP Server 2.4.49 或更高版本。
*   配置 `mod_proxy` 模块，限制允许代理的目标地址。
*   使用防火墙或其他安全措施来保护内部服务。

**项目地址:** [pisut4152/Sigma-Rule-for-CVE-2021-40438-exploitation-attempt](https://github.com/pisut4152/Sigma-Rule-for-CVE-2021-40438-exploitation-attempt)

**漏洞详情:** [CVE-2021-40438](https://nvd.nist.gov/vuln/detail/CVE-2021-40438)