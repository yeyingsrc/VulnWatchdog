## CVE-2021-40438 - Apache HTTP Server mod_proxy SSRF

**漏洞编号:** CVE-2021-40438

**漏洞类型:** 服务器端请求伪造 (SSRF)

**影响应用:** Apache HTTP Server

**危害等级:** 高危，允许攻击者将请求转发到由远程用户选择的源服务器，可能导致敏感信息泄露，内部服务访问，甚至远程代码执行（如果内部服务存在其他漏洞）。

**影响版本:** <= 2.4.48

**利用条件:** 需要目标服务器启用mod_proxy模块且存在ProxyPass配置。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2021-40438 是 Apache HTTP Server 中 mod_proxy 模块的一个服务器端请求伪造 (SSRF) 漏洞。通过构造恶意的 URI 路径，攻击者可以诱使服务器将请求转发到攻击者控制的或内部的源服务器。 

**利用方式：**

漏洞利用的关键在于精心构造请求的 URI 路径。攻击者可以利用 `unix:/tmp/xdumps|http://.` 这样的URI，指示`mod_proxy`转发请求到指定URL，造成SSRF。

提供的漏洞利用代码 `check_point_gateways_rce.py` 专门针对 Check Point Security Gateways，利用该 SSRF 漏洞进行远程代码执行。它包含两种利用模式：

1.  `dump`: 尝试从目标服务器转储敏感信息，例如 `expertpwd` (专家模式密码) 或 `installer:last_update_time`。
2.  `reset`: 尝试重置 `admin` 用户的密码。这个模式会生成一个包含新密码哈希值的 payload，并将其发送到目标服务器。该代码中使用了`md5crypt`进行密码hash。
    利用步骤如下：
    *   构造包含重置密码的Payload。
    *   设置请求头 `Content-Type: application/octet-stream` 以绕过某些限制。
    *   将构造的Payload作为请求体发送到目标网关，触发密码重置。
    *   使用新密码通过API接口登录。
    *   执行任意API命令。
    例如，利用 `run-script` API执行任意命令。

**有效性：**

根据漏洞信息和提供的POC代码来看，该漏洞利用是有效的。POC 代码针对特定场景 (Check Point Security Gateways) 进行了优化，利用了该 SSRF 漏洞重置管理员密码，然后通过 API 执行任意命令。

**投毒风险：**

该代码主要利用了`requests`库发送HTTP请求。虽然代码中包含一些自定义函数如`monkey_patch`, `md5crypt`, `randstr`，但它们的实现相对简单，且没有明显的恶意行为。潜在的风险可能在于以下几个方面：

*   `monkey_patch()`：虽然文档中没有具体说明其作用，但猴子补丁可能会修改 `requests` 库的默认行为，如果补丁代码不正确，可能会导致意外的行为或安全问题。需要仔细审查其具体实现，但根据代码推测, 只是为了忽略SSL证书验证问题, 方便测试。
*   依赖项风险：如果依赖的第三方库 (例如 `requests`, `urllib3`) 存在安全漏洞，可能会引入安全风险。

总体来说，直接投毒风险较低，可能存在一些隐蔽性较低的漏洞，概率评估为 **5%**。重点在于审查 `monkey_patch` 函数的具体实现，并确保使用的第三方库是最新版本，以避免潜在的依赖项风险。

**项目地址:** [yakir2b/check-point-gateways-rce](https://github.com/yakir2b/check-point-gateways-rce)

**漏洞详情:** [CVE-2021-40438](https://nvd.nist.gov/vuln/detail/CVE-2021-40438)