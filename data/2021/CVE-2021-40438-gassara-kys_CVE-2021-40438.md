## CVE-2021-40438 - Apache HTTP Server mod_proxy SSRF

**漏洞编号:** CVE-2021-40438

**漏洞类型:** 服务器端请求伪造 (SSRF)

**影响应用:** Apache HTTP Server

**危害等级:** 高危，可能导致内部信息泄露、远程命令执行（取决于内部网络配置）

**影响版本:** <= 2.4.48

**利用条件:** mod_proxy 模块启用且存在不安全的配置

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-40438 是 Apache HTTP Server 中 mod_proxy 模块的一个服务器端请求伪造（SSRF）漏洞。攻击者可以通过构造特制的 URI 路径，使 mod_proxy 将请求转发到由攻击者控制的源服务器。这允许攻击者访问内部服务、读取敏感数据，或者在某些情况下执行远程代码。

**漏洞利用分析：**

提供的 Dockerfile 使用了 `httpd:2.4.48` 镜像，该版本受此漏洞影响。 `exploit.conf.txt` 文件配置了 Apache 的 `mod_proxy` 模块，并将所有请求代理到 `http://altoromutual.com/`。  关键在于，如果存在配置错误，例如代理规则过于宽松，攻击者可以通过构造包含目标地址的 URI 来绕过代理，从而利用 SSRF 漏洞。`main.sh` 文件通过 `curl` 命令发送包含 `unix:`协议的请求到本地的 Apache 服务器。该漏洞可以通过控制URI路径，让代理将请求转发到任意目标。

**有效性：**

POC代码有效，可以复现该漏洞。如果Apache服务器存在mod_proxy模块并且配置不当，攻击者可以利用该漏洞进行SSRF攻击。

**投毒风险：**

存在一定的投毒风险。虽然主要代码是用于复现 SSRF 漏洞，但 `exploit.conf.txt` 文件中，攻击者可以添加恶意的配置，例如将某些特定请求代理到攻击者的恶意服务器。`main.sh` 文件中可能包含下载和执行恶意脚本的命令，尽管目前提供的文件没有，但存在潜在风险。Dockerfile使用了固定的httpd版本，并COPY了本地文件，相对安全。由于Dockerfile使用官方镜像并且配置相对简单，投毒风险较低。可以增加对altoromutual.com的恶意利用，进行进一步攻击。

**利用方式：**

1.  目标系统必须运行受影响版本的 Apache HTTP Server，且启用了 `mod_proxy` 模块。
2.  需要存在一个不安全的代理配置，允许通过 URI 路径控制请求的目标地址。
3.  攻击者构造包含恶意目标地址的 URI，发送到 Apache 服务器。
4.  Apache 服务器的 `mod_proxy` 模块会将请求转发到攻击者指定的目标地址，从而实现 SSRF。

通过利用此漏洞，攻击者可以扫描内部网络，访问内部服务，或者获取敏感信息。具体能做什么取决于内部网络的配置以及目标服务的安全性。

**项目地址:** [gassara-kys/CVE-2021-40438](https://github.com/gassara-kys/CVE-2021-40438)

**漏洞详情:** [CVE-2021-40438](https://nvd.nist.gov/vuln/detail/CVE-2021-40438)