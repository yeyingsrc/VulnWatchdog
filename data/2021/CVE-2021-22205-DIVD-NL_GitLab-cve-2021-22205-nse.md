## CVE-2021-22205-GitLab-远程代码执行

**漏洞编号:** CVE-2021-22205

**漏洞类型:** 远程代码执行

**影响应用:** GitLab

**危害等级:** 高危，可导致完全控制受影响的GitLab实例

**影响版本:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**利用条件:** 需要目标GitLab实例存在且可网络访问，无需身份验证

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2021-22205 漏洞存在于 GitLab CE/EE 11.9 到 13.10.3 版本中，由于 GitLab 没有正确验证传递给文件解析器的图像文件，导致远程命令执行。 具体来说，当上传图像文件时，GitLab Workhorse 会将 jpg|jpeg|tiff 扩展名的文件传递给 ExifTool 以删除任何非白名单的标签。 ExifTool 将忽略文件扩展名并尝试根据内容确定文件类型，允许攻击者通过重命名上传的文件来触发 DjVu 解析器。 DjVu 解析器在解析 DjVu 注释时，会对 token 进行 eval 操作以转换 C 转义序列。虽然存在一些验证来确保所有内容都被正确转义，但是反斜杠后跟换行符可以被正确处理，从而允许引号被关闭，并插入和评估任意 Perl 代码。

提供的 POC 代码 (CVE-2021-22205.nse) 是一个 Nmap 脚本，它不直接利用该漏洞执行代码，而是通过检查特定 CSS 文件的存在来判断目标 GitLab 实例是否为易受攻击的版本。 它通过发送 HTTP GET 请求到 GitLab 实例，根据返回的 CSS 文件内容来确定GitLab的版本,如果版本在受影响的范围内,则认为存在漏洞。

利用方式：
1.  攻击者构造一个恶意的 DjVu 文件，其中包含可以执行命令的 Perl 代码。
2.  将恶意文件上传到易受攻击的 GitLab 实例（通常作为头像、项目logo或其他允许上传图像的字段）。
3.  GitLab Workhorse 将文件传递给 ExifTool 进行处理。
4.  ExifTool 识别出 DjVu 格式并调用相应的解析器。
5.  恶意 Perl 代码被执行，导致远程代码执行。

投毒风险评估：
该 Nmap 脚本的主要目的是检测漏洞是否存在，而不是利用该漏洞。 代码中没有发现任何尝试执行恶意操作或向目标系统植入后门的迹象。 因此，投毒风险较低 (0%)。


**项目地址:** [DIVD-NL/GitLab-cve-2021-22205-nse](https://github.com/DIVD-NL/GitLab-cve-2021-22205-nse)

**漏洞详情:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)