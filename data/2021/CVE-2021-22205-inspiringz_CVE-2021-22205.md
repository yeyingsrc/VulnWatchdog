## CVE-2021-22205-GitLab-RCE

**漏洞编号:** CVE-2021-22205

**漏洞类型:** 远程代码执行

**影响应用:** GitLab

**危害等级:** 高危，未授权远程代码执行

**影响版本:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**利用条件:** 目标GitLab实例存在漏洞，可网络访问

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-22205是GitLab CE/EE中的一个远程代码执行漏洞。该漏洞源于GitLab未能正确验证传递给文件解析器的图像文件，导致远程命令执行。攻击者可以通过上传包含恶意ExifTool元数据的图像文件来利用此漏洞。

**有效性：**
根据提供的漏洞信息和漏洞利用代码，可以判断该POC代码是有效的。漏洞库信息表明该漏洞影响多个GitLab版本，且CVSS评分为10，属于严重级别。漏洞利用代码旨在利用ExifTool在处理恶意图像时的命令注入漏洞。

**投毒风险：**
提供的漏洞利用代码看起来像是利用CVE-2021-22205漏洞的exploit，用于远程代码执行。其中定义了Sessions类以方便发送HTTP请求, 并且使用了DNSLog，PostBin，RequestBin等服务作为验证漏洞的方式。代码中`random_str`函数用于生成随机字符串，这在漏洞利用中很常见，用于避免被简单规则检测。`/tmp/5c52ea306e0854cb73063a671293313c/CVE-2021-22205.py`表明该脚本位于临时文件夹，可能表明是一个提取出来的或者下载的利用脚本。代码中存在对一些外部服务的调用，比如DNSLog，RequestBin等，作者可能通过这些服务来收集一些信息。因此，存在一定被投毒的风险，例如作者在脚本中嵌入恶意代码，利用目标服务器的资源进行挖矿或者其他恶意行为。此外，DNSLog如果被恶意劫持，可能导致信息泄露。综上所述，存在10%的投毒可能性，请仔细审计代码。

**利用方式：**
1.  **获取CSRF Token和Session Cookie：** 漏洞利用的第一步是获取有效的CSRF Token和Session Cookie。POC代码首先尝试访问 `/users/sign_in`、`/help` 或 `/explore` 页面，然后从中提取所需的token和cookie。
2.  **上传恶意图像：** 利用获取的CSRF Token和Session Cookie，攻击者可以上传一个特制的图像文件。该图像文件的Exif元数据中包含恶意命令，这些命令将在GitLab服务器上由ExifTool执行。
3.  **远程代码执行：** 当GitLab服务器尝试处理上传的图像文件时，ExifTool会执行图像元数据中嵌入的恶意命令，从而导致远程代码执行。
4.  **OOB（带外）验证：**  POC代码初始化了DNSLog，RequestBin等服务，用于验证漏洞。攻击者可以通过DNS查询或者HTTP请求的方式来确定命令是否成功执行。

**项目地址:** [inspiringz/CVE-2021-22205](https://github.com/inspiringz/CVE-2021-22205)

**漏洞详情:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)