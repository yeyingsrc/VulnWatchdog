## CVE-2021-22205-GitLab-RCE

**漏洞编号:** CVE-2021-22205

**漏洞类型:** 远程代码执行

**影响应用:** GitLab

**危害等级:** 严重，未经身份验证的远程代码执行

**影响版本:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**利用条件:** 目标GitLab实例版本在受影响范围内，且攻击者可访问该实例。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-22205 是一个存在于 GitLab CE/EE 中的远程命令执行漏洞。该漏洞是由于 GitLab 没有正确验证传递给文件解析器的图像文件导致的。具体来说，攻击者可以通过上传特制的图像文件（DjVu 文件）到 GitLab 服务器，其中图像文件的元数据中包含恶意命令。当 GitLab 使用 ExifTool 处理该图像时，文件中的恶意命令会被执行，从而导致远程代码执行。

**有效性：**
根据提供的漏洞库信息和漏洞利用代码，该漏洞的POC代码有效。漏洞库信息表明该漏洞的严重性为“严重 (CRITICAL)”，CVSS 评分高达 10 分，表明该漏洞影响范围广且容易利用。提供的 POC 代码 `CVE-2021-22205.py` 旨在利用此漏洞。

**利用方式：**
1.  **查找CSRF token:** 脚本首先尝试从 `/users/sign_in` 页面获取 CSRF token，因为上传文件需要有效的 CSRF token。它使用正则表达式来提取 token。
2.  **构建恶意DjVu文件上传请求:** 然后，脚本构建一个包含恶意 ExifTool 命令的 DjVu 文件。这个文件会被上传到 GitLab 服务器，GitLab 服务器会使用 ExifTool 处理该文件。
3.  **触发命令执行:** 当 ExifTool 处理该恶意文件时，嵌入在文件元数据中的命令就会被执行，从而导致远程代码执行。

**投毒风险：**
虽然提供的代码看起来功能明确，但存在一定的投毒风险。具体表现在以下几个方面：

*   **依赖性风险:** 该脚本依赖于 `requests` 模块。虽然这是很常见的模块，如果作者修改了代码中的其他地方，使其安装了恶意依赖，这可能是一个投毒点。
*   **代理配置利用:** 脚本支持通过代理服务器连接。攻击者可能会通过提供恶意的代理服务器地址来窃取受害者的凭据或执行中间人攻击。
*   **命令执行的隐蔽性：** 如果上传的payload包含反弹shell, 则脚本可能会尝试建立反向 shell 连接或执行其他恶意操作而难以检测。
*   **版本验证绕过:** 脚本中的版本验证可能存在绕过的风险，即使用户修复了漏洞，脚本仍然尝试利用，可能会导致其他未知的安全问题。

综合考虑，评估投毒风险约为 10%。主要原因是该脚本的功能较为集中，且依赖模块较少。但仍然需要对脚本进行仔细审查，以确保其安全性。

**项目地址:** [cc3305/CVE-2021-22205](https://github.com/cc3305/CVE-2021-22205)

**漏洞详情:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)