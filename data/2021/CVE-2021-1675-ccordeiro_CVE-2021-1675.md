## CVE-2021-1675 PrintNightmare Windows Print Spooler Remote Code Execution

**漏洞编号:** CVE-2021-1675

**漏洞类型:** 远程代码执行

**影响应用:** Windows Print Spooler

**危害等级:** 高危，可能导致系统完全控制

**影响版本:** 受影响的Windows版本众多，详见漏洞库信息

**利用条件:** 目标系统开启Print Spooler服务，攻击者需要能够访问目标系统的SMB共享或利用其他方式上传恶意DLL。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

该漏洞存在于Windows Print Spooler服务中，允许未经授权的用户通过RpcAddPrinterDriverEx函数远程加载和执行恶意DLL文件。攻击者可以利用此漏洞在目标系统上执行任意代码，获得系统权限。

**利用方式：**

1.  攻击者需要一个可以访问的SMB共享，用于存放恶意DLL文件。
2.  利用提供的Python脚本，连接目标系统的Print Spooler服务。
3.  脚本会先枚举可用的驱动，尝试找到一个合适的驱动路径。
4.  脚本构造恶意的DRIVER_CONTAINER结构，其中包含恶意DLL的路径（指向SMB共享）。
5.  通过RpcAddPrinterDriverEx函数将恶意DLL添加到目标系统。
6.  系统会尝试加载该DLL，从而执行其中的恶意代码。
7.  脚本尝试修改ConfigFile，通过多次尝试触发漏洞，利用已经存在的目录，绕过安全机制。

**有效性：**

提供的POC代码有效，可以利用CVE-2021-1675漏洞。

**投毒风险：**

POC代码存在一定的投毒风险。虽然代码主要功能是利用PrintNightmare漏洞，但存在以下几点需要注意：

1.  **硬编码路径：** 代码中存在硬编码的`C:\Windows\System32\winhttp.dll`和`C:\Windows\System32\kernelbase.dll`路径。虽然这是为了利用该漏洞的特定方式，但也可能被用于其他恶意目的，例如覆盖系统关键文件。
2.  **循环尝试：** 代码中循环尝试不同的ConfigFile路径，这增加了攻击成功的概率，但也增加了被检测到的可能性。更隐蔽的攻击可能会选择更精确的目标路径。
3. **DLL上传源验证:** 脚本依赖从外部SMB共享加载DLL。如果攻击者控制了该共享，可以轻易替换DLL内容，植入恶意代码。

由于代码主要目标是漏洞利用而非隐藏恶意功能，因此投毒风险相对较低，但仍然存在。 综合代码的功能和实现方式，判定投毒的风险在10%。

**项目地址:** [ccordeiro/CVE-2021-1675](https://github.com/ccordeiro/CVE-2021-1675)

**漏洞详情:** [CVE-2021-1675](https://nvd.nist.gov/vuln/detail/CVE-2021-1675)