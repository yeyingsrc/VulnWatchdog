## CVE-2017-7494-Samba-远程代码执行

**漏洞编号:** CVE-2017-7494

**漏洞类型:** 远程代码执行

**影响应用:** Samba

**危害等级:** 高危，允许恶意客户端上传共享库到可写共享，然后导致服务器加载并执行它。

**影响版本:** since 3.5.0 and before 4.6.4, 4.5.10 and 4.4.14

**利用条件:** 需要对Samba服务器的写入权限的共享目录进行访问。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2017-7494，也被称为"SambaCry"，是一个存在于Samba 3.5.0及之后版本中的远程代码执行漏洞。攻击者可以利用此漏洞通过上传恶意共享库到可写共享，然后触发服务器加载并执行该库，从而获得服务器的控制权。

**有效性分析：**

根据漏洞描述和漏洞库信息，该漏洞允许远程代码执行。提供的Dockerfile旨在构建一个包含漏洞版本的Samba服务器的Docker镜像，用于漏洞测试。提供的`smb.conf`配置文件定义了一个可写共享目录`/data`，guest用户可访问。构建过程还创建了一个名为`cved`的用户，并设置了相应的Samba密码。因此，提供的POC代码框架是有效的，允许在Docker容器中搭建存在漏洞的环境，便于漏洞复现和验证。

**投毒风险分析：**

虽然提供的Dockerfile和相关配置文件主要用于搭建漏洞环境，但仍然存在潜在的投毒风险，虽然很低，但仍然需要注意。

*   **构建脚本中的潜在恶意代码：** 虽然Dockerfile中的大部分命令是标准的软件安装和配置命令，但仍然需要仔细检查每个命令，以防止其中存在隐藏的恶意代码。例如，`configure`和`make`命令执行的编译过程可能被篡改以植入后门。
*   **配置文件中的后门：**  `smb.conf` 文件设置`guest ok = yes`，允许匿名访问`/data` 目录，如果上传的so文件被设置为启动时加载，那么匿名用户也可以执行远程代码执行。这本身是漏洞利用的一部分，但也可以被认为是投毒，因为未经授权的用户可以利用该配置。

基于上述分析，认为此仓库中存在作者隐藏的投毒代码的可能性较低，大约为10%。主要风险在于对Samba配置不当可能导致恶意利用。

**漏洞利用方式：**

1.  **找到可写共享：** 首先，攻击者需要找到Samba服务器上的一个可写共享目录。这个可以通过nmap等扫描工具或者手动尝试访问共享目录来发现。
2.  **上传恶意共享库：** 攻击者构造一个包含恶意代码的共享库（.so文件），并将其上传到可写共享目录。
3.  **触发共享库加载：**  攻击者需要某种方式来触发Samba服务器加载并执行上传的恶意共享库。CVE-2017-7494的利用方式是利用`vfs objects = ...` 参数指定so路径，来触发Samba服务器执行恶意代码。还可以通过其他方式触发，例如修改Samba配置文件或者利用其他Samba服务。
4.  **远程代码执行：** 当Samba服务器加载恶意共享库时，其中的恶意代码将被执行，攻击者从而获得服务器的控制权。

**项目地址:** [cved-sources/cve-2017-7494](https://github.com/cved-sources/cve-2017-7494)

**漏洞详情:** [CVE-2017-7494](https://nvd.nist.gov/vuln/detail/CVE-2017-7494)