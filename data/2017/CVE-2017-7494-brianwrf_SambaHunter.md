## CVE-2017-7494-Samba-远程代码执行

**漏洞编号:** CVE-2017-7494

**漏洞类型:** 远程代码执行

**影响应用:** Samba

**危害等级:** 高危，可能导致服务器被完全控制

**影响版本:** 3.5.0 - 4.6.4, 4.5.10, 4.4.14

**利用条件:** 需要目标Samba服务器存在可写共享目录，攻击者能够访问该共享。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2017-7494，又名“SambaCry”，是一个存在于Samba服务器中的远程代码执行漏洞。从提供的漏洞库信息来看，该漏洞存在于Samba 3.5.0到4.6.4、4.5.10和4.4.14版本中。恶意客户端可以通过上传共享库到可写的共享目录，然后诱使服务器加载并执行该库来利用此漏洞。

**有效性：**
提供的POC代码（sambahunter.py）尝试利用该漏洞。它首先生成一个包含命令执行的共享库（.so文件），然后尝试将其上传到目标服务器上的已知共享目录。如果成功上传，则尝试触发服务器加载并执行该共享库。根据代码和漏洞描述，该POC具有较高的有效性。

**投毒风险：**
虽然该POC的主要功能是利用漏洞，但仍然存在一定的投毒风险。风险点在于`sambahunter.py`脚本中包含生成payload的函数。虽然代码已经贴出，但用户在使用时可能不会仔细审查代码。以下是一些潜在的投毒方式：

1.  **Payload修改：** 作者可能会在payload生成函数中植入恶意代码，例如，在执行用户指定命令之前或之后，执行一些额外的恶意操作，如安装后门、收集信息等。用户如果不检查生成的.so文件，可能会受到影响。
2.  **默认参数修改：** 如果脚本包含默认的目标服务器或命令，恶意作者可以将其设置为攻击者控制的服务器或执行恶意操作的命令。
3.  **依赖项修改：** 作者可以指定恶意版本的依赖项（例如`pysmbclient`），其中包含恶意代码。
4. **文件上传目录:** 代码中预设了一些常见的可写目录,攻击者可以在这些目录中提前放置恶意文件,等待其他用户执行。
从代码分析来看，投毒的概率较低，假设为10%。多数代码逻辑围绕漏洞利用展开，较为直接。

**利用方式：**
1.  **查找可写共享：** 攻击者首先需要确定目标Samba服务器上是否存在可写的共享目录。`sambahunter.py` 脚本会尝试常见共享目录，并上传临时文件以验证是否可写。
2.  **生成Payload：** 攻击者使用`generate_payload` 函数生成包含恶意命令的共享库（.so）文件。命令可以通过`-c`参数指定。
3.  **上传Payload：** 攻击者使用SMB协议将生成的共享库上传到可写的共享目录。
4.  **触发执行：** 攻击者通过构造一个特殊的请求，诱使Samba服务器加载并执行上传的共享库。这个请求的本质是利用Samba的`vfs_fruit`模块的路径处理缺陷，使得Samba将上传的`.so`文件当做模块加载并执行。

总的来说，该漏洞利用方式较为直接，依赖于Samba服务器配置不当（存在可写共享）和版本过旧。`sambahunter.py` 脚本简化了漏洞利用过程。

**项目地址:** [brianwrf/SambaHunter](https://github.com/brianwrf/SambaHunter)

**漏洞详情:** [CVE-2017-7494](https://nvd.nist.gov/vuln/detail/CVE-2017-7494)