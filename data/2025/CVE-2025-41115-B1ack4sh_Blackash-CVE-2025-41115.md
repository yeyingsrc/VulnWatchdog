## CVE-2025-41115 - Grafana Enterprise SCIM UID Overwrite

**漏洞编号:** CVE-2025-41115

**漏洞类型:** 权限提升

**影响应用:** Grafana Enterprise

**危害等级:** 高危，可导致管理员权限获取

**影响版本:** 12.0.0 到 12.2.1

**利用条件:** 需要启用SCIM且user_sync_enabled = true

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2025-41115 漏洞存在于 Grafana Enterprise 的 SCIM 用户配置功能中。当启用 SCIM 配置且 `user_sync_enabled = true` 时，恶意 SCIM 客户端可以发送一个数字 `externalId`，Grafana 错误地将其映射到内部用户 ID，从而允许攻击者模拟或覆盖现有帐户，包括管理员帐户。 

**有效性分析：**

提供的 POC 代码尝试利用该漏洞通过 SCIM 接口覆盖现有用户（特别是 UID 为 1 的管理员帐户）。 它首先尝试使用一组默认或泄露的 SCIM 令牌，如果这些令牌失败，则需要有效的 SCIM 令牌。

该利用脚本会构造一个 SCIM 有效负载，其中 `externalId` 设置为要覆盖的目标用户的 UID，并将 `userName` 设置为攻击者控制的帐户。成功后，攻击者可以使用任意密码以攻击者帐户登录并获得管理员权限。

根据提供的README.md, 漏洞存在于12.0.0 到 12.2.1版本，高于或者低于该版本不受影响，如果目标满足漏洞存在的版本和配置条件，该漏洞利用代码有效。

**投毒风险分析：**

对提供的 Python 脚本和 README.md 文件进行了分析。

*   **Python 脚本：** 脚本的功能是利用 CVE-2025-41115 漏洞。虽然脚本本身实现了漏洞利用，但存在一些潜在的风险点需要注意：
    *   **默认令牌：** 脚本包含了一系列默认令牌，如果目标系统使用了这些默认令牌，攻击者可以直接利用。但从投毒角度看，包含默认令牌是为了方便使用者，降低利用门槛，不属于投毒行为。
    *   **依赖项：** 脚本依赖 `requests` 库。如果攻击者控制了用户的 Python 环境，可能会通过篡改 `requests` 库来植入恶意代码。但这是针对运行环境的攻击，不是脚本本身的投毒。
    *   **错误处理：** 脚本的错误处理部分相对简单。在实际利用中，可能需要更健壮的错误处理机制，以避免因意外情况导致利用失败。

*   **README.md 文件：** 该文件提供了漏洞的详细描述和利用方法。没有发现恶意代码或指令。

综合来看，该仓库中直接包含恶意投毒代码的可能性较低（大约 5%），主要风险在于脚本中使用的默认令牌可能被滥用，以及运行环境可能被攻击者控制。使用时，建议：

*   **替换默认令牌：** 如果你有有效的 SCIM 令牌，请替换脚本中的默认令牌。
*   **检查运行环境：** 确保运行脚本的 Python 环境是安全的，没有被篡改。
*   **谨慎使用：** 仅在授权的渗透测试或漏洞评估中使用该脚本。

**利用方式：**

1.  目标系统必须运行 Grafana Enterprise，版本为 12.0.0 到 12.2.1。
2.  SCIM 功能必须启用 (`enableSCIM = true`)。
3.  `user_sync_enabled` 必须设置为 `true` (`[auth.scim] user_sync_enabled = true`)。
4.  攻击者需要访问目标 Grafana 实例的网络。
5.  攻击者需要一个有效的 SCIM 令牌 (通过在Grafana管理页面生成)，或者目标系统使用了脚本中包含的默认/泄露的令牌。
6.  攻击者运行提供的 Python 脚本，将目标 Grafana 实例的 URL 作为参数传递。
7.  脚本尝试使用默认/泄露的令牌或者用户提供的token通过 SCIM 接口创建一个新用户，并将 `externalId` 设置为目标用户（通常是 UID 为 1 的管理员）的 UID。
8.  如果利用成功，攻击者可以使用任意密码以新创建的用户登录并获得管理员权限。

**项目地址:** [B1ack4sh/Blackash-CVE-2025-41115](https://github.com/B1ack4sh/Blackash-CVE-2025-41115)

**漏洞详情:** [CVE-2025-41115](https://nvd.nist.gov/vuln/detail/CVE-2025-41115)