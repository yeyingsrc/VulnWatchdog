## CVE-2025-49844-Redis-Lua Use-After-Free

**漏洞编号:** CVE-2025-49844

**漏洞类型:** Use-After-Free

**影响应用:** Redis

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** < 8.2.2

**利用条件:** 需要能够执行Lua脚本的Redis权限

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2025-49844 是 Redis 中 Lua 脚本引擎的一个 Use-After-Free 漏洞。该漏洞允许经过身份验证的用户使用特制的 Lua 脚本来操纵垃圾收集器，触发释放后使用，并可能导致远程代码执行。漏洞存在于所有具有 Lua 脚本功能的 Redis 版本中，直到 8.2.2 版本修复。 

**有效性：**
根据提供的漏洞信息和利用代码，该漏洞利用是有效的。POC 代码通过精心构造 Lua 脚本，利用 Redis 在解析 Lua 脚本时垃圾回收机制的竞争条件。该脚本创建带有 `__gc` 元方法的代理对象，该方法在垃圾回收时被调用，并尝试再次触发垃圾回收，从而导致 Use-After-Free。重复执行该脚本会导致 Redis 服务崩溃或连接断开，证明了漏洞的可利用性。

**投毒风险：**
通过分析提供的 POC 代码，未发现任何明显的投毒代码。该代码的目标是利用 Redis 本身的漏洞，而不是植入恶意代码。代码逻辑主要集中在触发漏洞本身，没有额外的恶意行为。因此，该仓库中存在作者隐藏的投毒代码的可能性较低 (0%)。

**利用方式：**
利用方式如下：
1.  攻击者需要具有执行 Lua 脚本的 Redis 权限（通常需要身份验证）。
2.  攻击者使用 `redis-cli` 工具执行 `CVE-2025-49844.lua` 脚本。脚本通过 `loadstring` 函数加载包含大量注释的 Lua 代码块，并使用带有 `__gc` 元方法的代理对象作为 chunk 名称。
3.  当 Lua 脚本解析器运行时，代理对象的 `__gc` 元方法会在垃圾回收期间被调用。这个元方法会再次触发垃圾回收，导致解析器中使用的 chunk 名称字符串被释放。
4.  解析器随后尝试访问已释放的 chunk 名称字符串，从而触发 Use-After-Free 漏洞。
5.  重复执行该脚本会增加触发漏洞的概率，最终导致 Redis 服务崩溃或允许远程代码执行。

**缓解措施：**
1.  升级到 Redis 8.2.2 或更高版本，该版本已修复此漏洞。
2.  限制不受信任的用户执行 Lua 脚本的能力，可以通过 ACL 限制 `EVAL` 和 `EVALSHA` 命令。

**项目地址:** [dwisiswant0/CVE-2025-49844](https://github.com/dwisiswant0/CVE-2025-49844)

**漏洞详情:** [CVE-2025-49844](https://nvd.nist.gov/vuln/detail/CVE-2025-49844)