## CVE-2021-22205-GitLab-远程命令执行

**漏洞编号:** CVE-2021-22205

**漏洞类型:** 远程命令执行

**影响应用:** GitLab

**危害等级:** 高危，可能导致服务器完全控制

**影响版本:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**利用条件:** 目标GitLab实例版本在受影响范围内，且可以通过网络访问。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2021-22205 漏洞存在于 GitLab CE/EE 中，源于其没有正确验证传递给文件解析器的图像文件，导致远程命令执行。漏洞利用方式：攻击者可以构造包含恶意元数据的图像文件，通过上传接口（如用户头像上传）触发 ExifTool 的命令注入漏洞，从而执行任意命令。

**漏洞利用有效性:**
根据漏洞库信息和漏洞利用代码，提供的PoC代码是有效的。漏洞库信息中的参考链接指向了 HackerOne 报告和 Packet Storm Security 的相关利用分析，证明了该漏洞的可利用性。提供的 bash 脚本能够自动化利用该漏洞，支持反弹 shell 和自定义命令执行。

**投毒风险分析:**
提供的 bash 脚本 `cve-2021-22205.sh`  主要功能是生成包含恶意元数据的图像，并通过 curl 命令上传到目标 GitLab 服务器，触发命令执行。 代码本身逻辑清晰，没有明显的恶意行为，如未经授权的文件访问、数据窃取、或者植入后门等。

虽然目前的代码没有发现明显的投毒迹象，但是由于脚本会执行用户指定的命令，因此存在潜在风险。用户需要仔细检查运行的命令，避免执行恶意操作。潜在的投毒方式可能是在脚本中添加隐蔽的逻辑，例如根据目标环境执行不同的命令。因此，代码的安全性评估并非绝对，需要结合具体使用场景进行综合判断。 代码中创建临时文件, 并且进行删除可以判定,作者的编码习惯良好.

**漏洞利用方式:**
1.  攻击者首先获取目标 GitLab 实例的 CSRF Token 和 Session Cookie。
2.  然后，构造一个包含恶意元数据的图像文件，该元数据中包含了要执行的命令。
3.  使用 curl 命令，将构造的恶意图像文件上传到 GitLab 服务器的头像上传接口。
4.  GitLab 调用 ExifTool 处理上传的图像文件，ExifTool 在解析图像元数据时，会执行恶意命令，从而实现远程命令执行。
5. 攻击者可以通过反弹 shell 或者执行自定义命令来控制服务器。

**项目地址:** [NukingDragons/gitlab-cve-2021-22205](https://github.com/NukingDragons/gitlab-cve-2021-22205)

**漏洞详情:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)