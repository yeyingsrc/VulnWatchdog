## CVE-2024-51378-CyberPanel-命令注入

**漏洞编号:** CVE-2024-51378

**漏洞类型:** 命令注入

**影响应用:** CyberPanel

**危害等级:** 高危，未经身份验证的远程命令执行

**影响版本:** 2.3.6及(未修补)2.3.7

**利用条件:** 需要网络访问CyberPanel实例

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

该漏洞存在于CyberPanel的dns/views.py和ftp/views.py中的getresetstatus功能。由于secMiddleware仅针对POST请求，远程攻击者可以通过GET请求绕过身份验证，并在statusfile属性中使用shell元字符，通过访问/dns/getresetstatus或/ftp/getresetstatus来执行任意命令。 

**漏洞利用分析：**

1.  **漏洞原理：** 通过构造包含shell元字符的`statusfile`参数，实现命令注入。
2.  **利用方式：**
    *   **被动模式（扫描）：** 通过GET请求访问`/ftp/getresetstatus`，检查返回内容是否包含`JSONDecodeError at /ftp/getresetstatus`，以此判断是否存在漏洞。
    *   **主动模式（利用）：**
        1.  发送GET请求获取`csrftoken`。
        2.  发送OPTIONS请求到`/ftp/getresetstatus`或`/dns/getresetstatus`，在请求头中包含获取的`csrftoken`，并在payload的`statusfile`参数中注入命令。例如，`{"statusfile": "/dev/null; id; #","csrftoken":"{{csrf_token}}"}`。

3.  **有效性：** 提供的POC代码（`51378_use.py`和Nuclei模板）有效。`51378_use.py`脚本可以交互式地执行命令。Nuclei模板提供了被动和主动两种扫描方式。

4.  **投毒风险：**
   仓库的大部分代码看起来是用于漏洞检测和利用的，只有少量用户交互部分，例如命令行输入。因此，投毒风险较低，大约在5%。 但不能完全排除作者在扫描或利用脚本中加入恶意代码的可能性,例如反弹shell或下载执行恶意程序等行为。需要人工审核所有脚本代码，特别是与网络请求和系统命令执行相关的部分。

**总结：** CVE-2024-51378是一个严重的安全漏洞，允许未经身份验证的远程攻击者执行任意命令。 漏洞利用POC已公开，CISA KEV也已经收录，利用方式简单，威胁巨大。需要尽快升级到安全版本。

**项目地址:** [qnole000/CVE-2024-51378](https://github.com/qnole000/CVE-2024-51378)

**漏洞详情:** [CVE-2024-51378](https://nvd.nist.gov/vuln/detail/CVE-2024-51378)