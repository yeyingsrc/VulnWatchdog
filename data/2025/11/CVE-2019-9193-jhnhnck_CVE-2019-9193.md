## CVE-2019-9193 - PostgreSQL 9.3-11.2 任意命令执行

**漏洞编号:** CVE-2019-9193

**漏洞类型:** 任意命令执行

**影响应用:** PostgreSQL

**危害等级:** 高危，可能导致服务器完全控制

**影响版本:** 9.3 <= version <= 11.2

**利用条件:** 需要PostgreSQL数据库的有效用户凭据（包括超级用户或属于'pg_execute_server_program'组的用户）并且启用了'COPY TO/FROM PROGRAM' 功能

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

该漏洞存在于PostgreSQL的`COPY TO/FROM PROGRAM`功能中。具有足够权限（超级用户或`pg_execute_server_program`组成员）的用户可以利用此功能执行任意操作系统命令。漏洞利用代码使用`COPY FROM PROGRAM`执行命令。该漏洞并非传统意义上的漏洞，而是PostgreSQL的预期功能，但由于其潜在的危险性，被标记为CVE。提供的POC代码通过连接到PostgreSQL数据库，检查版本是否在漏洞范围内，然后使用`COPY FROM PROGRAM`执行用户提供的命令。命令执行的结果会作为表的数据返回。

**有效性评估：**
根据漏洞信息和提供的POC代码，该POC代码是有效的。它实现了利用`COPY FROM PROGRAM`功能执行任意命令。

**投毒风险评估：**
审查提供的Python脚本 `GenPostgresRCEExploit.py` 和许可证文件 `LICENSE`，未发现明显的恶意代码或后门。脚本的目的是利用 CVE-2019-9193 执行任意命令。虽然该脚本本身具有潜在的风险，因为它允许未经授权的命令执行，但这并不意味着脚本本身包含恶意代码（投毒）。脚本代码相对清晰，主要功能是连接数据库、版本检测、执行命令和结果输出。脚本使用 `shlex.quote` 对命令进行转义，一定程度上降低了命令注入的风险。但是，使用者仍然需要注意命令的安全性，避免执行危险命令。

**利用方式分析：**
1.  攻击者需要获得PostgreSQL数据库的有效用户凭据，且该用户需要是超级用户或属于`pg_execute_server_program`组的成员。
2.  攻击者使用POC代码连接到目标PostgreSQL数据库。
3.  POC代码检查PostgreSQL的版本，确认目标是否在受影响的范围内。
4.  攻击者提供要执行的系统命令作为POC的参数。
5.  POC代码使用`COPY table_name FROM PROGRAM 'command'`语句执行该命令。该命令将在数据库服务器的操作系统上以运行PostgreSQL服务器进程的用户身份执行。
6.  命令的输出被捕获并显示给攻击者。

**注意事项：**
该漏洞的利用需要一定的权限，并且依赖于`COPY TO/FROM PROGRAM`功能的启用。在默认配置下，该功能通常是启用的。因此，在权限控制不足的情况下，该漏洞可能被滥用。

**项目地址:** [jhnhnck/CVE-2019-9193](https://github.com/jhnhnck/CVE-2019-9193)

**漏洞详情:** [CVE-2019-9193](https://nvd.nist.gov/vuln/detail/CVE-2019-9193)