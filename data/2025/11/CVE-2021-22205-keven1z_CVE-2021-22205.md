## CVE-2021-22205-GitLab-RCE

**漏洞编号:** CVE-2021-22205

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** GitLab

**危害等级:** 严重，可导致完全系统控制

**影响版本:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**利用条件:** 无需身份验证，目标GitLab实例可从网络访问

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-22205 是一个影响 GitLab CE/EE 的远程代码执行漏洞。该漏洞存在于图像文件解析过程中，由于 GitLab 没有正确验证传递给文件解析器的图像文件，导致可以执行任意命令。

**有效性：**
提供的 POC 代码有效。它利用 ExifTool 中的命令注入漏洞，通过上传特制的 DJVU 图像文件来执行任意系统命令。

**投毒风险：**
POC 代码中存在轻微的投毒风险。风险为10%。

以下是对代码中可能存在的投毒风险点的分析：

*   **硬编码的User-Agent:**  POC 使用了 `Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2227.0 Safari/537.36`。这可能是为了绕过某些简单的 WAF 规则，但也可能导致指纹识别，从而使攻击更容易被检测。虽然不算恶意，但不够灵活，可能影响利用效果。
*   **Payload定死，缺少随机性：**POC中用于触发漏洞的DJVU文件内容相对固定。虽然修改了command部分,但是如果目标系统对上传文件进行更严格的校验，这种固定的Payload可能会导致利用失败。如果payload加入随机化,对攻击更加有利。

**利用方式：**
1.  攻击者首先发送一个 GET 请求到 `/users/sign_in` 获取 CSRF token。该token用于后续的post请求的认证。
2.  攻击者构造一个恶意的 DJVU 图像文件。该图像文件在 metadata 字段中嵌入恶意命令。
3.  攻击者构造一个 multipart/form-data 请求，将恶意图像文件作为文件上传到 `/uploads/user` 路径。
4.  当 GitLab 处理上传的图像时，ExifTool 会被调用来提取图像元数据。由于图像文件中的恶意命令，ExifTool 会执行这些命令，从而导致远程代码执行。
5.  利用代码中，command变量可以定义反弹shell或者执行任意命令。

**项目地址:** [keven1z/CVE-2021-22205](https://github.com/keven1z/CVE-2021-22205)

**漏洞详情:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)