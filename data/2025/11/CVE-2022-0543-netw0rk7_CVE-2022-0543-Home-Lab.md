## CVE-2022-0543 - Redis Lua Sandbox Escape

**漏洞编号:** CVE-2022-0543

**漏洞类型:** Lua Sandbox Escape

**影响应用:** Redis (Debian Package)

**危害等级:** 高危，远程代码执行

**影响版本:** Debian/Ubuntu packages before DSA-5081-1

**利用条件:** Redis must be installed via Debian/Ubuntu package, Lua modules must be loaded dynamically, and Redis must be accessible without authentication (or attacker has credentials).

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2022-0543 是一个 Debian 特定的 Redis 远程代码执行漏洞，由不正确的 Lua 沙盒导致。Debian 包动态加载 Lua 模块，暴露了 `package.loadlib()`，允许完全逃逸沙箱并执行主机操作系统命令。 

**有效性:**
提供的 Dockerfile 通过指定 snapshot.debian.org 的历史版本，安装了受影响的 Redis 版本 (5:5.0.14-1+deb10u1)。它还安装了 `lua-cjson` 和 `lua-bitop`，这使得漏洞更容易被利用。提供的 `docker-compose.yml` 和 `entrypoint.sh` 脚本用于启动 Redis 实例，而 `redis.conf` 配置文件打开了 Redis 的网络端口，且未设置密码，使得未经身份验证的攻击成为可能。PoC 地址 `https://github.com/0x7eTeam/CVE-2022-0543` 包含利用此漏洞的代码，表明该漏洞是可以利用的。

**投毒风险:**
虽然提供的 Dockerfile 和脚本是为了复现漏洞，但仍然存在轻微的投毒风险。`entrypoint.sh` 脚本包含一个生成 flag 的函数，但这个函数本身并没有恶意。风险在于脚本中使用的命令，例如 `tr -dc 'A-Za-z0-9' </dev/urandom | head -c 8`  和  `tr -dc 'A-Za-z0-9' </dev/urandom | head -c 32`，虽然看起来无害，但如果恶意修改成可以下载并执行额外脚本，或者写入特定文件来修改系统行为，理论上存在投毒的可能。 此外，Dockerfile 通过 `apt-get install` 安装了 `vim` 和 `nano`，攻击者可能将预先配置的恶意配置文件嵌入到 docker 镜像中,虽然这种攻击的可能性较低，但是无法排除,因此给出 5% 的投毒风险。

**利用方式:**
利用方式如下：
1.  攻击者连接到未授权的 Redis 实例。
2.  攻击者使用 Lua 脚本执行 `package.loadlib()`。
3.  利用 `package.loadlib()` 加载系统库，逃逸 Lua 沙箱。
4.  执行任意系统命令，例如读取 flag 文件或其他敏感信息。
5. 攻击者也可以通过修改redis配置文件、上传恶意模块等方式实现持久化攻击。

**项目地址:** [netw0rk7/CVE-2022-0543-Home-Lab](https://github.com/netw0rk7/CVE-2022-0543-Home-Lab)

**漏洞详情:** [CVE-2022-0543](https://nvd.nist.gov/vuln/detail/CVE-2022-0543)