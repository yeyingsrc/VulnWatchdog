## CVE-2021-22205-GitLab-RCE

**漏洞编号:** CVE-2021-22205

**漏洞类型:** 远程命令执行

**影响应用:** GitLab

**危害等级:** 高危，可能导致服务器完全控制

**影响版本:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**利用条件:** 目标GitLab实例存在漏洞且可从攻击者控制的网络访问

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-22205 是一个存在于 GitLab CE/EE 中的远程命令执行漏洞。该漏洞源于 GitLab 没有正确验证传递给文件解析器的图像文件，导致远程命令执行。攻击者可以上传特制的恶意图像文件，触发 ExifTool 中的命令注入，从而在服务器上执行任意代码。

**漏洞利用方式：**

1.  攻击者向存在漏洞的 GitLab 实例上传恶意构造的 DjVu 或 JPG 图像文件。
2.  GitLab 尝试使用 ExifTool 处理该图像文件。
3.  恶意文件中的元数据（例如，Copyright 字段）包含命令注入代码。
4.  ExifTool 执行恶意代码，导致远程命令执行。

**POC有效性：**

提供的 Python 脚本 `GitLab-revshell.py` 利用了此漏洞来获得反向 shell。它首先检查 `djvumake` 是否已安装，这是一个用于创建 DjVu 文件的工具。然后，它创建一个包含嵌入式命令的 DjVu 文件，该命令将 base64 编码的反向 shell 命令解码并执行。该脚本通过上传该文件到 GitLab 实例的 `/uploads/user` 端点来触发漏洞。它使用 BeautifulSoup 从登录页面提取 CSRF token 以绕过 CSRF 保护。脚本会检查目标是否响应，并尝试发送带有恶意文件的POST请求，通过判断请求是否超时确定shell是否被成功建立。

**投毒风险：**

代码库包含三个文件：
*   `GitLab-revshell.py`: 主要的漏洞利用脚本。
*   `README.md`: 包含使用说明。
*   `shodan-scanner.py`: 使用 Shodan 查找易受攻击的 GitLab 实例的扫描器。

`shodan-scanner.py` 要求用户插入自己的 Shodan API 密钥。 该脚本的目的是扫描目标。`GitLab-revshell.py` 脚本在`/tmp`目录下创建文件，可能会造成一定程度的垃圾文件残留,但是不属于投毒行为。

 潜在投毒风险点在于，如果攻击者修改了 `GitLab-revshell.py` 脚本，添加了额外功能，例如收集目标信息并发送到外部服务器，或者在目标系统上安装后门，那么就存在投毒风险。但是从提供的脚本来看，只实现了反向shell的功能，额外的风险较低。所以投毒风险较低。

综上， 综合判断，投毒风险较低，预估为 10%。

**项目地址:** [faisalfs10x/GitLab-CVE-2021-22205-scanner](https://github.com/faisalfs10x/GitLab-CVE-2021-22205-scanner)

**漏洞详情:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)