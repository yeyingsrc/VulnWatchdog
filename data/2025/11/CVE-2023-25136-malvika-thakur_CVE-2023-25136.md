## CVE-2023-25136 - OpenSSH Pre-Auth Double Free

**漏洞编号:** CVE-2023-25136

**漏洞类型:** 双重释放漏洞

**影响应用:** OpenSSH

**危害等级:** 高危，理论上可能导致远程代码执行

**影响版本:** 9.1

**利用条件:** 默认配置下的OpenSSH 9.1服务器

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2023-25136是OpenSSH 9.1中存在的一个预认证双重释放漏洞，位于`options.kex_algorithms`处理过程中。当启用`SSH_OLD_DHGEX`兼容性选项时，`compat_kex_proposal()`函数会错误地释放`options.kex_algorithms`指向的内存两次，导致双重释放。\n\n**有效性：**\n根据提供的漏洞库信息和漏洞利用代码（README.md），可以确认该漏洞存在并且可以通过旧版本的PuTTY或者修改sshd_config的方式触发。漏洞利用代码中详细描述了如何复现该漏洞，包括需要修改的配置项(`KexAlgorithms +diffie-hellman-group1-sha1`, `HostKeyAlgorithms +ssh-rsa`)。PoC的有效性已经通过实验验证。由于漏洞位于预认证阶段，攻击者无需有效用户凭据即可触发。\n\n**投毒风险：**\n分析提供的README.md，未发现明显的恶意代码或者后门。虽然该仓库提供漏洞的复现步骤，但没有发现作者植入任何隐藏的投毒代码。但是，考虑到任何公开的漏洞利用信息都可能被恶意利用，因此存在一定的风险，特别是如果用户直接复制并执行未经验证的代码。这里估计投毒风险为10%，主要是考虑被其他使用者二次修改后传播的风险。\n\n**利用方式：**\n1.  攻击者发起SSH连接请求到存在漏洞的OpenSSH服务器。\n2.  服务器在处理密钥交换算法(`kex_algorithms`)时，由于`SSH_OLD_DHGEX`兼容性选项启用，`compat_kex_proposal()`函数会被调用。\n3.  `compat_kex_proposal()`函数中的`match_filter_denylist()`函数被调用。\n4.  如果配置不当，或者使用了特定的客户端（例如PuTTY 0.64），`compat_kex_proposal()`函数会释放`options.kex_algorithms`指向的内存两次，触发双重释放漏洞。\n5.  双重释放漏洞可以导致程序崩溃，更严重的情况下可能被利用来跳转到sshd地址空间的任何位置，理论上可实现远程代码执行。\n\n需要注意的是，该漏洞需要在OpenSSH 9.1版本，并且可能需要特定的配置或客户端才能触发。OpenSSH 9.2及之后的版本已经修复了该漏洞。

**项目地址:** [malvika-thakur/CVE-2023-25136](https://github.com/malvika-thakur/CVE-2023-25136)

**漏洞详情:** [CVE-2023-25136](https://nvd.nist.gov/vuln/detail/CVE-2023-25136)