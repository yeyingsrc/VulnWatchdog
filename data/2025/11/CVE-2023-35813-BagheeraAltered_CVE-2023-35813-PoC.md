## CVE-2023-35813-Sitecore-远程代码执行

**漏洞编号:** CVE-2023-35813

**漏洞类型:** 远程代码执行

**影响应用:** Sitecore Experience Manager/Platform/Commerce

**危害等级:** 高危，可导致完全控制受影响的Sitecore实例

**影响版本:** <= 10.3

**利用条件:** 需要网络访问Sitecore实例

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2023-35813是一个Sitecore产品的远程代码执行漏洞，影响Experience Manager、Experience Platform和Experience Commerce，版本直至10.3。

**利用方式：**

1.  **漏洞原理：** 漏洞利用了ASP.NET的TemplateParser。攻击者可以构造恶意的请求，利用`sitecore_xaml.ashx`处理程序，通过`__PARAMETERS`参数传递经过特殊编码的恶意ASP.NET代码。
2.  **POC流程：**
    *   首先，将要执行的命令（例如，使用`<x:RemotingService>`）写入`command.txt`文件。 `command.txt`文件包含一个ASP.NET页面指令，该指令注册一个`System.Runtime.Remoting.Services.RemotingService`类型的标签，该标签可用于执行代码或重定向请求。
    *   使用`command.py`脚本对`command.txt`中的内容进行URL编码，并将结果保存到`encodeout.txt`。编码方式是将非字母和非句点字符进行URL编码，并转换为大写。
    *   `exploit.py`脚本读取`encodeout.txt`中的编码后的命令，并将其作为`__PARAMETERS`参数的值，通过POST请求发送到`https://{arg}/sitecore_xaml.ashx/-/xaml/Sitecore.Xaml.Tutorials.Styles.Index`。
    *   攻击成功后，服务器会执行`command.txt`中指定的代码。
3. **有效性评估：** 根据漏洞信息和提供的POC代码，此POC代码是有效的，它可以利用 Sitecore 中的 TemplateParser 漏洞，从而执行远程代码。

**投毒风险评估：**
虽然代码的主要目的是利用漏洞，但存在潜在的投毒风险。 `command.txt`和`commandRedirect.txt`中包含可能用于重定向或执行恶意代码的ASP.NET代码。这些文件可以通过修改来执行未经授权的操作。

* command.txt 修改Context-Response-ContentType，仅仅是作为利用成功的标识。并无恶意。
* commandRedirect.txt  修改Context-Response-StatusCode和Context-Response-RedirectLocation，可以控制响应，如果RedirectLocation改成恶意的url，则存在风险。

**风险百分比：**
虽然代码本身的设计目的是为了利用漏洞，但仍然存在一定的风险，作者可能通过更改`command.txt`或`commandRedirect.txt`中的payload进行投毒。

综上所述，我评估该POC代码存在约10%的投毒风险。

**项目地址:** [BagheeraAltered/CVE-2023-35813-PoC](https://github.com/BagheeraAltered/CVE-2023-35813-PoC)

**漏洞详情:** [CVE-2023-35813](https://nvd.nist.gov/vuln/detail/CVE-2023-35813)