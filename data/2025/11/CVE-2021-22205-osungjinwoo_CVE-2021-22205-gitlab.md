## CVE-2021-22205-GitLab-远程代码执行

**漏洞编号:** CVE-2021-22205

**漏洞类型:** 远程代码执行

**影响应用:** GitLab

**危害等级:** 严重，可能导致服务器完全控制

**影响版本:** >=11.9, <13.8.8, >=13.9, <13.9.6, >=13.10, <13.10.3

**利用条件:** 无需身份验证，需要目标GitLab实例存在漏洞且可网络访问

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2021-22205是GitLab中的一个远程命令执行漏洞。该漏洞是由于GitLab没有正确验证传递给文件解析器的图像文件，导致远程命令执行。攻击者可以上传特制的图像文件，其中包含恶意ExifTool命令注入代码，当GitLab尝试处理该图像时，ExifTool会执行攻击者注入的命令。

**有效性：**

根据漏洞库信息和提供的POC代码，此漏洞利用是有效的。漏洞库信息中CVSS评分为10，属于严重级别，并且CISA KEV目录也收录了该漏洞，说明存在被利用的情况。POC代码实现了未授权情况下的RCE，利用了上传功能和ExifTool的命令注入。

**投毒风险：**

提供的漏洞利用代码本身的功能是实现漏洞利用，并没有发现明显的投毒代码。风险评估为5%，较低。

*   代码结构清晰，主要功能为构造恶意图像上传并执行命令。
*   代码中存在与DNSlog交互的部分，可以验证命令执行，但也可能被滥用。
*   总体而言，代码功能集中于漏洞利用本身，没有发现额外恶意行为。

**利用方式：**

1.  攻击者首先找到目标GitLab实例的登录页面 (`/users/sign_in`)。
2.  从登录页面的HTML源代码中提取CSRF token，用于后续的POST请求。
3.  构造一个包含恶意ExifTool命令的特制图像文件（实际上是DJVU文件）。该恶意命令被嵌入到图像的metadata中。
4.  通过向 `/uploads/user` 端点发送包含恶意图像文件的multipart/form-data POST请求，上传该图像。
5.  GitLab使用ExifTool处理上传的图像文件，ExifTool执行图像metadata中的恶意命令，导致远程代码执行。

利用代码中包含两种利用方式：

*   检查模式 (`-v true`)：通过上传包含特定DNSlog域名的恶意图片，检查目标是否存在漏洞。
*   攻击模式 (`-a true`)：允许攻击者指定要执行的命令 (`-c command`)，直接在目标服务器上执行任意命令。
*   文件模式 (`-s true`): 上传指定文件 `-f file`。

总结：攻击者通过上传精心构造的恶意图像，利用ExifTool命令注入漏洞，实现在目标GitLab服务器上执行任意代码。

**项目地址:** [osungjinwoo/CVE-2021-22205-gitlab](https://github.com/osungjinwoo/CVE-2021-22205-gitlab)

**漏洞详情:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)