## CVE-2024-31982-XWiki-RCE

**漏洞编号:** CVE-2024-31982

**漏洞类型:** 远程代码执行

**影响应用:** XWiki

**危害等级:** 高危，可能导致服务器完全控制

**影响版本:** < 14.10.20, < 15.5.4, < 15.10-rc-1 (受影响版本范围涵盖 2.4-milestone-1 及之后)

**利用条件:** 需要目标XWiki实例存在Main.DatabaseSearch页面，且未应用补丁。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2024-31982 是 XWiki Platform 中的一个远程代码执行漏洞。攻击者可以通过构造恶意的请求到 `Main.DatabaseSearch` 页面，利用 Java SSTI (Server-Side Template Injection) 注入恶意的 groovy 代码，从而实现远程代码执行。由于默认情况下，数据库搜索对所有用户（包括访客）开放，因此该漏洞的利用门槛极低。

**漏洞利用方式：**

1.  攻击者构造包含恶意 groovy 代码的 URL，例如：

    ```
    /bin/get/Main/DatabaseSearch?outputSyntax=plain&text=%7D%7D%7D%7B%7Basync%20async%3Dfalse%7D%7D%7B%7Bgroovy%7D%7Dprintln%28%22Successful%20Injection%22%29%7B%7B%2Fgroovy%7D%7D%7B%7B%2F
    ```

    其中 `%7D%7D%7D%7B%7Basync%20async%3Dfalse%7D%7D%7B%7Bgroovy%7D%7Dprintln%28%22Successful%20Injection%22%29%7B%7B%2Fgroovy%7D%7D%7B%7B%2F`  是经过 URL 编码的 payload `}}}{{async async=false}}{{groovy}}println("Successful Injection"){{/groovy}}{{/`，用于执行任意 groovy 代码。
2.  攻击者发送 GET 请求到上述 URL。
3.  如果目标 XWiki 实例存在漏洞且未打补丁，服务器将执行攻击者注入的 groovy 代码，从而实现远程代码执行。

**POC 代码有效性：**

提供的 POC 代码是一个 Python 脚本，用于检测 XWiki 实例是否存在 CVE-2024-31982 漏洞。它通过向目标 URL 发送包含恶意 groovy 代码的 GET 请求，并检查响应中是否包含 "Injection" 字符串来判断漏洞是否存在。如果存在，脚本会将漏洞 URL 写入文件 `vul_url.txt`。

**投毒风险分析：**

该 POC 脚本主要功能是发送请求并检测是否存在漏洞。主要的风险在于 `vul_url.txt` 文件，如果该文件被恶意修改，可能导致后续利用过程出现偏差或被重定向到恶意站点。该脚本中使用了代理 `http://127.0.0.1:7890`，需要注意代理服务器是否安全可信。

代码本身并没有明显的投毒行为，例如植入后门或恶意代码。文件写入函数是一个潜在的风险点，但仅限于写入检测到的URL，风险较低。使用了代理, 建议检查代理的安全性。

所以投毒的可能性较低，大概为5%。主要是依赖了用户对`new_url.txt` 和 `vul_url.txt` 文件安全性的保证。



**项目地址:** [NanoWraith/CVE-2024-31982](https://github.com/NanoWraith/CVE-2024-31982)

**漏洞详情:** [CVE-2024-31982](https://nvd.nist.gov/vuln/detail/CVE-2024-31982)