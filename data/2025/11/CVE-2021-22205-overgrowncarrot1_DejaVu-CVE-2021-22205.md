## CVE-2021-22205-GitLab-RCE

**漏洞编号:** CVE-2021-22205

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** GitLab

**危害等级:** 严重，允许未经身份验证的攻击者执行任意代码

**影响版本:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**利用条件:** 目标GitLab实例存在漏洞且可从网络访问

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2021-22205 是一个存在于 GitLab CE/EE 中的远程代码执行漏洞，影响从 11.9 开始的多个版本。该漏洞是由于 GitLab 没有正确验证传递给文件解析器的图像文件而导致的。未经身份验证的攻击者可以通过上传特制的图像文件来利用此漏洞，从而在服务器上执行任意代码。

**漏洞利用分析：**

提供的`DejaVu.sh`脚本用于利用 CVE-2021-22205。以下是脚本的工作原理：

1.  **参数处理：** 脚本接受 LHOST（攻击者监听地址）、LPORT（攻击者监听端口）和 WEBHOST（目标 GitLab 实例的 URL）作为参数。
2.  **生成恶意图像文件：** 脚本创建一个名为 `lol.jpg` 的恶意图像文件。该文件的前面部分是有效的JPEG文件，后面附加了精心构造的ExifTool命令注入有效载荷。
3.  **ExifTool 命令注入：** 漏洞的根源在于 GitLab 使用 ExifTool 处理图像元数据时存在缺陷。通过在图像元数据中插入恶意命令，攻击者可以执行任意代码。
4.  **反弹 Shell：** 该脚本使用 `mkfifo` 创建一个命名管道，然后使用 `telnet` 连接到攻击者的 LHOST 和 LPORT，并将 shell 的输入和输出重定向到该管道。这有效地在目标服务器上建立了一个反弹 shell。
5.  **上传恶意图像：** 脚本使用 `curl` 命令将 `lol.jpg` 文件上传到目标 GitLab 实例。`-F 'file=@lol.jpg'` 参数指示 `curl` 将该文件作为文件上传的一部分发送。服务器在处理上传的文件时，会调用 ExifTool 来提取元数据，从而触发命令注入漏洞。

**有效性：**

提供的POC代码是有效的。它利用了 CVE-2021-22205 中描述的漏洞，通过上传包含恶意 Exif 元数据的图像文件来执行远程代码。通过设置正确的 LHOST、LPORT 和 WEBHOST，攻击者可以在易受攻击的 GitLab 实例上获得 shell 访问权限。

**投毒风险：**

分析提供的脚本，没有发现明显的投毒代码。脚本逻辑清晰，目的是利用 CVE-2021-22205 漏洞。没有发现任何试图在受害者系统上安装后门、删除数据或执行其他恶意操作的隐藏代码。

**利用方式总结：**

1.  攻击者准备包含恶意 Exif 元数据的特制图像文件。
2.  攻击者配置 `DejaVu.sh` 脚本，提供攻击者的监听地址和端口以及目标 GitLab 实例的 URL。
3.  攻击者执行脚本，该脚本将恶意图像文件上传到 GitLab 实例。
4.  GitLab 处理上传的图像，调用 ExifTool 提取元数据。
5.  ExifTool 执行恶意元数据中包含的命令，从而在服务器上建立反弹 shell。
6.  攻击者现在可以通过反弹 shell 与 GitLab 服务器交互。

**项目地址:** [overgrowncarrot1/DejaVu-CVE-2021-22205](https://github.com/overgrowncarrot1/DejaVu-CVE-2021-22205)

**漏洞详情:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)