## CVE-2022-4361-Keycloak-XSS

**漏洞编号:** CVE-2022-4361

**漏洞类型:** XSS

**影响应用:** Keycloak

**危害等级:** 高危，允许攻击者执行恶意脚本，可能导致会话劫持、信息窃取或权限提升

**影响版本:** 受影响版本 < 21.1.2

**利用条件:** 需要能够访问Keycloak认证端点，并且目标Keycloak实例允许通配符重定向URI或未充分验证redirect_uri和AssertionConsumerServiceURL

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

该漏洞是Keycloak的SAML或OIDC提供程序中的跨站脚本（XSS）漏洞。攻击者可以通过设置AssertionConsumerServiceURL值或redirect_uri来执行恶意脚本。

**有效性分析：**
提供的Python脚本是一个PoC代码，用于利用CVE-2022-4361漏洞。它主要针对OIDC协议，构造包含JavaScript payload的`redirect_uri`参数，如果Keycloak实例允许通配符重定向URI或未充分验证该参数，则可以成功执行XSS攻击。

**投毒风险分析：**
代码主体功能是构造和发送包含恶意payload的请求，并检测目标是否允许恶意重定向。LICENSE文件为Apache 2.0许可，比较常见，投毒风险较低。脚本会打开浏览器，存在一定的风险，但是这部分行为也是为了完成漏洞的利用。
*   **风险点：**
    *   `webbrowser.open(vulnerable_keycloak_auth_URL)`：该行代码会在用户的默认浏览器中打开包含恶意payload的URL，如果payload包含恶意代码，可能会对用户造成危害。但这是XSS利用的正常行为。
*   **投毒可能性：**
代码中作者隐藏恶意代码的可能性较低，估计在5%左右，主要基于以下几点：
    *   代码量较小，逻辑简单，易于审计。
    *   代码功能明确，旨在利用已知的XSS漏洞。
    *   使用了常见的库（requests, bs4, webbrowser）。
    *   使用了Apache 2.0许可证，相对开源透明。

**利用方式：**
1.  **确定目标Keycloak认证端点：** 攻击者需要确定Keycloak的认证端点URL，通常可以通过分析目标Web应用的认证流程或查看Keycloak的配置文件来获取。
2.  **构造恶意URL：** 攻击者使用PoC脚本，指定目标URL，构造包含恶意JavaScript payload的`redirect_uri`参数的URL。
3.  **发送恶意请求：** 攻击者将构造的URL发送给用户或直接通过浏览器访问。
4.  **触发XSS：** 如果Keycloak实例允许通配符重定向URI或未充分验证`redirect_uri`参数，则会执行恶意JavaScript代码。
5.  **获取敏感信息或执行恶意操作：** 攻击者利用XSS漏洞，可以获取用户的Cookie、会话信息或其他敏感数据，或者在用户的浏览器中执行恶意操作，例如重定向到钓鱼网站或执行恶意代码。

**项目地址:** [faccimatteo/CVE-2022-4361](https://github.com/faccimatteo/CVE-2022-4361)

**漏洞详情:** [CVE-2022-4361](https://nvd.nist.gov/vuln/detail/CVE-2022-4361)