## CVE-2018-15133-Laravel框架-反序列化远程代码执行

**漏洞编号:** CVE-2018-15133

**漏洞类型:** 反序列化远程代码执行

**影响应用:** Laravel Framework

**危害等级:** 高危，可能导致远程代码执行

**影响版本:** <= 5.5.40, 5.6.x <= 5.6.29

**利用条件:** 需要知道APP_KEY，通过X-XSRF-TOKEN传递恶意payload。

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

CVE-2018-15133漏洞存在于Laravel Framework的5.5.40及之前版本，以及5.6.x到5.6.29版本。该漏洞是由于对X-XSRF-TOKEN值进行unserialize调用时，未对数据进行充分验证，导致远程代码执行。攻击者需要知道APP_KEY才能成功利用此漏洞。这个APP_KEY通常不会被泄露，但如果攻击者之前拥有特权访问权限或成功完成了之前的攻击，则可能发生。

**漏洞利用方式：**

1.  攻击者获取Laravel应用的APP_KEY（例如，通过源代码泄露、环境变量泄露等）。
2.  攻击者使用phpggc生成包含恶意代码的PHP序列化payload。POC中使用了`Laravel/RCE5` gadget chain，该gadget chain允许执行任意系统命令。
3.  攻击者使用APP_KEY加密该payload，并将其设置为X-XSRF-TOKEN cookie的值。
4.  攻击者向目标Laravel应用发送包含该cookie的HTTP请求。
5.  Laravel应用解密cookie值，然后反序列化payload，执行恶意代码。

**漏洞利用有效性：**

提供的PoC代码是有效的，因为它实现了上述漏洞利用过程。该脚本使用phpggc生成payload，然后使用APP_KEY对其进行加密，并发送包含该加密payload的HTTP请求。

**投毒风险：**

该代码的投毒风险极低。原因如下：

*   代码量较少，逻辑清晰，主要功能是利用已知的反序列化漏洞。
*   代码使用了subprocess调用外部程序phpggc，如果phpggc本身被篡改，则可能引入风险，但该风险不在本代码的范围内。
*   代码中没有发现任何尝试连接外部服务器或执行其他恶意操作的迹象。
*  由于脚本依赖phpggc来生成payload, 因此如果phpggc被替换成了恶意版本,可能会存在被投毒的风险. 但本脚本本身只是对phpggc的调用,不具备投毒的特性. 如果不考虑第三方依赖的风险, 代码投毒风险评估为1%.

**项目地址:** [Loaxert/CVE-2018-15133-PoC](https://github.com/Loaxert/CVE-2018-15133-PoC)

**漏洞详情:** [CVE-2018-15133](https://nvd.nist.gov/vuln/detail/CVE-2018-15133)