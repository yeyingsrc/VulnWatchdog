## CVE-2021-22205-GitLab-RCE

**漏洞编号:** CVE-2021-22205

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** GitLab

**危害等级:** 高危，未经身份验证的远程代码执行

**影响版本:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**利用条件:** 目标GitLab实例需要位于受影响的版本范围内，并且可以通过网络访问。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-22205 是一个存在于 GitLab CE/EE 中的远程代码执行漏洞。该漏洞源于 GitLab 没有正确验证传递给文件解析器的图像文件。攻击者可以通过上传特制的图像文件（利用 ExifTool 的命令注入漏洞）来执行任意代码。

**有效性：**
根据漏洞库信息和提供的漏洞利用代码，该漏洞是有效的，并且已被公开利用。CISA 已将其添加到已知被利用的漏洞目录中。

**投毒风险：**
提供的 Python 脚本 `22205exp.py` 包含漏洞验证和利用代码。 该脚本利用 `dnslog.cn` 来验证命令执行。 虽然 `dnslog.cn` 是一种常见的漏洞验证方法，但如果攻击者控制 `dnslog.cn`，则存在一定的投毒风险，他们可以记录漏洞利用信息。 同时，脚本中使用了硬编码的User-Agent和Content-Type，这增加了脚本被识别和防御的可能性。如果攻击者修改这些参数，可能会增加攻击的成功率，但也可能被视为潜在的恶意行为。 此外，该脚本依赖于 `beautifulsoup4` 和 `requests` 库。 如果这些库被恶意篡改，可能会导致投毒。 综合来看，脚本本身包含直接的后门代码的可能性较低，但间接投毒风险（如依赖库或验证平台被控制）仍然存在，因此投毒风险大约为10%。

**利用方式：**
1.  **获取 CSRF Token：** 脚本首先访问 `/users/sign_in` 页面，使用 `BeautifulSoup` 解析 HTML，提取 CSRF token。
2.  **构造恶意图像文件：** 脚本构造一个包含恶意 ExifTool 命令的 DJVU 格式图像文件。该命令通常用于执行任意系统命令，例如通过 `curl` 将服务器信息发送到攻击者的 DNS 服务器。
3.  **上传恶意图像文件：** 脚本使用包含恶意图像文件和 CSRF token 的 `multipart/form-data` 请求，将文件上传到 `/uploads/user` 端点。
4.  **触发命令执行：** GitLab 尝试使用 ExifTool 处理该图像，由于文件内容没有经过充分验证，导致 ExifTool 执行嵌入在图像文件中的恶意命令。
5.  **验证漏洞：** 脚本通过查询 `dnslog.cn` 来确认命令是否成功执行。

总的来说，该漏洞利用的有效性较高，但需要注意潜在的投毒风险。利用方式相对简单，可以通过上传特制的图像文件来实现远程代码执行。

**项目地址:** [hhhotdrink/CVE-2021-22205](https://github.com/hhhotdrink/CVE-2021-22205)

**漏洞详情:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)