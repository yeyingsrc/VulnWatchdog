## CVE-2022-40684 - Fortinet Authentication Bypass

**漏洞编号:** CVE-2022-40684

**漏洞类型:** 身份验证绕过

**影响应用:** FortiOS, FortiProxy, FortiSwitchManager

**危害等级:** 高危，未经身份验证的攻击者可以对管理界面执行操作，可能导致完全控制系统

**影响版本:** FortiOS 7.2.0-7.2.1, 7.0.0-7.0.6; FortiProxy 7.2.0, 7.0.0-7.0.6; FortiSwitchManager 7.2.0, 7.0.0

**利用条件:** 需要网络访问目标设备的管理界面

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2022-40684 是 Fortinet 产品中的一个身份验证绕过漏洞。未经身份验证的攻击者可以通过发送特制的 HTTP 或 HTTPS 请求到管理界面来绕过身份验证。漏洞存在于FortiOS 7.2.0到7.2.1和7.0.0到7.0.6，FortiProxy 7.2.0和7.0.0到7.0.6，FortiSwitchManager 7.2.0和7.0.0。根据漏洞描述，攻击者可以通过构造包含`forwarded`和`x-forwarded-vdom`头的HTTP请求，利用备用路径或通道绕过身份验证检查。

**有效性：**
提供的PoC代码（`exploit.py`和`CVE-2022-40684.yaml`）是有效的。`exploit.py` 脚本使用 `requests` 库发送带有特定 headers 的 HTTP GET 请求到目标设备的 `/api/v2/cmdb/system/admin` 和 `/api/v2/cmdb/user/ldap` 接口，从而绕过身份验证并获取敏感信息，例如管理员用户名、访问级别、序列号、版本信息以及 LDAP 配置。`CVE-2022-40684.yaml` 是一个 Nuclei 模板，用于自动化漏洞检测过程，本质上执行相同的 HTTP 请求。

**投毒风险：**
检查了提供的 PoC 代码，虽然该脚本的目的是为了演示漏洞利用，并且确实可以提取敏感信息，但是发现了如下潜在投毒风险点：

1.  `Host` header 被硬编码为 `127.0.0.1:9980`，这可能会导致一些网络配置不当的设备将请求发送到错误的目标。
2.  `forwarded` header 模拟从 `127.0.0.1` 发出的请求，这在某些复杂的网络环境中可能会导致意想不到的副作用。
3.  脚本缺少错误处理，例如，如果目标设备不存在或无法访问，脚本可能会崩溃，而不是优雅地退出。
4. 脚本泄露LDAP配置信息，可能导致连接到恶意LDAP服务器。

这些风险点并非明显的后门，但可能导致某些情况下利用失败或产生其他问题。因此，将投毒风险评估为10%。

**利用方式：**
1.  攻击者使用PoC脚本或Nuclei模板，向目标Fortinet设备的管理界面发送特制的HTTP GET请求。
2.  请求包含精心构造的`forwarded`和`x-forwarded-vdom` headers，绕过身份验证检查。
3.  服务器错误地处理这些headers，允许未经验证的请求访问受保护的API接口。
4.  攻击者从而获取管理员用户名、访问级别、设备序列号、版本信息和LDAP配置等敏感信息。

**项目地址:** [carlosevieira/CVE-2022-40684](https://github.com/carlosevieira/CVE-2022-40684)

**漏洞详情:** [CVE-2022-40684](https://nvd.nist.gov/vuln/detail/CVE-2022-40684)