## CVE-2022-40684-Fortinet身份验证绕过

**漏洞编号:** CVE-2022-40684

**漏洞类型:** 身份验证绕过

**影响应用:** FortiOS, FortiProxy, FortiSwitchManager

**危害等级:** 严重，未经身份验证的攻击者可以执行管理操作

**影响版本:** FortiOS 7.2.0 through 7.2.1, 7.0.0 through 7.0.6; FortiProxy 7.2.0, 7.0.0 through 7.0.6; FortiSwitchManager 7.2.0, 7.0.0

**利用条件:** 目标存在于受影响的版本范围内，且可以通过HTTP/HTTPS访问管理界面。

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2022-40684 是 Fortinet FortiOS、FortiProxy 和 FortiSwitchManager 中的一个身份验证绕过漏洞。未经身份验证的攻击者可以通过构造特制的 HTTP 或 HTTPS 请求在管理界面上执行操作。根据提供的漏洞库信息，该漏洞的CVSS v3.1评分为9.8（严重），漏洞利用代码成熟度为“功能性”，已被CISA添加到已知被利用的漏洞目录中。

漏洞利用代码 (CVE-2022-40684.rs) 使用 Rust 编写，功能是向目标 Fortinet 设备的特定 API 端点 ( `/api/v2/cmdb/system/admin/{username}` ) 发送 PUT 请求，以添加用户的 SSH 公钥。它通过以下步骤利用该漏洞：

1.  **获取参数：** 使用 `structopt` crate 解析命令行参数，包括目标 IP 地址、用户名和 SSH 密钥文件。
2.  **读取 SSH 密钥：** 从指定的文件中读取 SSH 公钥。
3.  **构造 HTTP 请求：** 创建一个 `reqwest` HTTP 客户端，并构建一个 PUT 请求，该请求包含一个 JSON payload，其中包含要添加的 SSH 公钥。
4.  **设置请求头：** 设置 `User-Agent` 和 `Forwarded` 请求头。`Forwarded` 头是漏洞利用的关键，攻击者利用该头绕过身份验证。
5.  **发送请求：** 将请求发送到目标设备的 API 端点。
6.  **检查响应：** 检查响应内容是否包含字符串 “SSH key is good”，以确定是否成功添加了 SSH 密钥。

**有效性评估：**

该漏洞利用代码通过构造包含特定 `Forwarded` 头的HTTP请求来绕过身份验证，利用了备用路径或通道中的身份验证缺陷。根据漏洞信息和漏洞利用代码，该利用方式是有效的，未经授权的攻击者可以通过该方法控制受影响的Fortinet设备。

**投毒风险评估：**

提供的 Rust 代码段没有明显的投毒风险。它执行的操作是明确的，即读取 SSH 密钥文件并将其添加到指定用户的帐户中。代码没有尝试执行任何其他恶意操作，例如下载或执行任意代码，或者修改系统文件。因此，投毒风险评估为 0%。

**漏洞利用方式总结：**

该漏洞利用方式基于向目标 Fortinet 设备的管理 API 发送带有特定 `Forwarded` 标头的特制 HTTP/HTTPS 请求。此标头允许攻击者绕过身份验证并执行管理操作，例如添加 SSH 密钥，从而获得对设备的未授权访问。攻击者需要知道目标设备的 IP 地址以及要添加 SSH 密钥的用户名。


**项目地址:** [notareaperbutDR34P3r/CVE-2022-40684-Rust](https://github.com/notareaperbutDR34P3r/CVE-2022-40684-Rust)

**漏洞详情:** [CVE-2022-40684](https://nvd.nist.gov/vuln/detail/CVE-2022-40684)