## CVE-2021-22205-GitLab-RCE

**漏洞编号:** CVE-2021-22205

**漏洞类型:** 远程代码执行 (RCE)

**影响应用:** GitLab

**危害等级:** 严重，可能导致服务器完全控制

**影响版本:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**利用条件:** 无需身份验证，需要能够上传图片

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2021-22205 漏洞是 GitLab CE/EE 中存在的一个远程命令执行漏洞。该漏洞源于 GitLab 未能正确验证传递给文件解析器的图像文件，导致攻击者可以通过上传特制的图像文件来执行任意命令。

**有效性:**

根据漏洞库信息和漏洞利用代码，该漏洞的PoC代码是有效的。漏洞库信息指出该漏洞的影响是远程命令执行，CVSS评分为10分（CRITICAL），表明该漏洞的严重性很高。提供的漏洞利用代码（`exploit.py`）通过上传特制的DJVU图像文件，利用ExifTool的漏洞（实际上是 CVE-2021-22204，ExifTool 本身的漏洞），在服务器上执行任意命令。`scan` 函数用于检测目标是否易受攻击，`attack` 函数用于执行命令。

**投毒风险:**

分析提供的漏洞利用代码，并未发现明显的投毒代码。`exploit.py` 主要功能是：

1.  获取 GitLab 的 CSRF token。
2.  构造包含恶意 Exif 元数据的 DJVU 图像文件。
3.  向 GitLab 的 `/uploads/user` 端点发送包含恶意图像的 POST 请求。
4.  如果响应包含 “Failed to process image”，则认为目标存在漏洞。

攻击函数执行过程与检测函数类似,只不过是构造的payload不同,用于执行命令。
整个流程是标准的漏洞利用方式，没有发现植入后门或者恶意代码的迹象。因此，投毒风险较低。

**利用方式:**

1.  攻击者首先需要找到一个存在漏洞的 GitLab 实例。
2.  攻击者使用提供的 `exploit.py` 脚本，指定目标 GitLab URL 和要执行的命令。
3.  脚本会自动获取 CSRF token，构造恶意 DJVU 图像，并上传到 GitLab 服务器。
4.  GitLab 服务器使用 ExifTool 处理该图像时，由于 ExifTool 存在 CVE-2021-22204 漏洞，会导致执行攻击者预设的命令。
5.  命令执行的结果可以通过 DNS 查询或者其他方式返回给攻击者。

简而言之，利用方式是：**上传恶意构造的DJVU文件 -> 触发ExifTool解析 -> ExifTool命令注入 -> 执行任意代码**

**项目地址:** [runsel/GitLab-CVE-2021-22205-](https://github.com/runsel/GitLab-CVE-2021-22205-)

**漏洞详情:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)