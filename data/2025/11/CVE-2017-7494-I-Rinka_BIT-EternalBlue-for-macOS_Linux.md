## CVE-2017-7494 Samba 远程代码执行

**漏洞编号:** CVE-2017-7494

**漏洞类型:** 远程代码执行

**影响应用:** Samba

**危害等级:** 高危，允许恶意客户端上传共享库并执行

**影响版本:** 3.5.0 <= version < 4.6.4, 4.5.10, 4.4.14

**利用条件:** 可写共享目录

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2017-7494是Samba的一个远程代码执行漏洞，允许恶意客户端上传一个共享库到可写的共享目录，然后让服务器加载并执行它。

**漏洞利用方式：**

1.  **找到可写共享目录：** 攻击者首先需要找到目标Samba服务器上一个可写的共享目录。如果没有配置不当或者权限控制不严，攻击就无法进行。
2.  **上传恶意共享库：** 攻击者编译一个包含恶意代码的共享库（.so文件），并将其上传到可写共享目录中。`Makefile` 提供了一个编译 `payload.so` 的方法。
3.  **触发加载执行：**  攻击者通过精心构造的SMB请求，诱使Samba服务器加载并执行上传的恶意共享库。这通常涉及到利用`smb_probe_module` 函数，该函数存在漏洞，允许加载任意模块。`exploit.py`脚本实现了发送恶意的SMB请求的部分。
4.  **反弹shell:**  `payload.c`的内容没有提供，但是从`exploit.py`的用法中可以看出，payload会被配置为反弹shell到攻击者的机器。`exploit.py` 使用 `-lhost` 参数指定反弹shell的地址。

**有效性：**

提供的POC代码看起来是有效的。漏洞库信息表明存在公开的漏洞利用代码，并且存在可用的 Metasploit 模块和其他漏洞利用程序。POC代码包含生成恶意共享库的Makefile和一个用于触发漏洞的Python脚本（`exploit.py`）。README文件也提供了使用说明。

**投毒风险：**

存在一定的投毒风险，约为10%。
*   **依赖安装脚本：** `install_requirement.sh` 脚本自动安装依赖，如果脚本中的源被篡改，可能引入恶意依赖。
*   **修改的impacket包：** POC代码要求使用修改过的`impacket`包。虽然作者解释说这是为了构造有效的请求，但修改过的包始终存在潜在风险。如果修改引入了后门，可能导致更严重的后果。 但从代码分析来看，修改是为了兼容性，风险较低。
*   **Payload不确定性：** `payload.c` 没有提供，攻击者需要自行编写payload。 如果payload源不安全，存在被植入恶意代码的风险，但这个属于使用者自身的问题，而非项目本身的投毒。

总的来说，虽然POC代码看起来可以工作，但用户应该仔细审查`install_requirement.sh`脚本和修改过的`impacket`包，确保没有恶意代码。并且需要自己编译payload.c， 需要确保编译的源安全。


**项目地址:** [I-Rinka/BIT-EternalBlue-for-macOS_Linux](https://github.com/I-Rinka/BIT-EternalBlue-for-macOS_Linux)

**漏洞详情:** [CVE-2017-7494](https://nvd.nist.gov/vuln/detail/CVE-2017-7494)