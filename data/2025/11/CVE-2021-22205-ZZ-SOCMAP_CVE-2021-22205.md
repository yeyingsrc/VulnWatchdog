## CVE-2021-22205-GitLab-RCE

**漏洞编号:** CVE-2021-22205

**漏洞类型:** 远程代码执行

**影响应用:** GitLab

**危害等级:** 严重，可能导致完全控制GitLab服务器

**影响版本:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**利用条件:** 无需身份验证，只需网络访问即可

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2021-22205 是一个存在于 GitLab CE/EE 中的远程代码执行漏洞。该漏洞源于 GitLab 未能正确验证传递给文件解析器的图像文件，从而导致远程命令执行。攻击者可以上传特制的图像文件（例如，包含恶意 ExifTool 元数据的 DJVU 文件），当 GitLab 尝试处理该文件时，ExifTool 会执行嵌入的恶意命令。 

**有效性：**
提供的POC代码是有效的，因为它实现了漏洞利用所需的步骤：

1.  构造包含恶意元数据的图像文件（DJVU 格式）。 元数据中嵌入了执行命令的 payload。 具体的payload在 `rce_payload` 函数中构造, 使用了 `qx{}` 包裹命令。
2.  创建项目，获取`csrf_token`，和`_gitlab_session`。
3.  上传恶意图像文件到新项目的snippet，触发漏洞。

**投毒风险：**
POC代码存在一定的投毒风险，大约为10%。虽然主要目的是利用漏洞，但需要注意以下几点：

*   **dnslog.cn:** 代码中使用 `whoami`.q3ddlk.dnslog.cn 域名进行命令执行结果的回传。攻击者可以通过修改该域名来收集受害者的信息，从而进行进一步的攻击。虽然在测试中这方便了漏洞验证，但在实际攻击中，恶意域名可能被用于更隐蔽的目的，如C2通信。

**利用方式：**
利用方式可以总结如下：

1.  **漏洞发现：** GitLab 未正确验证上传的图像文件，导致 ExifTool 在处理图像时执行任意命令。
2.  **Payload 构造：** 攻击者构造包含恶意 ExifTool 元数据的 DJVU 图像文件。该元数据包含要执行的命令。
3.  **文件上传：** 攻击者上传恶意图像文件到 GitLab，通常是通过项目创建，或者上传到 Issue 或 Merge Request 中。
4.  **命令执行：** 当 GitLab 尝试处理上传的图像文件时，ExifTool 执行嵌入的命令。利用代码创建项目，并获取创建snippet的token，最后上传文件触发。
5.  **RCE：** 成功利用该漏洞，攻击者可以在 GitLab 服务器上执行任意命令，从而实现远程代码执行。

**项目地址:** [ZZ-SOCMAP/CVE-2021-22205](https://github.com/ZZ-SOCMAP/CVE-2021-22205)

**漏洞详情:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)