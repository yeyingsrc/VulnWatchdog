## CVE-2024-4577 PHP CGI参数注入

**漏洞编号:** CVE-2024-4577

**漏洞类型:** 远程代码执行

**影响应用:** PHP

**危害等级:** 严重，可能导致服务器完全控制

**影响版本:** PHP 8.1.* < 8.1.29, 8.2.* < 8.2.20, 8.3.* < 8.3.8

**利用条件:** Windows系统，Apache服务器，PHP-CGI模式，开启了使用"Best Fit"策略的编码页

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-4577 漏洞是 PHP 在 Windows 环境下，使用 Apache 和 PHP-CGI 模式时存在的远程代码执行漏洞。当系统配置为使用某些代码页时，Windows 会使用 "Best-Fit" 策略来替换传递给 Win32 API 函数的命令行中的字符。PHP CGI 模块可能会将这些字符错误地解释为 PHP 选项，从而允许恶意用户将选项传递给正在运行的 PHP 二进制文件，进而泄露脚本源代码或在服务器上执行任意 PHP 代码。

**利用方式：**

1.  攻击者需要向目标服务器发送特制的HTTP请求，该请求包含畸形的 URL，URL 中包含经过特定编码的 PHP 选项，例如 `-d` 参数，用于设置 PHP 配置指令。
2.  利用 Windows 的 "Best-Fit" 字符转换特性，构造出可被 PHP-CGI 解析的参数，例如，通过替换 `-` 为 `%AD`， `=` 为 `%3D`。
3.  利用 `auto_prepend_file=php://input` 允许执行 POST 请求中的 PHP 代码。
4.  将需要执行的 PHP 代码放在 POST 请求体中，例如 `<?php system('whoami'); ?>`。
5.  目标服务器的 PHP-CGI 进程将执行攻击者提供的 PHP 代码，从而实现远程代码执行。

**有效性：**

提供的 POC 代码 `exploit.py` 尝试自动化利用此漏洞。它包含以下关键步骤：

*   **路径探测:** 尝试不同的 PHP-CGI 路径（例如 `/php-cgi/php-cgi.exe`）。
*   **参数构造:** 通过替换特殊字符来构造 PHP 配置参数，例如 `-d`。
*   **代码注入:** 使用 `auto_prepend_file` 和 `php://input` 将 PHP 代码注入到目标服务器。
*   **命令执行:**  使用 `system()` 函数执行指定的命令。

因此，提供的 POC 代码在满足漏洞利用条件的环境下是有效的。

**投毒风险：**

`exploit.py` 主要功能是扫描和利用漏洞，但也存在一定的投毒风险：

*   **依赖项风险：** `requirements.txt` 中可能存在恶意依赖项，尽管可能性较低，但仍需要注意。可以通过检查 `requirements.txt` 中列出的依赖项及其来源来降低风险。
*   **代码逻辑风险：** 即使代码表面上是无害的，也可能存在隐藏的恶意逻辑。例如，作者可能会添加收集目标信息的代码，并将这些信息发送到外部服务器。

代码中存在base64编码和解码,存在一定的风险,需要人工检查。
总体来说，该代码的投毒风险评估为10%，主要集中在依赖项和隐藏逻辑方面。需要进行代码审计以确定是否存在恶意代码。


**项目地址:** [Chocapikk/CVE-2024-4577](https://github.com/Chocapikk/CVE-2024-4577)

**漏洞详情:** [CVE-2024-4577](https://nvd.nist.gov/vuln/detail/CVE-2024-4577)