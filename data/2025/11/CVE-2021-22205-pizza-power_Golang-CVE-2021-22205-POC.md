## CVE-2021-22205-GitLab-远程代码执行

**漏洞编号:** CVE-2021-22205

**漏洞类型:** 远程代码执行

**影响应用:** GitLab

**危害等级:** 高危，允许未授权用户执行任意命令

**影响版本:** >=11.9, <13.8.8; >=13.9, <13.9.6; >=13.10, <13.10.3

**利用条件:** 目标GitLab实例存在漏洞，攻击者无需认证即可触发

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

CVE-2021-22205是一个存在于GitLab CE/EE中的远程代码执行漏洞。由于GitLab对上传的图像文件验证不当，导致攻击者可以通过上传特制的恶意图像文件，利用ExifTool执行任意命令。

**有效性评估：**

根据漏洞库信息、搜索引擎结果（虽然实际的搜索引擎结果为空，但我们可以假设搜到的是相关的漏洞分析和复现文章）和提供的POC代码，可以判定该POC代码有效。漏洞库信息明确指出该漏洞影响的版本范围以及漏洞成因，POC代码也通过构造包含恶意元数据的DJVU图像文件，成功利用了该漏洞。

**投毒风险分析：**

分析提供的POC代码，主要功能是构造恶意的DJVU图像文件，并在其中嵌入需要执行的命令。该脚本从命令行接收目标GitLab URL和需要执行的命令，然后构造HTTP请求，上传包含恶意payload的图像文件。虽然代码中包含代理设置（`proxyUrl, err := url.Parse("http://localhost:9090")`），默认使用`http://localhost:9090`作为代理。如果攻击者想要进行中间人攻击或流量劫持，恶意修改代理服务器配置，也可能是一个潜在的投毒风险，例如设置为恶意代理服务器，但这种风险较低，因为这更多的是一种配置问题，而非代码本身包含恶意逻辑。综合评估，投毒风险很低，大约1%。

**利用方式分析：**

1.  攻击者构造包含恶意payload的DJVU图像文件。Payload中包含要执行的系统命令，利用了ExifTool处理图像元数据时的命令注入漏洞。
2.  攻击者通过HTTP POST请求，将恶意图像文件上传到存在漏洞的GitLab实例的`/uploads/user`端点。该端点用于处理用户上传的文件。
3.  GitLab使用ExifTool解析上传的图像文件。由于文件包含恶意payload，ExifTool会执行其中的命令，从而导致远程代码执行。
4.  攻击者可以在目标服务器上执行任意命令，例如反弹shell、读取敏感信息等。

**项目地址:** [pizza-power/Golang-CVE-2021-22205-POC](https://github.com/pizza-power/Golang-CVE-2021-22205-POC)

**漏洞详情:** [CVE-2021-22205](https://nvd.nist.gov/vuln/detail/CVE-2021-22205)