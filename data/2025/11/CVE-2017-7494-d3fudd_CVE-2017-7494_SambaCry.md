## CVE-2017-7494 SambaCry

**漏洞编号:** CVE-2017-7494

**漏洞类型:** 远程代码执行

**影响应用:** Samba

**危害等级:** 高危，允许恶意客户端上传共享库到可写共享目录，并导致服务器加载和执行它，从而实现远程代码执行。

**影响版本:** 3.5.0 <= Samba < 4.6.4, 4.5.10, 4.4.14

**利用条件:** 需要目标Samba服务器存在可写共享目录，并且攻击者能够访问该共享目录。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2017-7494，也被称为SambaCry，是一个存在于Samba服务中的远程代码执行漏洞。该漏洞允许攻击者通过上传一个恶意的共享库到Samba服务器的可写共享目录，然后诱使服务器加载并执行该恶意库，从而获得服务器的控制权。

**利用方式：**

1.  **查找可写共享：** 使用`smbclient -L`命令或者其他工具查找目标Samba服务器上的可写共享目录。
2.  **上传恶意共享库：** 将编译好的恶意共享库（`libbindshell-samba.so`）上传到找到的可写共享目录中。
3.  **触发漏洞：** 通过构造一个特殊的请求，诱使Samba服务器加载并执行上传的恶意共享库。这个请求可以通过`python2 exploit.py -t target_ip -m path_absoluto_server_side`命令来发送，其中`target_ip`是目标Samba服务器的IP地址，`path_absoluto_server_side`是恶意共享库在服务器上的绝对路径。
4.  **连接到反弹Shell：** 恶意共享库执行后，会在目标Samba服务器上启动一个反弹shell，攻击者可以通过`nc -vn target_ip 6699`命令连接到该反弹shell。

**关于投毒风险：**

提供的漏洞利用代码主要包含三个文件：

*   `README.md`: 包含漏洞说明和利用步骤。
*   `bindshell-samba.c`: 包含生成反弹shell的代码。这段代码本身实现了在目标机器上监听端口，并在连接时执行`/bin/sh`，创建一个反弹shell。
*   `exploit.py`: 包含触发漏洞的代码。此脚本用于发送恶意请求，促使Samba加载恶意的`.so`文件。

**潜在的投毒点分析：**

1.  `bindshell-samba.c`中，`execve("/bin/sh", NULL, NULL)`这行代码可能会被修改为执行其他恶意程序。虽然当前代码是启动一个shell，但如果被替换为执行其他恶意指令，就可能存在投毒行为。
2.  `exploit.py`脚本理论上可以修改，指向错误的模块路径，或者执行某些并非用户预期的操作，但是主要功能依然是触发漏洞。

因此，需要仔细检查`bindshell-samba.c`中的`execve`函数，确保其执行的是预期的操作。`exploit.py`脚本也需要检查，确保其没有被篡改。

综上所述，尽管提供的代码主要功能是实现漏洞利用，但仍然存在一定的投毒风险，尤其是如果`bindshell-samba.c`中的`execve`函数被修改，风险概率约为10%。

**项目地址:** [d3fudd/CVE-2017-7494_SambaCry](https://github.com/d3fudd/CVE-2017-7494_SambaCry)

**漏洞详情:** [CVE-2017-7494](https://nvd.nist.gov/vuln/detail/CVE-2017-7494)