## CVE-2024-0670-Checkmk-Windows Agent权限提升

**漏洞编号:** CVE-2024-0670

**漏洞类型:** 权限提升

**影响应用:** Checkmk Windows Agent

**危害等级:** 高危，本地权限提升至SYSTEM

**影响版本:** < 2.2.0p23, < 2.1.0p40, <= 2.0.0p39

**利用条件:** 本地用户权限，可写入C:\Windows\Temp目录

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2024-0670 存在于Checkmk Windows Agent中，是由于 Agent 在 C:\Windows\Temp 目录下创建和执行临时文件的方式导致的。攻击者可以通过预先在 C:\Windows\Temp 目录中放置恶意文件并将其设置为只读，当 Agent 尝试创建同名临时文件时，会因无法覆盖而执行已存在的只读恶意文件，从而以 SYSTEM 权限执行任意命令，实现本地权限提升。

**漏洞利用方式：**

1.  **查找Check MK安装程序：** PoC脚本首先通过查询注册表定位Check MK的安装程序（MSI）。
2.  **创建恶意.cmd文件：**  脚本在 `C:\Windows\Temp` 目录下创建大量以 `cmk_all_$($i)_$($c).cmd` 命名的.cmd文件，并将指定的命令写入这些文件，然后将这些文件设置为只读属性。`$Cmd`变量控制执行的命令。
3.  **触发MSI重新安装：** PoC脚本通过`msiexec.exe /fa`重新安装Check MK的MSI包，这将触发Check MK尝试创建临时文件，由于已经存在同名只读文件，Check MK将会执行攻击者预先放置的恶意.cmd文件，从而实现权限提升。

**有效性：**

提供的PoC代码是有效的。从README.md文件内容、PowerShell脚本以及示例执行结果可以看出，该PoC已经成功地实现了权限提升，证明漏洞真实存在且PoC可用。

**投毒风险：**

经过分析，该PoC脚本本身不存在明显的投毒代码。该脚本的行为是明确的，即在 C:\Windows\Temp 目录下创建大量只读的 .cmd 文件，然后利用 msiexec 触发 Check MK 重新安装，从而执行预先放置的恶意 .cmd 文件。脚本的功能在于利用 Check MK 的漏洞来实现权限提升，而没有发现作者有意隐藏的恶意行为。因此，投毒风险评估为 0%。

**项目地址:** [magicrc/CVE-2024-0670](https://github.com/magicrc/CVE-2024-0670)

**漏洞详情:** [CVE-2024-0670](https://nvd.nist.gov/vuln/detail/CVE-2024-0670)