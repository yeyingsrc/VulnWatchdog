## CVE-2024-7387-Openshift Builder-命令注入

**漏洞编号:** CVE-2024-7387

**漏洞类型:** 命令注入

**影响应用:** Openshift Builder

**危害等级:** 高危，可导致主机权限提升和完全控制

**影响版本:** Openshift Container Platform 4.12, 4.13, 4.14, 4.15, 4.16, 4.17 (受影响版本详见漏洞库信息)

**利用条件:** 需要高权限用户（HIGH privilegesRequired）在Openshift集群上创建BuildConfig

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-7387 存在于 Openshift 的 Docker build 策略中。攻击者可以通过路径遍历，利用 `BuildConfig` 定义中的 `spec.source.secrets.secret.destinationDir` 属性，将恶意 secret 挂载到指向 `/usr/bin` 的符号链接，从而覆盖系统二进制文件，例如 `cp`。当 Openshift 在构建过程中使用这些被篡改的二进制文件时，它会以 root 权限执行任意代码，从而实现对宿主机的完全控制。

**利用方式：**

1.  **创建恶意 Secret：** 创建一个包含恶意 bash 脚本的 Secret，该脚本将 SSH 公钥添加到宿主机上的 core 用户的 `authorized_keys` 文件中。这个 Secret 的 key 被命名为 `cp`，用于覆盖 `/usr/bin/cp` 命令。
2.  **创建触发 Secret：** 创建一个用于触发构建过程的Secret。
3.  **创建恶意 BuildConfig：** 创建一个 BuildConfig，使用 Docker 策略，并配置 `spec.source.secrets` 来挂载恶意 Secret 和触发 Secret。`destinationDir` 设置为 `usr_bin`，这是一个指向 `/usr/bin` 的符号链接。这样会将恶意 Secret 中的 `cp` 文件覆盖 `/usr/bin/cp`。
4.  **启动构建：** 启动 BuildConfig，触发构建过程。由于 `/usr/bin/cp` 已经被恶意脚本覆盖，当 Openshift 在构建过程中使用 `cp` 命令时，会执行恶意脚本，将 SSH 公钥添加到宿主机，从而获得 SSH 访问权限。
5.  **SSH 登录：** 使用私钥通过 SSH 登录到宿主机。

**投毒风险分析：**

虽然提供的 POC 代码主要用于演示漏洞利用，但仍存在一定的投毒风险。攻击者可能会在 Dockerfile 中添加恶意指令，例如下载并执行恶意脚本，或者在 secret 中添加更复杂的恶意payload，这些payload可能超出当前POC的范围，例如进行端口扫描、反向shell等攻击。在镜像构建过程中执行恶意操作。虽然该POC主要是为了提权，但恶意行为者可能在 `malicious-secret.yaml` 中的 `cp` 脚本中插入额外的代码，以在不知情的情况下感染或损害目标系统，或者将窃取的数据发送到外部服务器。由于该漏洞允许完全控制构建环境，因此理论上投毒的可能性较低，因为利用的初始目标是获得主机访问权。投毒更多是隐蔽的长期行为，而此漏洞倾向于直接利用。

风险评估： 10% 的风险代表着虽然主要的威胁是直接的权限提升，但是也不能完全排除代码中含有潜在恶意或隐蔽功能的可能性，用户在复现时需要仔细审查所有脚本和配置。

**项目地址:** [fatcatresearch/cve-2024-7387](https://github.com/fatcatresearch/cve-2024-7387)

**漏洞详情:** [CVE-2024-7387](https://nvd.nist.gov/vuln/detail/CVE-2024-7387)