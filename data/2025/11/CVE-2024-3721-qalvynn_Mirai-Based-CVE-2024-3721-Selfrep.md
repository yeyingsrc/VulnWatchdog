## CVE-2024-3721-TBK DVR-4104/DVR-4216-OS 命令注入

**漏洞编号:** CVE-2024-3721

**漏洞类型:** OS 命令注入

**影响应用:** TBK DVR-4104/DVR-4216

**危害等级:** 高危，可能导致设备被完全控制

**影响版本:** <= 20240412

**利用条件:** 需要网络访问，可能需要认证（CVE描述中提到 'PR:L'，即需要低权限）。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2024-3721 漏洞存在于TBK DVR-4104和DVR-4216设备中，版本不高于20240412。攻击者通过操纵`/device.rsp?opt=sys&cmd=___S_O_S_T_R_E_A_MAX___`接口的`mdb/mdc`参数，可以实现OS命令注入。

**利用方式：**
1.  攻击者构造包含恶意命令的HTTP请求，目标URL为`/device.rsp?opt=sys&cmd=___S_O_S_T_R_E_A_MAX___`，并将恶意命令注入到`mdb`或`mdc`参数中。
2.  设备接收到请求后，由于未对`mdb/mdc`参数进行充分的过滤，直接将其传递给操作系统执行，从而导致命令注入。
3.  攻击者可以利用该漏洞执行任意系统命令，例如反弹shell、修改设备配置等，从而完全控制设备。

**POC代码分析：**
提供的C代码`/tmp/013dd0f65b893aad351e530c6c5ad5a5/tbk.c` 是一个扫描器，主要功能是随机扫描IP地址，尝试建立TCP连接到80端口，并非直接用于利用 CVE-2024-3721 漏洞的POC。它用于寻找暴露在网络上的TBK DVR设备。

**有效性：**
虽然提供的C代码不是直接的漏洞利用代码，但配合github上漏洞作者提供的exp，用于探测目标可以确定其有效性。

**投毒风险：**
此代码中存在一定的投毒风险，可能性评估为10%。理由如下：
1.  **扫描行为本身：** 扫描大量IP地址可能被用于建立僵尸网络，进行DDoS攻击等恶意活动。
2.  **后门植入的可能性：** 即使当前代码没有明显的后门，作者可以在后续版本中添加恶意代码，例如在成功建立连接后，执行特定的命令或上传敏感信息。
3.  **依赖项风险：** 代码依赖的`../headers/includes.h`, `../headers/rand.h`, `../headers/util.h` 如果这些自定义头文件包含恶意代码，可能会影响扫描器的行为。由于没有给出头文件的具体内容，这部分风险无法完全评估，需要分析相关头文件。
因此，虽然提供的代码主要功能是扫描，但其潜在的恶意用途以及后续被篡改的风险需要引起重视。

**项目地址:** [qalvynn/Mirai-Based-CVE-2024-3721-Selfrep](https://github.com/qalvynn/Mirai-Based-CVE-2024-3721-Selfrep)

**漏洞详情:** [CVE-2024-3721](https://nvd.nist.gov/vuln/detail/CVE-2024-3721)