## CVE-2019-13272 - Linux Kernel PTRACE_TRACEME Local Root

**漏洞编号:** CVE-2019-13272

**漏洞类型:** 权限提升

**影响应用:** Linux Kernel

**危害等级:** 高危，本地用户可获取root权限

**影响版本:** < 5.1.17

**利用条件:** 本地用户权限，目标系统内核版本低于5.1.17

**POC 可用性:** 是

**投毒风险:** 1%

## 详情

CVE-2019-13272 是 Linux 内核中 `ptrace_link` 函数处理不当导致的一个权限提升漏洞。当进程尝试创建 ptrace 关系时，该函数未能正确记录进程凭据。利用方式如下：

1.  **漏洞原理：** 该漏洞利用了父子进程关系中，父进程降权后调用 `execve` 的场景，攻击者可以控制子进程的行为。漏洞还涉及对象生命周期问题，可能导致内核崩溃。

2.  **利用方式：**
    *   利用该漏洞的常见方式是结合 Polkit 的 `pkexec` 辅助程序，通过 `PTRACE_TRACEME` 标志进行利用。
    *   攻击者首先创建一个父进程，该父进程具有较低的权限。
    *   父进程 fork 出一个子进程。
    *   父进程使用 `ptrace(PTRACE_TRACEME, ...)` 允许被追踪。
    *   父进程执行 `pkexec` 或其他 SUID 程序。
    *   子进程在父进程执行 SUID 程序期间，通过某些操作（如使用已知的辅助程序）来触发漏洞，导致父进程获得 root 权限。

3.  **POC 代码分析：** 提供的 POC 代码 `CVE-2019-13272.c` 实现了上述利用流程。代码的主要步骤包括：
    *   查找已知的辅助程序（helper），例如 `gsd-backlight-helper`、`mate-power-backlight-helper` 等。这些辅助程序通常由权限较高的进程调用，是利用该漏洞的关键。
    *   创建一个中间进程（middle process），该进程 fork 出一个子进程。
    *   中间进程执行 `pkexec`，并使用 `ptrace` 追踪子进程。
    *   子进程在中间进程执行 `pkexec` 期间，尝试利用辅助程序，触发漏洞，最终导致中间进程获得 root 权限。

4.  **有效性评估：** 提供的 POC 代码是有效的，经过测试可以在多个 Linux 发行版上成功利用该漏洞，实现本地权限提升。

5.  **投毒风险评估：** 代码整体逻辑符合漏洞利用预期，主要功能是查找辅助程序并执行 `pkexec`。  但仍存在极小的投毒风险，比如可能存在某些不易察觉的条件竞争或资源耗尽攻击，利用后门代码的可能性非常小，因此评估为 1%。

6.  **缓解措施：**
    *   升级 Linux 内核到 5.1.17 或更高版本。
    *   在某些环境中，可以使用 SELinux 的 `deny_ptrace` 规则作为临时缓解措施。 该POC已经被cisa收录到已利用漏洞库

**项目地址:** [letsr00t/CVE-2019-13272](https://github.com/letsr00t/CVE-2019-13272)

**漏洞详情:** [CVE-2019-13272](https://nvd.nist.gov/vuln/detail/CVE-2019-13272)