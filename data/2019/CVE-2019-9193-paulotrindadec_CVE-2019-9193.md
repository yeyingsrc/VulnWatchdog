## CVE-2019-9193 - PostgreSQL Authenticated Remote Code Execution

**漏洞编号:** CVE-2019-9193

**漏洞类型:** 远程代码执行

**影响应用:** PostgreSQL

**危害等级:** 高危，允许认证用户以数据库服务器操作系统的用户身份执行任意代码。

**影响版本:** 9.3 through 11.2（据漏洞库信息，POC测试版本为9.6.1）

**利用条件:** 需要PostgreSQL数据库的有效用户凭证（默认用户 postgres:postgres），且用户具有足够权限（默认安装通常满足）。需要数据库端口开放且网络可达。

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

该漏洞(或者说特性)存在于PostgreSQL的`COPY TO/FROM PROGRAM` 功能中。拥有superuser权限或属于`pg_execute_server_program`组的用户可以通过该功能执行操作系统命令。提供的`exploit.py`脚本通过以下步骤利用该特性：

1.  **连接数据库:** 使用提供的用户名、密码、IP地址和端口连接到目标PostgreSQL数据库。
2.  **创建函数和触发器:**
    *   删除可能存在的旧表`triggeroffsec`，函数`triggeroffsecexeccmd`，表`triggeroffsecsource`，以及触发器`shoottriggeroffsecexeccmd`，以确保利用环境的干净。
    *   创建一个表`triggeroffsec`，用于存储命令执行的结果。
    *   创建一个名为`triggeroffsecexeccmd`的PL/pgSQL函数，该函数使用`COPY triggeroffsec (cmdout) FROM PROGRAM`语句执行指定的操作系统命令。命令来自脚本的`-c`参数。
    *   创建一个表`triggeroffsecsource`，作为触发器的源表。
    *   创建一个触发器`shoottriggeroffsecexeccmd`，该触发器在`triggeroffsecsource`表插入数据后被触发，从而执行`triggeroffsecexeccmd`函数。
3.  **触发命令执行:** 向`triggeroffsecsource`表插入一条数据，触发`shoottriggeroffsecexeccmd`触发器，从而执行`triggeroffsecexeccmd`函数，执行预设的命令。
4.  **获取结果:**  从`triggeroffsec`表中查询命令执行的结果并输出。
5.  **清理:**  脚本虽然尝试删除创建的表和函数，但`DROP FUNCTION ... CASCADE`命令的使用意在处理依赖关系，确保清理干净。

**有效性评估：**

该POC代码有效，因为它直接利用了PostgreSQL的`COPY TO/FROM PROGRAM`功能来执行操作系统命令。  尽管PostgreSQL官方不认为这是一个安全漏洞，但在默认配置下，它允许经过身份验证的用户执行任意代码，因此在安全角度上是高危的。

**投毒风险评估：**

经分析，提供的POC代码中**没有**发现明显的投毒代码。 代码逻辑清晰，主要目的是利用`COPY FROM PROGRAM`功能执行命令，没有发现任何额外的不良行为，例如修改系统文件、安装后门、或者向外部服务器发送数据等。

**利用方式总结：**

该漏洞利用方式涉及在PostgreSQL数据库中创建自定义函数和触发器，从而在数据库操作时执行操作系统命令。攻击者需要有效的数据库凭据，然后构造特定的SQL语句来利用`COPY FROM PROGRAM`功能执行任意命令。这种利用方式相对隐蔽，因为命令执行发生在数据库服务器的操作系统层面，不容易被传统的Web应用防火墙或入侵检测系统发现。

**项目地址:** [paulotrindadec/CVE-2019-9193](https://github.com/paulotrindadec/CVE-2019-9193)

**漏洞详情:** [CVE-2019-9193](https://nvd.nist.gov/vuln/detail/CVE-2019-9193)