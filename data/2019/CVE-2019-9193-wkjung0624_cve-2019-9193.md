## CVE-2019-9193 - PostgreSQL 任意代码执行

**漏洞编号:** CVE-2019-9193

**漏洞类型:** 任意代码执行

**影响应用:** PostgreSQL

**危害等级:** 高危，可导致服务器被完全控制

**影响版本:** 9.3 <= 版本 <= 11.2

**利用条件:** 需要具有superuser权限或属于pg_execute_server_program组的用户权限

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2019-9193 允许拥有superuser权限或属于`pg_execute_server_program`组的用户通过 `COPY TO/FROM PROGRAM` 功能执行任意代码。提供的POC代码 `portgres_rce.py` 利用了这一漏洞，通过创建一个反向shell连接到攻击者控制的机器。该脚本首先建立一个监听特定端口的TCP服务器，然后通过PostgreSQL的 `COPY FROM PROGRAM` 命令执行一段Perl代码，该Perl代码会尝试连接到攻击者机器的监听端口，从而建立反向shell。 

**有效性分析：**
POC代码利用了PostgreSQL的 `COPY FROM PROGRAM` 功能，该功能允许执行操作系统命令。只要满足superuser或pg_execute_server_program权限要求，POC代码就能有效执行任意命令，从而验证漏洞的有效性。

**投毒风险分析：**
该代码的目的是利用漏洞，创建一个反向shell连接，以便控制受害者系统。该脚本从功能上来说,符合漏洞验证的需求,没有发现植入恶意代码的痕迹，投毒风险为0%。 

**利用方式：**
1.  攻击者需要拥有 PostgreSQL 数据库的superuser权限或者属于`pg_execute_server_program`用户组.
2.  攻击者运行提供的`portgres_rce.py`脚本，输入PostgreSQL服务器的IP地址和端口，以及攻击者监听的IP地址和端口。
3.  脚本通过`psycopg2`库连接到PostgreSQL数据库。
4.  脚本构造一系列SQL命令，包括创建临时表`RCE_BASE`，然后使用`COPY RCE_BASE FROM PROGRAM`执行Perl反向shell代码。Perl代码会连接到攻击者指定的IP地址和端口。
5.  攻击者机器上运行的TCP服务器接受连接，从而建立反向shell。攻击者可以输入命令并执行。
6.  最后删除临时表 `RCE_BASE`。


**项目地址:** [wkjung0624/cve-2019-9193](https://github.com/wkjung0624/cve-2019-9193)

**漏洞详情:** [CVE-2019-9193](https://nvd.nist.gov/vuln/detail/CVE-2019-9193)