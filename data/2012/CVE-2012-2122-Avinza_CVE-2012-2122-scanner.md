## CVE-2012-2122-MySQL/MariaDB身份验证绕过

**漏洞编号:** CVE-2012-2122

**漏洞类型:** 身份验证绕过

**影响应用:** MySQL/MariaDB

**危害等级:** 高危，可能导致未授权访问数据库

**影响版本:** MySQL 5.1.x(<5.1.63), 5.5.x(<5.5.24), 5.6.x(<5.6.6); MariaDB 5.1.x(<5.1.62), 5.2.x(<5.2.12), 5.3.x(<5.3.6), 5.5.x(<5.5.23)

**利用条件:** 目标MySQL/MariaDB服务器存在漏洞，且存在特定的memcmp实现。攻击者需要能够建立到目标服务器3306端口的连接。

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

该漏洞源于MySQL/MariaDB在`sql/password.c`中的身份验证处理逻辑。在某些环境中，当`memcmp`函数的实现存在问题时，攻击者可以通过重复使用错误的密码进行身份验证，最终绕过身份验证。漏洞利用代码`scan.php`通过以下步骤利用此漏洞：

1.  **扫描目标IP范围：** 脚本首先接收一个CIDR格式的IP地址范围作为输入，并生成该范围内的所有IP地址。
2.  **尝试连接：**  对于每个IP地址，脚本尝试通过3306端口建立TCP连接。
3.  **暴力破解：** 如果连接成功，脚本会循环尝试使用错误的密码（这里使用了`uniqid(mt_rand())`生成随机密码）连接到MySQL服务器。
4.  **验证漏洞：**  如果多次尝试后，`mysql_connect`函数返回成功，则认为目标服务器存在漏洞。
5.  **数据泄露：**  如果确认漏洞存在，脚本会尝试执行SQL查询`SELECT user,password from mysql.user`来提取数据库用户的用户名和密码哈希。

**有效性：**

该POC代码在满足漏洞利用条件的情况下有效。漏洞利用依赖于特定的`memcmp`实现，这意味着并非所有受影响的版本都容易被利用。脚本通过暴力尝试连接来触发漏洞。

**投毒风险：**

此仓库中存在一定投毒风险，约10%。虽然主要功能是利用CVE-2012-2122漏洞，但是如果攻击者修改脚本，例如添加恶意代码到SQL查询部分或者收集扫描到的服务器信息并发送到外部服务器，就可能造成额外的安全风险。脚本中打印了扫描结果, 如果被恶意人员修改, 添加上恶意代码, 则存在投毒的风险。

**利用方式：**

1.  **确定目标IP范围：**  攻击者需要确定要扫描的IP地址范围。
2.  **执行扫描脚本：**  运行`scan.php`脚本，并提供目标IP地址范围作为参数。
3.  **等待结果：**  脚本将扫描指定范围内的IP地址，并尝试利用CVE-2012-2122漏洞绕过身份验证。
4.  **提取数据：**  如果漏洞利用成功，脚本将尝试提取数据库中的用户名和密码哈希。

需要注意的是，成功利用此漏洞取决于目标服务器上`memcmp`函数的具体实现，以及脚本的运气，多次尝试才能提高成功率。

**项目地址:** [Avinza/CVE-2012-2122-scanner](https://github.com/Avinza/CVE-2012-2122-scanner)

**漏洞详情:** [CVE-2012-2122](https://nvd.nist.gov/vuln/detail/CVE-2012-2122)