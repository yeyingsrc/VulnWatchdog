## CVE-2020-9922 - macOS Mail 任意文件写入

**漏洞编号:** CVE-2020-9922

**漏洞类型:** 任意文件写入

**影响应用:** macOS Mail

**危害等级:** 高危，可能导致任意代码执行

**影响版本:** < 10.15

**利用条件:** 处理恶意构造的邮件

**POC 可用性:** 是

**投毒风险:** 10%

## 详情

CVE-2020-9922 存在于 macOS Mail 中，允许攻击者通过处理恶意构造的邮件来写入任意文件。漏洞原因为逻辑问题，通过改进状态管理解决。提供的 POC 代码尝试通过 swizzle `MCMimePart` 的 `isAutoArchivePart` 方法来避免某些安全检查。如果利用成功，攻击者可以写入任意文件，进一步可导致任意代码执行。

**有效性：** 代码针对的是 macOS Mail 应用的早期版本，通过方法替换（swizzling）的方式修改其行为。该方法可能有效，但依赖于 Mail.app 内部实现细节，可能因系统版本而异。作者明确指出在 Mavericks (10.9) 上测试，并且没有在其他系统上保证其有效性。

**投毒风险：** 仓库中包含一个 README，解释了漏洞和 PoC 的目的，以及一些源代码文件，例如 `main.m` 和 `ZKSwizzle.h`。`ZKSwizzle.h` 提供了一种方法来动态地修改现有类的行为。`main.m` 文件是插件的主要入口点，并尝试通过 `ZKSwizzle` 修改 `MCMimePart` 类的 `isAutoArchivePart` 方法。 `MailSecFix/Info.plist` 是邮件插件的配置文件。

 投毒风险较低，大概在10%左右。虽然代码修改了 Mail.app 的行为，但没有明显的恶意代码，例如执行 shell 命令或上传数据。主要风险在于代码的潜在不稳定性和不可预测的行为，这可能导致 Mail.app 崩溃或数据损坏。作者似乎更加专注于漏洞修复和概念验证，而不是进行恶意活动。

**利用方式：**
1.  **构造恶意邮件：**  攻击者需要创建一个特殊的邮件，能够触发漏洞的条件，即`MCMimePart`对象。
2.  **安装邮件插件：**  编译提供的源代码，生成一个 Mail.app 插件 (bundle)。用户需要手动将此插件安装到 Mail.app 的插件目录中。
3.  **触发漏洞：**  当 Mail.app 处理构造的恶意邮件时，插件将替换 `MCMimePart` 类的 `isAutoArchivePart` 方法。
4.  **任意文件写入：**  由于修改了 `isAutoArchivePart` 的返回值，某些安全检查被绕过，导致 Mail.app 允许写入任意文件。

**项目地址:** [Wowfunhappy/Fix-Apple-Mail-CVE-2020-9922](https://github.com/Wowfunhappy/Fix-Apple-Mail-CVE-2020-9922)

**漏洞详情:** [CVE-2020-9922](https://nvd.nist.gov/vuln/detail/CVE-2020-9922)