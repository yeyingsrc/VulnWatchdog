## CVE-2022-40684 - Fortinet Authentication Bypass

**漏洞编号:** CVE-2022-40684

**漏洞类型:** 身份验证绕过

**影响应用:** FortiOS, FortiProxy, FortiSwitchManager

**危害等级:** 严重，允许未经身份验证的攻击者执行管理操作

**影响版本:** FortiOS 7.2.0-7.2.1, 7.0.0-7.0.6; FortiProxy 7.2.0, 7.0.0-7.0.6; FortiSwitchManager 7.2.0, 7.0.0

**利用条件:** 目标设备运行受影响版本的FortiOS、FortiProxy或FortiSwitchManager，并且可以通过HTTP/HTTPS访问管理界面。

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2022-40684 允许未经身份验证的攻击者通过构造特制的HTTP或HTTPS请求，绕过身份验证并在受影响的 Fortinet 设备上执行管理操作。提供的 POC 代码通过向 `/api/v2/cmdb/system/admin/{username}` 发送 PUT 请求，并添加攻击者的 SSH 公钥到指定的管理员账户（默认为 admin）来利用此漏洞。 

**有效性：**

提供的 POC 代码看起来有效。它利用了身份验证绕过漏洞，通过构造包含 `Forwarded` 头的 HTTP 请求，将 SSH 公钥添加到指定用户，从而实现未经授权的访问。漏洞库信息中 CVSS 评分为 9.8（严重），且 exploitCodeMaturity 为 FUNCTIONAL，表明该漏洞的利用方式成熟且危害极大。

**投毒风险：**

分析提供的 POC 代码，没有发现明显的恶意代码或后门。该脚本的主要功能是利用漏洞添加 SSH 密钥。 `cve-2022-40684.py`脚本读取指定的公钥文件并将其添加到目标系统的管理员账户。`ip-pack.sh` 只是一个用于批量利用的简单脚本。`README.md` 文件描述了漏洞和利用方法。

**利用方式：**

1.  攻击者使用 `cve-2022-40684.py` 脚本或 `ip-pack.sh` 脚本，指定目标设备的 IP 地址、用户名（默认为 admin）和 SSH 公钥文件。
2.  脚本构造包含 `Forwarded` 头的 HTTP PUT 请求，并将 SSH 公钥添加到目标设备的管理员账户。
3.  通过 SSH 使用添加的公钥登录目标设备，从而获得管理员权限。

总而言之，提供的代码是 CVE-2022-40684 漏洞的有效 POC，允许攻击者通过身份验证绕过漏洞添加 SSH 密钥并获得未经授权的访问。没有检测到明显的投毒代码。

**项目地址:** [iveresk/CVE-2022-40684](https://github.com/iveresk/CVE-2022-40684)

**漏洞详情:** [CVE-2022-40684](https://nvd.nist.gov/vuln/detail/CVE-2022-40684)