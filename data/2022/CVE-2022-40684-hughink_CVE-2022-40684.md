## CVE-2022-40684 - Fortinet Authentication Bypass

**漏洞编号:** CVE-2022-40684

**漏洞类型:** Authentication Bypass

**影响应用:** FortiOS, FortiProxy, FortiSwitchManager

**危害等级:** 高危，允许未授权的攻击者执行管理操作

**影响版本:** FortiOS 7.2.0 - 7.2.1, 7.0.0 - 7.0.6; FortiProxy 7.2.0, 7.0.0 - 7.0.6; FortiSwitchManager 7.2.0, 7.0.0

**利用条件:** 目标系统开启Web管理界面且版本在受影响范围内

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2022-40684 漏洞存在于 Fortinet FortiOS, FortiProxy 和 FortiSwitchManager 的Web管理界面。攻击者可以通过发送特制的HTTP或HTTPS请求，利用备用路径绕过身份验证，从而执行未经授权的管理操作。

**有效性：** 提供的POC代码有效。第一个GET请求用于获取管理员信息，验证漏洞是否存在。第二个PUT请求展示了如何通过构造包含ssh公钥的payload修改管理员信息，从而实现远程访问。

**投毒风险：** 仓库中存在投毒代码的可能性较低，约为5%。分析理由如下：
  * Readme文件主要包含漏洞描述、影响版本、资产确定方法、PoC和利用方法。
  * 提供的PoC利用的是已知漏洞，利用的payload也是常规的添加SSH公钥的方式，暂未发现后门代码，但仍需人工审计代码。

**利用方式：**
1.  **确定目标资产：** 通过title标签确定目标是否为受影响的 FortiProxy 或 FortiGate。
2.  **发送POC请求：**  使用GET请求 `/api/v2/cmdb/system/admin`，并设置`Host`, `Forwarded`, `X-Forwarded-Vdom`等header头，尝试绕过身份验证以获取管理员信息。
3.  **利用漏洞：**  如果POC成功，使用PUT请求`/api/v2/cmdb/system/admin/用户名`，并设置`Host`, `Forwarded`等header头。在请求体中，使用JSON格式设置`ssh-public-key1`字段为攻击者的公钥。这样，攻击者就可以通过SSH密钥登录到目标系统。

**总结：** 漏洞利用过程相对简单，但需要目标系统存在漏洞，且需要网络可达。成功利用漏洞后，攻击者可以获得目标系统的完全控制权。

**项目地址:** [hughink/CVE-2022-40684](https://github.com/hughink/CVE-2022-40684)

**漏洞详情:** [CVE-2022-40684](https://nvd.nist.gov/vuln/detail/CVE-2022-40684)