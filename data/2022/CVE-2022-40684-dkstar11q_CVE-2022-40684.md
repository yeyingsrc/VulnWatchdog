## CVE-2022-40684-FortiOS/FortiProxy/FortiSwitchManager身份验证绕过

**漏洞编号:** CVE-2022-40684

**漏洞类型:** 身份验证绕过

**影响应用:** FortiOS/FortiProxy/FortiSwitchManager

**危害等级:** 高危，可能导致未授权访问和控制

**影响版本:** FortiOS 7.2.0-7.2.1, 7.0.0-7.0.6; FortiProxy 7.2.0, 7.0.0-7.0.6; FortiSwitchManager 7.2.0, 7.0.0

**利用条件:** 需要网络访问目标设备的管理界面

**POC 可用性:** 是

**投毒风险:** 0%

## 详情

CVE-2022-40684 存在于 FortiOS、FortiProxy 和 FortiSwitchManager 中。该漏洞允许未经身份验证的攻击者通过特制的 HTTP 或 HTTPS 请求绕过身份验证，从而在管理界面上执行操作。

**有效性：**
提供的 Python 脚本 `CVE-2022-40684.py` 实现了对该漏洞的利用。脚本通过设置 `Forwarded` 头部来绕过身份验证，然后可以执行诸如添加 SSH 密钥以控制设备等操作。漏洞库信息中 `metrics`部分CVSS评分表明该漏洞是高危且具有可利用性。CISA将其列入已知被利用漏洞目录，更证明了该漏洞的有效性。

**投毒风险：**
对提供的代码进行分析，该脚本的主要功能是利用 CVE-2022-40684 漏洞，没有发现任何明显的恶意代码或后门。代码的功能是检查目标是否容易受到攻击，以及通过在目标设备上添加SSH公钥来利用该漏洞。LICENSE文件是MIT许可，较为通用，未发现异常。

**利用方式：**
1.  **检查漏洞：** 使用 `-c` 或 `--check` 参数来检查目标设备是否存在漏洞。该脚本会发送一个特制的 GET 请求到 `/api/v2/cmdb/system/admin` 端点，如果状态码为 200，则表明存在漏洞。还会尝试获取 LDAP 配置信息，以便进行进一步的攻击。
2.  **添加 SSH 密钥：** 使用 `-a` 或 `--attack` 参数以及 `-k` 或 `--key-file` 参数，指定 SSH 公钥文件路径，将指定的 SSH 公钥添加到目标设备的 `admin` 用户的 authorized_keys 文件中。利用该方式，攻击者可以通过 SSH 密钥登录到目标设备，从而完全控制该设备。

总而言之，该漏洞利用代码有效，且未发现明显的投毒风险，风险系数评估为 0%。利用方式主要是通过构造特殊的HTTP头部进行身份验证绕过，然后进行敏感信息的读取或进一步的利用。

**项目地址:** [dkstar11q/CVE-2022-40684](https://github.com/dkstar11q/CVE-2022-40684)

**漏洞详情:** [CVE-2022-40684](https://nvd.nist.gov/vuln/detail/CVE-2022-40684)