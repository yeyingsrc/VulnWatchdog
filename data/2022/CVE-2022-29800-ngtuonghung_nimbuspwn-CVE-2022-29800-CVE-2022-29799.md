## CVE-2022-29800 - networkd-dispatcher TOCTOU 竞争条件漏洞

**漏洞编号:** CVE-2022-29800

**漏洞类型:** TOCTOU 竞争条件

**影响应用:** networkd-dispatcher

**危害等级:** 中危，可能导致权限提升

**影响版本:** 未知

**利用条件:** 需要本地访问权限和对networkd-dispatcher脚本目录的写入权限（可能通过其他漏洞获得）

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2022-29800 是 networkd-dispatcher 中的一个 TOCTOU (time-of-check time-of-use) 竞争条件漏洞。漏洞存在于脚本发现和执行之间的时间窗口内。攻击者可以利用此漏洞替换 networkd-dispatcher 认为属于 root 拥有的脚本，从而实现权限提升。

**有效性：**
根据漏洞库信息和微软的博客（https://www.microsoft.com/security/blog/2022/04/26/microsoft-finds-new-elevation-of-privilege-linux-vulnerability-nimbuspwn/），该漏洞是真实存在的，并且存在利用的可能性。给定的POC代码仓库名“nimbuspwn-CVE-2022-29800-CVE-2022-29799”表明这是一个针对 Nimbuspwn 漏洞集的一部分，其中 CVE-2022-29800 就是其中一个。虽然只给出了 README.md 的内容，但是仓库本身的存在就说明有POC代码。

**投毒风险：**
给出的代码片段只是 README.md，无法直接判断是否存在投毒代码。但考虑到以下几点：
1.  漏洞利用本身就涉及到替换文件，具有一定的恶意性质。
2.  此漏洞属于权限提升漏洞，如果被恶意利用，可能导致系统被完全控制。
3.  通常情况下，公开的POC代码的编写者可能会利用其来获取利益。

虽然只提供了README.md，但是实际下载整个仓库进行分析时，仍然存在投毒的可能性。这里的投毒风险是指作者可能在poc验证成功后在后门代码中安插恶意代码。这里的投毒风险评估比较低，因为这个poc主要是一个竞争条件漏洞的利用，直接修改或插入后门代码的可能性较低。

**利用方式：**
1.  攻击者需要在 `/etc/networkd-dispatcher/routable.d/` 或 `/etc/networkd-dispatcher/carrier.d/` 目录下创建或修改脚本 (可能需要先获得写入权限)。
2.  攻击者通过竞争条件，在 networkd-dispatcher 检查脚本所有权之后，但在实际执行之前，将脚本替换为恶意的脚本。
3.  当网络状态改变时，networkd-dispatcher 会触发脚本执行，从而执行攻击者替换的恶意脚本，并以 root 权限运行，最终导致权限提升。


**项目地址:** [ngtuonghung/nimbuspwn-CVE-2022-29800-CVE-2022-29799](https://github.com/ngtuonghung/nimbuspwn-CVE-2022-29800-CVE-2022-29799)

**漏洞详情:** [CVE-2022-29800](https://nvd.nist.gov/vuln/detail/CVE-2022-29800)