## CVE-2022-40684-Fortinet-Authentication Bypass

**漏洞编号:** CVE-2022-40684

**漏洞类型:** 身份验证绕过

**影响应用:** FortiOS, FortiProxy, FortiSwitchManager

**危害等级:** 高危，可能导致未经授权的访问和控制

**影响版本:** FortiOS 7.2.0 through 7.2.1 and 7.0.0 through 7.0.6, FortiProxy version 7.2.0 and version 7.0.0 through 7.0.6 and FortiSwitchManager version 7.2.0 and 7.0.0

**利用条件:** 目标系统存在漏洞版本，攻击者能够发起HTTP/HTTPS请求

**POC 可用性:** 是

**投毒风险:** 5%

## 详情

CVE-2022-40684 是一个 Fortinet 产品中的身份验证绕过漏洞，通过构造特殊的 HTTP 或 HTTPS 请求，未经验证的攻击者可以在管理界面上执行操作。

**有效性：**
根据提供的漏洞库信息和漏洞利用代码，该漏洞的 POC 代码是有效的。CVE 数据表明该漏洞的 `exploitCodeMaturity` 为 `FUNCTIONAL`，并且已经被 CISA 加入到已知被利用的漏洞目录中，表明该漏洞已在野外被积极利用。

**投毒风险：**
对提供的 Python 脚本 `exploit.py` 进行分析，它主要实现了以下功能：
1.  向目标发送带有特定 Header 的 HTTP GET 请求，绕过身份验证。
2.  如果状态码为 200，则解析返回的 JSON 数据，提取管理员用户名和访问级别。
3.  提取设备序列号和版本信息
4.  尝试读取 LDAP 配置信息，提取 LDAP 服务器地址、绑定 DN、用户名等敏感信息。

未发现明显的恶意代码或后门。脚本的目的是利用漏洞读取敏感信息。其它文件都是一些说明文档和更新日志。
因此，投毒风险较低，约为 5%。主要风险在于使用者在使用未经充分审计的代码时，可能引入安全风险。

**利用方式：**
该漏洞的利用方式主要通过发送特制的 HTTP 请求头来绕过身份验证。攻击者通过设置 `forwarded` 和 `x-forwarded-vdom` 请求头，欺骗 Fortinet 设备，从而可以访问 `/api/v2/cmdb/system/admin` 和 `/api/v2/cmdb/user/ldap` 等管理接口，读取管理员信息和 LDAP 配置。具体步骤如下：

1.  构造包含以下 header 的 HTTP GET 请求：
    *   `User-Agent: Node.js`
    *   `accept-encoding: gzip, deflate`
    *   `Host: <目标IP地址或域名>`
    *   `forwarded: by="[127.0.0.1]:1337";for="[127.0.0.1]:1337";proto=http;host=`
    *   `x-forwarded-vdom: root`
2.  发送请求到 `/api/v2/cmdb/system/admin` 接口，获取管理员信息。
3.  发送请求到 `/api/v2/cmdb/user/ldap` 接口，获取 LDAP 配置信息。

**项目地址:** [ccordeiro/CVE-2022-40684](https://github.com/ccordeiro/CVE-2022-40684)

**漏洞详情:** [CVE-2022-40684](https://nvd.nist.gov/vuln/detail/CVE-2022-40684)